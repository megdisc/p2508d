<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>生産活動分析 - p2508d</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .filter-form-inline { display: flex; align-items: flex-end; gap: 1.5rem; flex-wrap: wrap; }
        .filter-form-inline .form-group { margin-bottom: 0; flex-grow: 1; }
        .filter-form-inline .button-secondary { margin-bottom: 0; height: calc(1.5em + 1rem + 2px); flex-shrink: 0; }
        .chart-placeholder { text-align: center; padding: 4rem 1rem; background-color: var(--color-hover-bg); border: 1px dashed var(--color-border); border-radius: var(--border-radius); color: var(--color-text-secondary); font-size: var(--font-size-sm); }
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem; }
        .kpi-card {
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            padding: 1rem 1.5rem;
            background-color: var(--color-surface);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        .kpi-card h4 { font-size: var(--font-size-sm); font-weight: 500; color: var(--color-text-secondary); margin-bottom: 0.5rem; }
        .kpi-card p { font-size: 1.5rem; font-weight: bold; color: var(--color-primary); margin-bottom: 0.5rem; }
        .kpi-card .subtext { font-size: var(--font-size-xs); font-weight: normal; color: var(--color-text-secondary); }
        .col-number { text-align: right !important; }

        .period-selector-section .section-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        .period-unit-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .period-unit-button {
            padding: 0.5rem 1rem;
            font-size: var(--font-size-sm);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            background-color: var(--color-surface);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .period-unit-button:hover {
            background-color: var(--color-hover-bg);
        }
        .period-unit-button.active {
            background-color: var(--color-primary);
            color: var(--color-button-text);
            border-color: var(--color-primary);
            font-weight: 500;
        }
        .period-main-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            width: 100%;
            max-width: 500px;
        }
        .period-navigation-buttons .button {
            padding: 0.75rem;
            font-size: 1.2rem;
            line-height: 1;
        }
        .period-display {
            text-align: center;
            flex-grow: 1;
        }
        .period-display-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
        }
        .period-display-main {
            font-size: 2.2rem;
            font-weight: bold;
            color: var(--color-primary);
            line-height: 1.1;
        }
        .period-display-sub {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-top: 0.25rem;
        }
        .period-detail-selectors {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .period-detail-selectors .form-control {
            width: auto;
            padding: 0.5rem 0.75rem;
        }
        .period-detail-selectors label {
            margin-bottom: 0;
            font-weight: normal;
            font-size: var(--font-size-sm);
        }
         .section-header-controls {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             margin-left: auto;
         }
    </style>
</head>
<body>
    <div class="mockup-container">
        <header class="header">
            <div> <h1 class="header-logo"><a href="dashboard.html">p2508d</a></h1> </div>
            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="dashboard.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="daily_records.html" class="nav-link">日々の記録</a></li>
                    <li><a href="members_menu.html" class="nav-link">利用者支援</a></li>
                    <li><a href="production_menu.html" class="nav-link">生産活動</a></li>
                    <li><a href="staff_menu.html" class="nav-link">施設と職員</a></li>
                    <li><a href="accounting_menu.html" class="nav-link">会計</a></li>
                    <li><a href="claims.html" class="nav-link">国保連請求</a></li>
                    <li><a href="analytics_menu.html" class="nav-link active">データ分析</a></li>
                    <li><a href="settings.html" class="nav-link">設定</a></li>
                    <li><a href="my_page.html" class="nav-link">マイページ</a></li>
                </ul>
                <div class="nav-logout-section"> <a href="index.html" class="nav-link">ログアウト</a> </div>
            </nav>
        </header>

        <main class="mockup-main">
            <div id="analytics-production" class="mockup-page active">
                <div class="list-page-header">
                    <h1 class="page-title">生産活動分析</h1>
                     <div>
                        <a href="analytics_menu.html" class="button button-secondary" style="margin-right: 0.5rem;">分析メニューへ</a>
                        <button class="button button-secondary" onclick="alert('表示項目カスタマイズ画面（未実装）')">表示項目設定</button>
                    </div>
                </div>

                 <div class="section period-selector-section" style="margin-bottom: 1.5rem;">
                    <div class="section-content">
                        <div class="period-unit-buttons">
                            <button class="period-unit-button" data-unit="monthly">月次</button>
                            <button class="period-unit-button active" data-unit="yearly">年次</button>
                            <button class="period-unit-button" data-unit="all">全期間</button>
                        </div>
                        <div class="period-main-selector">
                            <div class="period-navigation-buttons">
                                <button class="button button-secondary period-prev-button">‹</button>
                            </div>
                            <div class="period-display">
                                <p class="period-display-label">事業年度</p>
                                <p class="period-display-main" id="production-period-display-main">2025年度</p>
                                <p class="period-display-sub" id="production-period-display-sub">2025年4月1日～2026年3月31日</p>
                            </div>
                            <div class="period-navigation-buttons">
                                <button class="button button-secondary period-next-button">›</button>
                            </div>
                        </div>
                        <div class="period-detail-selectors" id="production-period-details">
                            <label for="production-year-select">年度:</label>
                            <select id="production-year-select" class="form-control period-year-select">
                                <option value="2025" selected>2025年度</option>
                                <option value="2024">2024年度</option>
                                <option value="2023">2023年度</option>
                            </select>
                            <label for="production-month-select" class="period-month-label" style="display: none; margin-left: 1rem;">月:</label>
                            <select id="production-month-select" class="form-control period-month-select" style="display: none;">
                                <option value="4">4月</option> <option value="5">5月</option> <option value="6">6月</option>
                                <option value="7">7月</option> <option value="8">8月</option> <option value="9">9月</option>
                                <option value="10" selected>10月</option> <option value="11">11月</option> <option value="12">12月</option>
                                <option value="1">1月</option> <option value="2">2月</option> <option value="3">3月</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="sub-nav">
                    <ul id="production-subnav">
                        <li><a href="#" class="sub-nav-item active" data-tab="tab-production-overview">概要・KPI</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-production-transition">生産活動収支</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-production-expenses">就労支援事業費訳</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-production-reserve">積立金状況</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-production-project">案件別状況</a></li>
                    </ul>
                </div>

                 <div class="tab-content-wrapper">
                    <div id="tab-production-overview" class="tab-content active">
                         <div class="section">
                            <h2 class="section-title">主要KPI</h2>
                            <div class="kpi-grid">
                                <div class="kpi-card"> <h4>就労支援事業収益</h4> <p>3,500,000 <span class="subtext">円</span></p> </div>
                                <div class="kpi-card"> <h4>就労支援事業費</h4> <p>1,450,000 <span class="subtext">円</span></p> </div>
                                <div class="kpi-card"> <h4>就労支援事業活動増減差額</h4> <p>2,050,000 <span class="subtext">円</span></p> </div>
                                <div class="kpi-card"> <h4>工賃変動積立金 残高</h4> <p>1,250,000 <span class="subtext">円</span></p> </div>
                            </div>
                        </div>
                    </div>
                     <div id="tab-production-transition" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">収支関連KPI</h2>
                            <div class="kpi-grid">
                                <div class="kpi-card"> <h4>就労支援事業収益</h4> <p>3,500,000 <span class="subtext">円</span></p> </div>
                                <div class="kpi-card"> <h4>就労支援事業費</h4> <p>1,450,000 <span class="subtext">円</span></p> </div>
                                <div class="kpi-card"> <h4>就労支援事業活動増減差額</h4> <p>2,050,000 <span class="subtext">円</span></p> </div>
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title-in-header">生産活動収支推移グラフ</h2>
                                <div class="section-header-controls">
                                     <button class="button button-secondary" onclick="alert('CSVダウンロード（未実装）')">CSV</button>
                                </div>
                            </div>
                            <div class="section-content"> <div class="chart-placeholder">（就労支援事業収益・事業費・増減差額の月次推移を示すグラフ）</div> </div>
                        </div>
                        <div class="section">
                            <div class="section-header">
                                 <h2 class="section-title-in-header">生産活動収支推移 (一覧表)</h2>
                                 <div class="section-header-controls">
                                      <button class="button button-secondary" onclick="alert('CSVダウンロード（未実装）')">CSV</button>
                                 </div>
                            </div>
                           <div class="table-wrapper">
                               <table class="table" id="production-monthly-detail-table-main">
                                   <thead> <tr> <th>月</th> <th class="col-number">就労支援事業収益(円)</th> <th class="col-number">就労支援事業費(円)</th> <th class="col-number">就労支援事業活動増減差額(円)</th> </tr> </thead>
                                   <tbody id="production-monthly-tbody-detail-main">
                                       <tr> <td>4月</td> <td class="col-number">300,000</td> <td class="col-number">120,000</td> <td class="col-number">180,000</td> </tr>
                                       <tr> <td>5月</td> <td class="col-number">320,000</td> <td class="col-number">130,000</td> <td class="col-number">190,000</td> </tr>
                                       <tr> <td>...</td> <td class="col-number">...</td> <td class="col-number">...</td> <td class="col-number">...</td> </tr>
                                       <tr style="font-weight: bold; background-color: var(--color-hover-bg);"> <td>合計</td> <td class="col-number">3,500,000</td> <td class="col-number">1,450,000</td> <td class="col-number">2,050,000</td> </tr>
                                   </tbody>
                               </table>
                           </div>
                       </div>
                    </div>
                    <div id="tab-production-expenses" class="tab-content">
                        <div class="section">
                            <h2 class="section-title">費用内訳KPI</h2>
                            <div class="kpi-grid">
                                <div class="kpi-card"> <h4>利用者工賃</h4> <p>400,000 <span class="subtext">円</span></p> </div>
                                <div class="kpi-card"> <h4>材料費</h4> <p>800,000 <span class="subtext">円</span></p> </div>
                                <div class="kpi-card"> <h4>外注加工費</h4> <p>100,000 <span class="subtext">円</span></p> </div>
                                <div class="kpi-card"> <h4>その他経費</h4> <p>150,000 <span class="subtext">円</span></p> </div>
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title-in-header">費用内訳構成グラフ</h2>
                                <div class="section-header-controls">
                                     <button class="button button-secondary" onclick="alert('CSVダウンロード（未実装）')">CSV</button>
                                </div>
                            </div>
                            <div class="section-content">
                                <div class="chart-placeholder">（工賃・材料費・外注費・その他経費の構成比を示す円グラフまたは積み上げ棒グラフ）</div>
                            </div>
                        </div>
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title-in-header">費用内訳推移 (一覧表)</h2>
                                <div class="section-header-controls">
                                     <button class="button button-secondary" onclick="alert('CSVダウンロード（未実装）')">CSV</button>
                                </div>
                           </div>
                           <div class="table-wrapper">
                               <table class="table" id="production-expenses-monthly-detail-table">
                                   <thead>
                                       <tr>
                                           <th>月</th>
                                           <th class="col-number">利用者工賃(円)</th>
                                           <th class="col-number">材料費(円)</th>
                                           <th class="col-number">外注加工費(円)</th>
                                           <th class="col-number">その他経費(円)</th>
                                           <th class="col-number">就労支援事業費（円）</th>
                                       </tr>
                                   </thead>
                                   <tbody id="production-expenses-monthly-tbody-detail">
                                       <tr> <td>4月</td> <td class="col-number">40,500</td> <td class="col-number">60,000</td> <td class="col-number">10,000</td> <td class="col-number">9,500</td> <td class="col-number">120,000</td> </tr>
                                       <tr> <td>5月</td> <td class="col-number">42,200</td> <td class="col-number">65,000</td> <td class="col-number">10,000</td> <td class="col-number">12,800</td> <td class="col-number">130,000</td> </tr>
                                       <tr> <td>...</td> <td class="col-number">...</td> <td class="col-number">...</td> <td class="col-number">...</td> <td class="col-number">...</td> <td class="col-number">...</td> </tr>
                                       <tr style="font-weight: bold; background-color: var(--color-hover-bg);"> <td>合計</td> <td class="col-number">400,000</td> <td class="col-number">800,000</td> <td class="col-number">100,000</td> <td class="col-number">150,000</td> <td class="col-number">1,450,000</td> </tr>
                                   </tbody>
                               </table>
                           </div>
                       </div>
                    </div>
                     <div id="tab-production-reserve" class="tab-content">
                        <div class="section">
                           <h2 class="section-title">積立金残高</h2>
                           <div class="kpi-grid">
                               <div class="kpi-card"> <h4>工賃変動積立金 残高</h4> <p>1,250,000 <span class="subtext">円</span></p> </div>
                               <div class="kpi-card"> <h4>設備等整備積立金 残高</h4> <p>800,000 <span class="subtext">円</span></p> </div>
                           </div>
                       </div>

                       <div class="section">
                           <div class="section-header">
                               <h2 class="section-title-in-header">積立金残高推移グラフ</h2>
                               <div class="section-header-controls">
                                   <button class="button button-secondary" onclick="alert('CSVダウンロード（未実装）')">CSV</button>
                               </div>
                           </div>
                           <div class="section-content">
                               <div class="chart-placeholder">（積立金合計残高の月次推移を示すグラフ）</div>
                           </div>
                       </div>
                       <div class="section">
                           <div class="section-header">
                               <h2 class="section-title-in-header">積立金増減明細 (一覧表)</h2>
                               <div class="section-header-controls">
                                    <button class="button button-secondary" onclick="alert('CSVダウンロード（未実装）')">CSV</button>
                               </div>
                           </div>
                           <div class="table-wrapper">
                               <table class="table" id="reserve-fund-monthly-detail-table-prod">
                                   <thead>
                                       <tr>
                                           <th>月</th>
                                           <th class="col-number">工賃変動 積立額(円)</th>
                                           <th class="col-number">工賃変動 取崩額(円)</th>
                                           <th class="col-number">設備整備 積立額(円)</th>
                                           <th class="col-number">設備整備 取崩額(円)</th>
                                           <th class="col-number">期末残高(円)</th>
                                       </tr>
                                   </thead>
                                   <tbody>
                                       <tr> <td>4月</td> <td class="col-number">50,000</td> <td class="col-number">0</td> <td class="col-number">20,000</td> <td class="col-number">0</td> <td class="col-number">1,870,000</td> </tr>
                                       <tr> <td>5月</td> <td class="col-number">50,000</td> <td class="col-number">0</td> <td class="col-number">20,000</td> <td class="col-number">0</td> <td class="col-number">1,940,000</td> </tr>
                                       <tr> <td>...</td> <td class="col-number">...</td> <td class="col-number">...</td> <td class="col-number">...</td> <td class="col-number">...</td> <td class="col-number">...</td> </tr>
                                       <tr style="font-weight: bold; background-color: var(--color-hover-bg);"> <td>合計/期末</td> <td class="col-number">300,000</td> <td class="col-number">0</td> <td class="col-number">120,000</td> <td class="col-number">0</td> <td class="col-number">2,050,000</td> </tr>
                                   </tbody>
                               </table>
                           </div>
                       </div>
                    </div>
                     <div id="tab-production-project" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">案件別サマリー</h2>
                            <div class="kpi-grid">
                                <div class="kpi-card"> <h4>完了案件数</h4> <p>15 <span class="subtext">件</span></p> </div>
                                <div class="kpi-card"> <h4>平均利益率</h4> <p>65.2 <span class="subtext">%</span></p> </div>
                                <div class="kpi-card"> <h4>最高利益率案件</h4> <p>データ入力 <span class="subtext">(90.0%)</span></p> </div>
                                <div class="kpi-card"> <h4>最低利益率案件</h4> <p>部品組立 <span class="subtext">(43.8%)</span></p> </div>
                           </div>
                        </div>
                       <div class="section">
                            <div class="section-header">
                                <h2 class="section-title-in-header">案件別分析グラフ</h2>
                                <div class="section-header-controls">
                                     <button class="button button-secondary" onclick="alert('CSVダウンロード（未実装）')">CSV</button>
                                </div>
                            </div>
                           <div class="section-content"> <div class="chart-placeholder">（案件別の収益・費用・利益を示すグラフ）</div> </div>
                       </div>
                       <div class="section">
                           <div class="section-header">
                               <h2 class="section-title-in-header">案件別分析 (一覧表)</h2>
                               <div class="section-header-controls">
                                    <button class="button button-secondary" onclick="alert('CSVダウンロード（未実装）')">CSV</button>
                               </div>
                           </div>
                            <form class="section-content filter-form-inline" style="margin-bottom: 1.5rem;">
                               <div class="form-group" style="flex-grow: 2;"> <label for="search-prod-project-name-summary" class="form-label">案件名/取引先</label> <input type="text" id="search-prod-project-name-summary" class="form-control" placeholder="キーワードで検索..."> </div>
                               <div class="form-group"> <label for="filter-prod-profit-margin-summary" class="form-label">利益率</label> <select id="filter-prod-profit-margin-summary" class="form-control"> <option value="">すべて</option> <option value="high">50%以上</option> <option value="medium">20%-50%</option> <option value="low">20%未満</option> <option value="negative">赤字</option> </select> </div>
                               <button type="button" class="button button-secondary">クリア</button>
                           </form>
                           <div class="table-wrapper">
                               <table class="table">
                                   <thead> <tr> <th>案件名</th> <th>取引先</th> <th class="col-number">収益（円）</th> <th class="col-number">費用(円)</th> <th class="col-number">利益(円)</th> <th class="col-number">利益率(%)</th> </tr> </thead>
                                   <tbody id="production-tbody-summary">
                                       <tr class="clickable-row" data-project-name="DM封入作業" data-partner-name="株式会社A" data-profit-margin="75"> <td style="text-align: left;">DM封入作業</td> <td style="text-align: left;">株式会社A</td> <td class="col-number">1,200,000</td> <td class="col-number">300,000</td> <td class="col-number">900,000</td> <td class="col-number">75.0%</td> </tr>
                                       <tr class="clickable-row" data-project-name="部品組み立て" data-partner-name="有限会社B" data-profit-margin="43.8"> <td style="text-align: left;">部品組み立て</td> <td style="text-align: left;">有限会社B</td> <td class="col-number">800,000</td> <td class="col-number">450,000</td> <td class="col-number">350,000</td> <td class="col-number">43.8%</td> </tr>
                                       <tr class="clickable-row" data-project-name="データ入力" data-partner-name="C-Tech" data-profit-margin="90"> <td style="text-align: left;">データ入力</td> <td style="text-align: left;">C-Tech</td> <td class="col-number">500,000</td> <td class="col-number">50,000</td> <td class="col-number">450,000</td> <td class="col-number">90.0%</td> </tr>
                                   </tbody>
                               </table>
                           </div>
                       </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="script.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        function setupPeriodSelector(pageId) {
            const pageElement = document.getElementById(pageId);
            if (!pageElement) return;

            const unitButtonsContainer = pageElement.querySelector('.period-unit-buttons');
            const periodDetailsContainer = pageElement.querySelector('.period-detail-selectors');
            const yearSelect = pageElement.querySelector('.period-year-select');
            const monthSelect = pageElement.querySelector('.period-month-select');
            const monthLabel = pageElement.querySelector('.period-month-label');
            const prevButton = pageElement.querySelector('.period-prev-button');
            const nextButton = pageElement.querySelector('.period-next-button');
            const periodDisplayMain = pageElement.querySelector('.period-display-main');
            const periodDisplaySub = pageElement.querySelector('.period-display-sub');
            const periodDisplayLabel = pageElement.querySelector('.period-display-label');

            if (!unitButtonsContainer || !periodDetailsContainer || !yearSelect || !monthSelect || !monthLabel || !prevButton || !nextButton || !periodDisplayMain || !periodDisplaySub || !periodDisplayLabel) {
                return;
            }


            function getPeriodStartEnd(year, month) {
                const yearNum = parseInt(year);
                let startMonth, endMonth, startDay, endDay;

                startMonth = 4;
                startDay = 1;
                endMonth = 3;
                endDay = 31;

                let startDate, endDate;

                if (month) {
                    const monthNum = parseInt(month);
                    let targetYear = yearNum;
                    if (monthNum >= 1 && monthNum <= 3) {
                        targetYear += 1;
                    }
                    startDate = new Date(targetYear, monthNum - 1, 1);
                    endDate = new Date(targetYear, monthNum, 0);
                } else {
                    startDate = new Date(yearNum, startMonth - 1, startDay);
                    endDate = new Date(yearNum + 1, endMonth - 1, endDay);
                }

                const formatDate = (date) => {
                    return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                }

                return {
                    start: formatDate(startDate),
                    end: formatDate(endDate)
                };
            }

            function updatePeriodDisplay() {
                const activeUnitButton = unitButtonsContainer.querySelector('.period-unit-button.active');
                let displayMain = '';
                let displaySub = '';
                let displaySpan = '';
                let displayLabelText = '期間';

                if (activeUnitButton) {
                    const unit = activeUnitButton.dataset.unit;
                    if (unit === 'monthly' && yearSelect && monthSelect) {
                        const yearText = yearSelect.options[yearSelect.selectedIndex]?.text || '';
                        const monthText = monthSelect.options[monthSelect.selectedIndex]?.text || '';
                        const yearValue = yearSelect.value;
                        const monthValue = monthSelect.value;
                        displayMain = `${yearText.replace('年度','')} ${monthText}`;
                        const { start, end } = getPeriodStartEnd(yearValue, monthValue);
                        displaySub = `${start}～${end}`;
                        displaySpan = displayMain;
                        displayLabelText = '対象月';
                    } else if (unit === 'yearly' && yearSelect) {
                        const yearText = yearSelect.options[yearSelect.selectedIndex]?.text || '';
                        const yearValue = yearSelect.value;
                        displayMain = yearText;
                        const { start, end } = getPeriodStartEnd(yearValue);
                        displaySub = `${start}～${end}`;
                        displaySpan = displayMain;
                        displayLabelText = '事業年度';
                    } else if (unit === 'all') {
                        displayMain = '全期間';
                        displaySub = '';
                        displaySpan = displayMain;
                        displayLabelText = '全期間';
                    }
                }
                if(periodDisplayMain) periodDisplayMain.textContent = displayMain;
                if(periodDisplaySub) periodDisplaySub.textContent = displaySub;
                if(periodDisplayLabel) periodDisplayLabel.textContent = displayLabelText;

                 const detailTables = pageElement.querySelectorAll('.section table');
                 detailTables.forEach(table => {
                    const tableHeader = table.closest('.section').querySelector('.section-title-in-header, .section-title');
                     if(tableHeader){
                         tableHeader.textContent = tableHeader.textContent.split('(')[0].trim() + ` (${displaySpan})`;
                     }
                 });
            }

            unitButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.period-unit-button');
                if (!button || button.classList.contains('active')) return;

                unitButtonsContainer.querySelectorAll('.period-unit-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const unit = button.dataset.unit;

                yearSelect.style.display = (unit === 'monthly' || unit === 'yearly') ? '' : 'none';
                yearSelect.previousElementSibling.style.display = yearSelect.style.display;
                monthSelect.style.display = (unit === 'monthly') ? '' : 'none';
                monthLabel.style.display = monthSelect.style.display;

                 prevButton.style.visibility = (unit === 'all') ? 'hidden' : 'visible';
                 nextButton.style.visibility = (unit === 'all') ? 'hidden' : 'visible';

                updatePeriodDisplay();

            });

            yearSelect.addEventListener('change', updatePeriodDisplay);
            monthSelect.addEventListener('change', updatePeriodDisplay);

            prevButton.addEventListener('click', () => {
                const activeUnitButton = unitButtonsContainer.querySelector('.period-unit-button.active');
                if (!activeUnitButton) return;
                const unit = activeUnitButton.dataset.unit;

                if (unit === 'monthly') {
                    let currentMonthIndex = monthSelect.selectedIndex;
                    let currentYearIndex = yearSelect.selectedIndex;
                    if (currentMonthIndex > 0) {
                        monthSelect.selectedIndex = currentMonthIndex - 1;
                    } else {
                        if (currentYearIndex + 1 < yearSelect.options.length) {
                            yearSelect.selectedIndex = currentYearIndex + 1;
                            monthSelect.selectedIndex = monthSelect.options.length - 1;
                        }
                    }
                } else if (unit === 'yearly') {
                    let currentYearIndex = yearSelect.selectedIndex;
                    if (currentYearIndex + 1 < yearSelect.options.length) {
                         yearSelect.selectedIndex = currentYearIndex + 1;
                    }
                }
                updatePeriodDisplay();
            });

            nextButton.addEventListener('click', () => {
                const activeUnitButton = unitButtonsContainer.querySelector('.period-unit-button.active');
                if (!activeUnitButton) return;
                const unit = activeUnitButton.dataset.unit;

                if (unit === 'monthly') {
                    let currentMonthIndex = monthSelect.selectedIndex;
                    let currentYearIndex = yearSelect.selectedIndex;
                    if (currentMonthIndex < monthSelect.options.length - 1) {
                        monthSelect.selectedIndex = currentMonthIndex + 1;
                    } else {
                        if (currentYearIndex > 0) {
                            yearSelect.selectedIndex = currentYearIndex - 1;
                            monthSelect.selectedIndex = 0;
                        }
                    }
                } else if (unit === 'yearly') {
                    let currentYearIndex = yearSelect.selectedIndex;
                     if (currentYearIndex > 0) {
                         yearSelect.selectedIndex = currentYearIndex - 1;
                     }
                }
                 updatePeriodDisplay();
             });

            const initialActiveButton = unitButtonsContainer.querySelector('.period-unit-button.active');
            if (initialActiveButton) {
                const initialUnit = initialActiveButton.dataset.unit;
                yearSelect.style.display = (initialUnit === 'monthly' || initialUnit === 'yearly') ? '' : 'none';
                yearSelect.previousElementSibling.style.display = yearSelect.style.display;
                monthSelect.style.display = (initialUnit === 'monthly') ? '' : 'none';
                monthLabel.style.display = monthSelect.style.display;
                 prevButton.style.visibility = (initialUnit === 'all') ? 'hidden' : 'visible';
                 nextButton.style.visibility = (initialUnit === 'all') ? 'hidden' : 'visible';
                 updatePeriodDisplay();
            }
        }

        setupPeriodSelector('analytics-production');

         const subNavContainer = document.getElementById('production-subnav');
         const tabContents = document.querySelectorAll('#analytics-production .tab-content-wrapper .tab-content');
         if (subNavContainer && tabContents.length > 0) {
             subNavContainer.addEventListener('click', (e) => {
                 const navItem = e.target.closest('.sub-nav-item');
                 if (!navItem || navItem.classList.contains('active')) { return; }
                 e.preventDefault();
                 const targetTabId = navItem.dataset.tab;
                 subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => { item.classList.remove('active'); });
                 navItem.classList.add('active');
                 tabContents.forEach(content => {
                     const isActive = content.id === targetTabId;
                     content.classList.toggle('active', isActive);
                     content.style.display = isActive ? 'block' : 'none';
                 });
             });
              const firstNavItem = subNavContainer.querySelector('.sub-nav-item');
              const firstTabContent = tabContents[0];
               if (firstNavItem && firstTabContent) {
                   subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => item.classList.remove('active'));
                   tabContents.forEach(content => { content.classList.remove('active'); content.style.display = 'none'; });
                   firstNavItem.classList.add('active');
                   firstTabContent.classList.add('active');
                   firstTabContent.style.display = 'block';
               }
         }


        function filterProductionTableSummary() {
             const keywordInput = document.getElementById('search-prod-project-name-summary');
             const marginSelect = document.getElementById('filter-prod-profit-margin-summary');
             const tableBody = document.getElementById('production-tbody-summary');
             if (!keywordInput || !marginSelect || !tableBody) return;
             const keywordFilter = keywordInput.value.toLowerCase();
             const marginFilter = marginSelect.value;
             const rows = tableBody.getElementsByTagName('tr');
             Array.from(rows).forEach(row => {
                 const projectName = row.dataset.projectName?.toLowerCase() || '';
                 const partnerName = row.dataset.partnerName?.toLowerCase() || '';
                 const profitMargin = parseFloat(row.dataset.profitMargin || 0);
                 const keywordMatch = keywordFilter === "" || projectName.includes(keywordFilter) || partnerName.includes(keywordFilter);
                 let marginMatch = true;
                 if(marginFilter === "high" && profitMargin < 50) marginMatch = false;
                 if(marginFilter === "medium" && (profitMargin < 20 || profitMargin >= 50)) marginMatch = false;
                 if(marginFilter === "low" && profitMargin >= 20) marginMatch = false;
                 if(marginFilter === "negative" && profitMargin >= 0) marginMatch = false;
                 row.style.display = (keywordMatch && marginMatch) ? '' : 'none';
             });
        }

        const keywordProdInputSummary = document.getElementById('search-prod-project-name-summary');
        const marginProdSelectSummary = document.getElementById('filter-prod-profit-margin-summary');
        const clearProdButtonSummary = document.querySelector('#analytics-production #tab-production-project .filter-form-inline .button-secondary');
        if(keywordProdInputSummary) keywordProdInputSummary.addEventListener('input', filterProductionTableSummary);
        if(marginProdSelectSummary) marginProdSelectSummary.addEventListener('change', filterProductionTableSummary);
        if(clearProdButtonSummary) {
             clearProdButtonSummary.addEventListener('click', () => {
                 const form = clearProdButtonSummary.closest('form');
                 if(form) form.reset();
                 filterProductionTableSummary();
             });
        }

        filterProductionTableSummary();

    });
</script>
</body>
</html>