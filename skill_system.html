<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>p2508d - スキル体系設定</title>

    <link rel="stylesheet" href="style.css">

    <style>
        /* --- テーブル内のフォーム要素 --- */
        .table .form-control {
            width: 100%;
            padding: 0.375rem 0.5rem;
            font-size: var(--font-size-sm);
            box-sizing: border-box;
        }

        /* --- 検索/ページネーション (スキル項目タブ用) --- */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .search-form {
            display: flex;
            gap: 0.5rem;
        }
        .search-form .form-control {
            width: 300px;
        }
        .pagination-controls {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 1rem;
        }
        .items-per-page {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: var(--font-size-sm);
        }
        .items-per-page .form-control {
            width: auto;
        }
        .pagination-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: var(--font-size-sm);
        }
        .sort-link { /* スキル項目タブ用 */
            color: inherit;
            text-decoration: none;
            cursor: pointer;
        }
        .sort-link:hover {
            text-decoration: underline;
        }

        /* --- アコーディオン・ツリー用スタイル --- */
        .category-name-cell {
            display: flex;
            align-items: center;
        }
        .toggle-icon {
            display: inline-block;
            width: 20px; /* アイコンの幅 */
            height: 20px;
            text-align: center;
            line-height: 18px;
            font-size: 0.8em;
            cursor: pointer;
            margin-right: 4px;
            color: #666;
            font-family: monospace;
        }
        .toggle-icon.no-child {
            cursor: default;
            color: transparent;
        }
        /* ツリー記号 */
        .tree-prefix {
            flex-shrink: 0;
            font-family: monospace;
            font-size: 1.1em;
            color: #999;
            margin-right: 2px;
            width: 20px; /* アイコンと同じ幅を確保 */
            display: inline-block; /* 幅指定のため */
            text-align: center;
        }
         /* インデントレベルに応じた padding-left */
        .category-name-cell.indent-0 { padding-left: 0px; }
        .category-name-cell.indent-1 { padding-left: 24px; } /* 20px (アイコン) + 4px (マージン) */
        .category-name-cell.indent-2 { padding-left: 48px; } /* 24px * 2 */
        .category-name-cell.indent-3 { padding-left: 72px; } /* 24px * 3 */
        /* 必要に応じて .indent-4 なども追加 */

        .sub-category.collapsed {
            display: none;
        }

        .table .col-actions {
            width: 150px;
        }

        .add-root-row .static-text {
            color: var(--color-text-secondary);
            font-style: italic;
            padding: 0.375rem 0.5rem;
            display: inline-block;
            line-height: 1.5;
        }
    </style>
    </head>
<body>

    <div class="mockup-container">
        <header class="header">
            <div>
                <h1 class="header-logo"><a href="dashboard.html">p2508d</a></h1>
            </div>
            
            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="dashboard.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="daily_records.html" class="nav-link">日々の記録</a></li>
                    <li><a href="members_menu.html" class="nav-link">利用者支援</a></li>
                    <li><a href="work_activities_menu.html" class="nav-link">生産活動</a></li>
                    <li><a href="staff_menu.html" class="nav-link">施設と職員</a></li>
                    <li><a href="accounting_menu.html" class="nav-link">会計</a></li>
                    <li><a href="claims.html" class="nav-link">国保連請求</a></li>
                    <li><a href="analytics_menu.html" class="nav-link">データ分析</a></li>
                    <li><a href="settings.html" class="nav-link active">設定</a></li>
                    <li><a href="my_page.html" class="nav-link">マイページ</a></li>
                </ul>
                <div class="nav-logout-section">
                    <a href="index.html" class="nav-link">ログアウト</a>
                </div>
            </nav>
        </header>

        <main class="mockup-main">
            
            <div id="skill-system-detail" class="mockup-page active">
                <div class="list-page-header">
                     <h1 class="page-title">スキル体系設定</h1>
                     <div>
                        <a href="settings.html" class="button button-secondary">設定TOPへ戻る</a>
                     </div>
                </div>

                 <div class="sub-nav">
                    <ul id="skill-system-subnav">
                        <li><a href="#" class="sub-nav-item active" data-tab="tab-skill-categories">スキルカテゴリ</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-skill-items">スキル項目</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-skill-levels">習熟度レベル</a></li>
                    </ul>
                </div>
                 <div class="tab-content-wrapper">
                    
                    <div id="tab-skill-categories" class="tab-content active">
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem; border: none;">
                                <h2 class="section-title" style="margin: 0; border: none;">スキルカテゴリ設定</h2>
                            </div>
                            
                            <div class="table-wrapper">
                                <table class="table" id="category-table">
                                    <thead>
                                        <tr>
                                            <th>カテゴリ名</th>
                                            <th class="col-actions">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="category-table-body">
                                        <tr class="add-root-row">
                                            <td class="category-name-cell indent-0">
                                                <span class="toggle-icon no-child"></span>
                                                <span class="static-text">（ルートカテゴリ）</span>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary" id="add-root-category-row" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr data-toggle="collapse" data-target-id="cat-mkt">
                                            <td class="category-name-cell indent-0">
                                                <span class="toggle-icon">▶</span>
                                                <input type="text" class="form-control" value="マーケティング">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sub-category collapsed" data-parent-id="cat-mkt" data-toggle="collapse" data-target-id="cat-seo"> <td class="category-name-cell indent-1">
                                                <span class="toggle-icon">▶</span>
                                                <span class="tree-prefix">└&nbsp;</span>
                                                <input type="text" class="form-control" value="SEO/広告">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sub-category collapsed" data-parent-id="cat-seo">
                                            <td class="category-name-cell indent-2">
                                                <span class="toggle-icon no-child"></span>
                                                <span class="tree-prefix">└&nbsp;</span>
                                                <input type="text" class="form-control" value="Web広告">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sub-category collapsed" data-parent-id="cat-mkt">
                                            <td class="category-name-cell indent-1">
                                                <span class="toggle-icon no-child"></span>
                                                <span class="tree-prefix">└&nbsp;</span>
                                                <input type="text" class="form-control" value="SNS">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr data-toggle="collapse" data-target-id="cat-des">
                                            <td class="category-name-cell indent-0">
                                                <span class="toggle-icon">▶</span>
                                                <input type="text" class="form-control" value="デザイン">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sub-category collapsed" data-parent-id="cat-des">
                                            <td class="category-name-cell indent-1">
                                                <span class="toggle-icon no-child"></span>
                                                <span class="tree-prefix">└&nbsp;</span>
                                                <input type="text" class="form-control" value="UI/UX">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sub-category collapsed" data-parent-id="cat-des">
                                            <td class="category-name-cell indent-1">
                                                <span class="toggle-icon no-child"></span>
                                                <span class="tree-prefix">└&nbsp;</span>
                                                <input type="text" class="form-control" value="グラフィック">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr data-toggle="collapse" data-target-id="cat-dev">
                                            <td class="category-name-cell indent-0">
                                                <span class="toggle-icon">▶</span>
                                                <input type="text" class="form-control" value="開発">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sub-category collapsed" data-parent-id="cat-dev">
                                            <td class="category-name-cell indent-1">
                                                <span class="toggle-icon no-child"></span>
                                                <span class="tree-prefix">└&nbsp;</span>
                                                <input type="text" class="form-control" value="フロントエンド">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr class="sub-category collapsed" data-parent-id="cat-dev">
                                            <td class="category-name-cell indent-1">
                                                <span class="toggle-icon no-child"></span>
                                                <span class="tree-prefix">└&nbsp;</span>
                                                <input type="text" class="form-control" value="バックエンド">
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        </div>
                    <div id="tab-skill-items" class="tab-content">
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                               <h2 class="section-title" style="margin: 0; border: none;">スキル項目設定</h2>
                               <button type="button" class="button button-primary" id="add-skill-item-row">＋ 項目を追加</button>
                           </div>
                           <div class="table-controls">
                               <div class="search-form">
                                   <input type="text" placeholder="スキル名で検索..." class="form-control" id="search-skill-item">
                               </div>
                               <div class="items-per-page">
                                   <label for="items-per-page-item">表示件数:</label>
                                   <select id="items-per-page-item" class="form-control">
                                       <option value="20">20</option>
                                       <option value="50" selected>50</option>
                                       <option value="100">100</option>
                                   </select>
                               </div>
                           </div>
                           <div class="table-wrapper">
                               <table class="table" id="skill-item-table">
                                   <thead>
                                       <tr>
                                           <th><a href="#" class="sort-link">スキル名</a></th>
                                           <th style="width: 250px;"><a href="#" class="sort-link">カテゴリ</a></th>
                                           <th class="col-actions">操作</th>
                                       </tr>
                                   </thead>
                                   <tbody id="skill-item-table-body">
                                       <tr>
                                           <td><input type="text" class="form-control" value="キーワードリサーチ"></td>
                                           <td>
                                               <select class="form-control">
                                                   <option value="mkt">マーケティング</option>
                                                   <option value="seo_ad" selected>└ SEO/広告</option>
                                                   <option value="sns">└ SNS</option>
                                                   <option value="des">デザイン</option>
                                                   <option value="ui_ux">└ UI/UX</option>
                                                   <option value="gfx">└ グラフィック</option>
                                                   <option value="dev">開発</option>
                                                   <option value="front">└ フロントエンド</option>
                                                   <option value="back">└ バックエンド</option>
                                               </select>
                                           </td>
                                           <td class="col-actions">
                                               <div class="table-button-group">
                                                   <button type="button" class="button button-danger">削除</button>
                                               </div>
                                           </td>
                                       </tr>
                                       <tr>
                                           <td><input type="text" class="form-control" value="GA4分析"></td>
                                           <td>
                                               <select class="form-control">
                                                   <option value="mkt">マーケティング</option>
                                                   <option value="seo_ad" selected>└ SEO/広告</option>
                                                   <option value="sns">└ SNS</option>
                                                   <option value="des">デザイン</option>
                                                   <option value="ui_ux">└ UI/UX</option>
                                                   <option value="gfx">└ グラフィック</option>
                                                   <option value="dev">開発</option>
                                                   <option value="front">└ フロントエンド</option>
                                                   <option value="back">└ バックエンド</option>
                                               </select>
                                           </td>
                                           <td class="col-actions">
                                               <div class="table-button-group">
                                                   <button type="button" class="button button-danger">削除</button>
                                               </div>
                                           </td>
                                       </tr>
                                       <tr>
                                           <td><input type="text" class="form-control" value="Instagram投稿作成"></td>
                                           <td>
                                               <select class="form-control">
                                                   <option value="mkt">マーケティング</option>
                                                   <option value="seo_ad">└ SEO/広告</option>
                                                   <option value="sns" selected>└ SNS</option>
                                                   <option value="des">デザイン</option>
                                                   <option value="ui_ux">└ UI/UX</option>
                                                   <option value="gfx">└ グラフィック</option>
                                                   <option value="dev">開発</option>
                                                   <option value="front">└ フロントエンド</option>
                                                   <option value="back">└ バックエンド</option>
                                               </select>
                                           </td>
                                           <td class="col-actions">
                                               <div class="table-button-group">
                                                   <button type="button" class="button button-danger">削除</button>
                                               </div>
                                           </td>
                                       </tr>
                                       <tr>
                                           <td><input type="text" class="form-control" value="ワイヤーフレーム作成"></td>
                                           <td>
                                               <select class="form-control">
                                                   <option value="mkt">マーケティング</option>
                                                   <option value="seo_ad">└ SEO/広告</option>
                                                   <option value="sns">└ SNS</option>
                                                   <option value="des">デザイン</option>
                                                   <option value="ui_ux" selected>└ UI/UX</option>
                                                   <option value="gfx">└ グラフィック</option>
                                                   <option value="dev">開発</option>
                                                   <option value="front">└ フロントエンド</option>
                                                   <option value="back">└ バックエンド</option>
                                               </select>
                                           </td>
                                           <td class="col-actions">
                                               <div class="table-button-group">
                                                   <button type="button" class="button button-danger">削除</button>
                                               </div>
                                           </td>
                                       </tr>
                                       <tr>
                                           <td><input type="text" class="form-control" value="バナー作成 (Figma)"></td>
                                           <td>
                                               <select class="form-control">
                                                   <option value="mkt">マーケティング</option>
                                                   <option value="seo_ad">└ SEO/広告</option>
                                                   <option value="sns">└ SNS</option>
                                                   <option value="des">デザイン</option>
                                                   <option value="ui_ux">└ UI/UX</option>
                                                   <option value="gfx" selected>└ グラフィック</option>
                                                   <option value="dev">開発</option>
                                                   <option value="front">└ フロントエンド</option>
                                                   <option value="back">└ バックエンド</option>
                                               </select>
                                           </td>
                                           <td class="col-actions">
                                               <div class="table-button-group">
                                                   <button type="button" class="button button-danger">削除</button>
                                               </div>
                                           </td>
                                       </tr>
                                       <tr>
                                           <td><input type="text" class="form-control" value="HTML/CSSコーディング"></td>
                                           <td>
                                               <select class="form-control">
                                                   <option value="mkt">マーケティング</option>
                                                   <option value="seo_ad">└ SEO/広告</option>
                                                   <option value="sns">└ SNS</option>
                                                   <option value="des">デザイン</option>
                                                   <option value="ui_ux">└ UI/UX</option>
                                                   <option value="gfx">└ グラフィック</option>
                                                   <option value="dev">開発</option>
                                                   <option value="front" selected>└ フロントエンド</option>
                                                   <option value="back">└ バックエンド</option>
                                               </select>
                                           </td>
                                           <td class="col-actions">
                                               <div class="table-button-group">
                                                   <button type="button" class="button button-danger">削除</button>
                                               </div>
                                           </td>
                                       </tr>
                                       <tr>
                                           <td><input type="text" class="form-control" value="API開発 (Node.js)"></td>
                                           <td>
                                               <select class="form-control">
                                                   <option value="mkt">マーケティング</option>
                                                   <option value="seo_ad">└ SEO/広告</option>
                                                   <option value="sns">└ SNS</option>
                                                   <option value="des">デザイン</option>
                                                   <option value="ui_ux">└ UI/UX</option>
                                                   <option value="gfx">└ グラフィック</option>
                                                   <option value="dev">開発</option>
                                                   <option value="front">└ フロントエンド</option>
                                                   <option value="back" selected>└ バックエンド</option>
                                               </select>
                                           </td>
                                           <td class="col-actions">
                                               <div class="table-button-group">
                                                   <button type="button" class="button button-danger">削除</button>
                                               </div>
                                           </td>
                                       </tr>
                                   </tbody>
                               </table>
                           </div>
                           <div class="pagination-controls">
                               <div class="pagination-nav">
                                   <span>1 - 7 / 7件中</span>
                                   <button class="button button-secondary" disabled>&lt; 前へ</button>
                                   <button class="button button-secondary">次へ &gt;</button>
                               </div>
                           </div>
                        </div>
                        </div>
                    
                    <div id="tab-skill-levels" class="tab-content">
                         <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">習熟度レベル設定</h2>
                                <button type="button" class="button button-primary" id="add-level-row">＋ レベルを追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="level-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 150px;">レベル名</th>
                                            <th>説明</th>
                                            <th class="col-actions">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="level-table-body">
                                        <tr>
                                            <td><input type="text" class="form-control" value="Lv.0"></td>
                                            <td><input type="text" class="form-control" value="未学習・見学"></td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" class="form-control" value="Lv.1"></td>
                                            <td><input type="text" class="form-control" value="要支援・練習中"></td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" class="form-control" value="Lv.2"></td>
                                            <td><input type="text" class="form-control" value="独力で作業可能"></td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" class="form-control" value="Lv.3"></td>
                                            <td><input type="text" class="form-control" value="指導・検品が可能"></td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                         </div>

                </div>

            </div>

        </main>
    </div>

    <template id="category-row-template">
        <tr data-toggle="collapse" data-target-id="new-cat-id">
            <td class="category-name-cell indent-0">
                <span class="toggle-icon no-child"></span>
                <input type="text" class="form-control" placeholder="新規カテゴリ名">
            </td>
            <td class="col-actions">
                <div class="table-button-group">
                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                    <button type="button" class="button button-danger">削除</button>
                </div>
            </td>
        </tr>
    </template>
    
    <template id="subcategory-row-template">
        <tr class="sub-category collapsed" data-parent-id="" data-target-id="new-subcat-id"> <td class="category-name-cell">
                <span class="toggle-icon no-child"></span>
                <span class="tree-prefix">└&nbsp;</span>
                <input type="text" class="form-control" placeholder="新規サブカテゴリ名">
            </td>
            <td class="col-actions">
                <div class="table-button-group">
                    <button type="button" class="button button-secondary add-subcategory-button" style="font-size: var(--font-size-xs);">子カテゴリ追加</button>
                    <button type="button" class="button button-danger">削除</button>
                </div>
            </td>
        </tr>
    </template>


    <template id="skill-item-row-template">
        <tr>
            <td><input type="text" class="form-control" placeholder="新規スキル名"></td>
            <td>
                <select class="form-control">
                    <option value="">カテゴリを選択</option>
                    <option value="mkt">マーケティング</option>
                    <option value="seo_ad">└ SEO/広告</option>
                    <option value="sns">└ SNS</option>
                    <option value="des">デザイン</option>
                    <option value="ui_ux">└ UI/UX</option>
                    <option value="gfx">└ グラフィック</option>
                    <option value="dev">開発</option>
                    <option value="front">└ フロントエンド</option>
                    <option value="back">└ バックエンド</option>
                </select>
            </td>
            <td class="col-actions">
                <div class="table-button-group">
                    <button type="button" class="button button-danger">削除</button>
                </div>
            </td>
        </tr>
    </template>

    <template id="level-row-template">
        <tr>
            <td><input type="text" class="form-control" placeholder="例: Lv.4"></td>
            <td><input type="text" class="form-control" placeholder="レベルの説明"></td>
            <td class="col-actions">
                <div class="table-button-group">
                    <button type="button" class="button button-danger">削除</button>
                </div>
            </td>
        </tr>
    </template>
    <script src="script.js"></script>

     <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- サブナビゲーション（タブ）切り替え ---
            const subNavContainer = document.getElementById('skill-system-subnav');
            const tabContents = document.querySelectorAll('#skill-system-detail .tab-content-wrapper .tab-content'); 
            
            if (subNavContainer && tabContents.length > 0) {
                subNavContainer.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.sub-nav-item');
                    if (!navItem || navItem.classList.contains('active')) { return; }
                    e.preventDefault();
                    
                    const targetTabId = navItem.dataset.tab;
                    
                    subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => { item.classList.remove('active'); });
                    navItem.classList.add('active');
                    
                    tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === targetTabId);
                    });
                });
            }


            // --- スキルカテゴリタブのロジック ---
            const categoryTbody = document.getElementById('category-table-body');
            const rootCategoryButton = document.getElementById('add-root-category-row');
            const rootCategoryTemplate = document.getElementById('category-row-template');
            const subCategoryTemplate = document.getElementById('subcategory-row-template');

            if (categoryTbody && rootCategoryButton && rootCategoryTemplate && subCategoryTemplate) {
                
                // ルートカテゴリ追加ボタンのイベント
                rootCategoryButton.addEventListener('click', () => {
                    const clone = rootCategoryTemplate.content.cloneNode(true);
                    const newId = `cat-new-${Date.now()}`;
                    clone.querySelector('tr').dataset.targetId = newId; 
                    // ルート追加行の直後に挿入
                    categoryTbody.insertBefore(clone, rootCategoryButton.closest('tr').nextSibling); 
                });

                // tbody 内のイベント委任 (削除、サブ追加、開閉)
                categoryTbody.addEventListener('click', (e) => {
                    const deleteButton = e.target.closest('.button-danger');
                    const addSubButton = e.target.closest('.add-subcategory-button');
                    const toggleIcon = e.target.closest('.toggle-icon');

                    // 削除ボタンの処理
                    if (deleteButton) {
                        const row = deleteButton.closest('tr');
                        if (row && !row.classList.contains('add-root-row')) {
                            const targetId = row.dataset.targetId;
                            if (targetId) {
                                // 子孫要素を再帰的に削除する関数
                                function removeDescendants(parentId) {
                                    const children = categoryTbody.querySelectorAll(`[data-parent-id="${parentId}"]`);
                                    children.forEach(child => {
                                        const childTargetId = child.dataset.targetId;
                                        if (childTargetId) {
                                            removeDescendants(childTargetId); // 再帰呼び出し
                                        }
                                        child.remove();
                                    });
                                }
                                removeDescendants(targetId); // 子孫を削除
                            }
                            row.remove(); // 自分自身を削除
                        }
                    }
                    // 子カテゴリ追加ボタンの処理
                    else if (addSubButton) {
                        const parentRow = addSubButton.closest('tr');
                         // ルート追加行からの追加も許可
                        if (parentRow) { 
                            
                            const clone = subCategoryTemplate.content.cloneNode(true);
                            const newRow = clone.querySelector('tr');
                            const nameCell = newRow.querySelector('.category-name-cell');
                            
                            let parentId = parentRow.dataset.targetId || 'root'; // ルート行には targetId がないので 'root' とする
                            // ルート追加行からの場合は parentId を null (または空) にする
                             if (parentRow.classList.contains('add-root-row')) {
                                parentId = null; 
                             } else if (!parentRow.dataset.targetId) {
                                // 既存行に ID がなければ仮設定
                                parentId = `cat-temp-${Math.random().toString(36).substring(2, 9)}`;
                                parentRow.dataset.targetId = parentId;
                             }
                            
                            if (parentId) { // ルート直下以外
                                newRow.dataset.parentId = parentId;
                            }
                            
                            const newSubId = `cat-sub-${Date.now()}`;
                            newRow.dataset.targetId = newSubId; 

                            // --- インデントレベルの計算 ---
                            let parentIndentLevel = -1;
                             if (!parentRow.classList.contains('add-root-row')) { // ルート追加行以外
                                const parentNameCell = parentRow.querySelector('.category-name-cell');
                                if (parentNameCell) {
                                    for (let i = 0; i < 5; i++) { // indent-0 から indent-4 までチェック (例)
                                        if (parentNameCell.classList.contains(`indent-${i}`)) {
                                            parentIndentLevel = i;
                                            break;
                                        }
                                    }
                                }
                             }
                            const newIndentLevel = parentIndentLevel + 1;
                            
                            // 新しい行にインデントクラスを設定
                            if (nameCell) {
                                nameCell.classList.remove('indent-0', 'indent-1', 'indent-2', 'indent-3'); // 既存をクリア
                                nameCell.classList.add(`indent-${newIndentLevel}`);
                            }
                            // --- インデント計算ここまで ---


                            const icon = parentRow.querySelector('.toggle-icon');
                            const childRows = parentId ? categoryTbody.querySelectorAll(`[data-parent-id="${parentId}"]`) : []; // ルートの場合は子は空
                            let insertAfter = parentRow;
                            
                            // 親が開いていなければ開く & アイコン更新
                            if (icon && !parentRow.classList.contains('add-root-row')) { // ルート追加行のアイコンは操作しない
                                if (icon.textContent === '▶') {
                                     icon.textContent = '▼';
                                     // 子要素を開く処理（開閉処理に依存）
                                     const targetIdToOpen = parentRow.dataset.targetId;
                                     if(targetIdToOpen) {
                                         const childrenToOpen = categoryTbody.querySelectorAll(`[data-parent-id="${targetIdToOpen}"]`);
                                         childrenToOpen.forEach(child => child.classList.remove('collapsed'));
                                     }
                                }
                                if (icon.classList.contains('no-child')) {
                                    icon.classList.remove('no-child');
                                    if (icon.textContent !== '▼') icon.textContent = '▼';
                                }
                            }
                           
                            // 挿入位置の決定: 最後の直接の子、または孫要素の最後を探す
                             let lastDescendant = parentRow;
                             if (parentId) { // ルート直下以外
                                 function findLastDescendant(currentParentId) {
                                     const directChildren = Array.from(categoryTbody.querySelectorAll(`[data-parent-id="${currentParentId}"]`));
                                     if (directChildren.length > 0) {
                                         const lastDirectChild = directChildren[directChildren.length - 1];
                                         const lastDirectChildId = lastDirectChild.dataset.targetId;
                                         if (lastDirectChildId) {
                                             // 最後の直接の子がさらに子を持つかチェック
                                             const grandChildren = categoryTbody.querySelectorAll(`[data-parent-id="${lastDirectChildId}"]`);
                                             if (grandChildren.length > 0 && !lastDirectChild.querySelector('.toggle-icon')?.classList.contains('no-child') && lastDirectChild.querySelector('.toggle-icon')?.textContent === '▼' ) {
                                                  // 孫要素がいる、かつ開いている場合、再帰的に探す
                                                 return findLastDescendant(lastDirectChildId);
                                             }
                                         }
                                         // 孫がいない、または閉じていれば、最後の直接の子の後ろ
                                         return lastDirectChild;
                                     }
                                     // 子がいなければ親自身
                                     return categoryTbody.querySelector(`[data-target-id="${currentParentId}"]`);
                                 }
                                 lastDescendant = findLastDescendant(parentId);
                             }

                             insertAfter = lastDescendant || parentRow; // 見つからなければ親の後ろ


                             // ルート行からの追加の場合は、インデントとツリー記号を調整
                             if (parentRow.classList.contains('add-root-row')) {
                                 newRow.querySelector('.tree-prefix').textContent = '';
                                 nameCell.classList.add('indent-0');
                             }
                            
                            // 新しい行は開いた状態で挿入
                            newRow.classList.remove('collapsed'); 
                            
                            insertAfter.parentNode.insertBefore(clone, insertAfter.nextSibling);
                        }
                    }
                    // 開閉アイコンの処理
                    else if (toggleIcon && !toggleIcon.classList.contains('no-child')) {
                        const row = toggleIcon.closest('tr');
                        const targetId = row.dataset.targetId;
                        if (!targetId) return;

                        // 子孫要素を再帰的に開閉する関数
                        function toggleDescendants(parentId, collapse) {
                            const children = categoryTbody.querySelectorAll(`[data-parent-id="${parentId}"]`);
                            children.forEach(child => {
                                if (collapse) {
                                    child.classList.add('collapsed');
                                } else {
                                    child.classList.remove('collapsed');
                                }
                                // 子がさらに子を持つ場合、親が開くときだけ再帰的に開く（閉じるときは全て閉じる）
                                const childTargetId = child.dataset.targetId;
                                const childIcon = child.querySelector('.toggle-icon');
                                if (childTargetId && childIcon && !childIcon.classList.contains('no-child')) {
                                     // 閉じるときは子の状態に関わらず再帰的に閉じる
                                     // 開くときは、その子が元々開いていた場合のみ再帰的に開く（アイコンが▼）
                                     if (collapse || (!collapse && childIcon.textContent === '▼')) {
                                         toggleDescendants(childTargetId, collapse);
                                     }
                                }
                            });
                        }

                        // 現在開いているかどうかの判定 (アイコンで判断)
                        const isCurrentlyCollapsed = (toggleIcon.textContent === '▶');

                        if (isCurrentlyCollapsed) {
                            toggleIcon.textContent = '▼';
                            toggleDescendants(targetId, false); // 子孫を開く
                        } else {
                            toggleIcon.textContent = '▶';
                            toggleDescendants(targetId, true); // 子孫を閉じる
                        }
                    }
                });
            }


            // --- テーブル行追加・削除の汎用ロジック (スキル項目・習熟度用) ---
            function setupSimpleTableRowAdder(tbodyId, addButtonId, templateId) {
                const tbody = document.getElementById(tbodyId);
                const addButton = document.getElementById(addButtonId);
                const template = document.getElementById(templateId);
                if (!tbody || !addButton || !template) return;

                addButton.addEventListener('click', () => {
                    const clone = template.content.cloneNode(true);
                    tbody.appendChild(clone);
                });

                tbody.addEventListener('click', (e) => {
                    const deleteButton = e.target.closest('td.col-actions .button-danger');
                    if (deleteButton && tbody.contains(deleteButton)) {
                        deleteButton.closest('tr').remove();
                    }
                });
            }
            
            setupSimpleTableRowAdder('skill-item-table-body', 'add-skill-item-row', 'skill-item-row-template');
            setupSimpleTableRowAdder('level-table-body', 'add-level-row', 'level-row-template');


            // --- リアルタイム検索の汎用ロジック (スキル項目タブのみ) ---
            function setupRealtimeSearch(inputId, tbodyId) {
                const searchInput = document.getElementById(inputId);
                const tableBody = document.getElementById(tbodyId);
                if (!searchInput || !tableBody) return;

                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.toLowerCase();
                    const rows = tableBody.getElementsByTagName('tr');

                    Array.from(rows).forEach(row => {
                        if (row.classList.contains('add-root-row')) return; // カテゴリ追加行は無視

                        // スキル名の input 要素を取得
                        const inputInCell = row.querySelector('td:first-child input.form-control'); 
                        if (inputInCell) {
                            const cellValue = inputInCell.value.toLowerCase();
                            if (cellValue.includes(searchTerm)) {
                                row.style.display = '';
                            } else {
                                row.style.display = 'none';
                            }
                        }
                    });
                });
            }
            
            setupRealtimeSearch('search-skill-item', 'skill-item-table-body');
        });
    </script>
     </body>
</html>