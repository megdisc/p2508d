<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>取引一覧 - p2508d</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mockup-container">
        <header class="header">
            <div>
                <h1 class="header-logo"><a href="dashboard.html">p2508d</a></h1>
            </div>

            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="dashboard.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="daily_records.html" class="nav-link">日々の記録</a></li>
                    <li><a href="members_menu.html" class="nav-link">利用者支援</a></li>
                    <li><a href="work_activities_menu.html" class="nav-link">生産活動</a></li>
                    <li><a href="staff_menu.html" class="nav-link">施設と職員</a></li>
                    <li><a href="accounting_menu.html" class="nav-link active">会計</a></li>
                    <li><a href="claims.html" class="nav-link">国保連請求</a></li>
                    <li><a href="analytics_menu.html" class="nav-link">データ分析</a></li>
                    <li><a href="settings.html" class="nav-link">設定</a></li>
                    <li><a href="my_page.html" class="nav-link">マイページ</a></li>
                </ul>
                <div class="nav-logout-section">
                    <a href="index.html" class="nav-link">ログアウト</a>
                </div>
            </nav>
        </header>

        <main class="mockup-main">
            <div id="transactions" class="mockup-page active">
                <div class="list-page-header">
                    <h1 class="page-title">取引一覧</h1>
                    <div>
                        <a href="accounting_menu.html" class="button button-secondary" style="margin-right: 0.5rem;">会計メニューへ</a>
                        <button class="button button-primary" onclick="openTransactionModal()">＋ 新規作成</button> </div>
                </div>

                <div class="section">
                    <form class="section-content filter-form-inline" style="margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label for="search-transaction-date-start" class="form-label">計上日(始)</label>
                            <input type="date" id="search-transaction-date-start" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="search-transaction-date-end" class="form-label">計上日(終)</label>
                            <input type="date" id="search-transaction-date-end" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="filter-transaction-type" class="form-label">種別</label>
                            <select id="filter-transaction-type" class="form-control">
                                <option value="">すべて</option>
                                <option value="売上">売上</option>
                                <option value="経費">経費</option>
                                <option value="その他入金">その他入金</option>
                                <option value="その他出金">その他出金</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-transaction-partner" class="form-label">取引先</label>
                            <select id="filter-transaction-partner" class="form-control">
                                <option value="">すべて</option>
                                <option value="株式会社〇〇">株式会社〇〇</option>
                                <option value="△△デザイン">△△デザイン</option>
                                <option value="NPO法人□□">NPO法人□□</option>
                                <option value="光熱費">光熱費</option>
                                <option value="消耗品店">消耗品店</option>
                            </select>
                        </div>
                        <div class="form-group" style="flex-grow: 1.5;">
                            <label for="search-transaction-keyword" class="form-label">キーワード</label>
                            <input type="text" id="search-transaction-keyword" class="form-control" placeholder="摘要などで検索...">
                        </div>
                        <button type="button" class="button button-secondary">クリア</button>
                    </form>

                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>計上日</th>
                                    <th>種別</th>
                                    <th>取引先</th>
                                    <th>勘定科目</th>
                                    <th>摘要</th>
                                    <th class="col-amount">金額（円）</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-list-tbody">
                                <tr class="clickable-row"
                                    data-date="2025-09-30"
                                    data-type="売上"
                                    data-partner="株式会社〇〇"
                                    data-account="売上高"
                                    data-project="Webサイト制作"
                                    data-summary="9月分請求"
                                    data-amount="500000">
                                    <td>2025/09/30</td>
                                    <td>売上</td>
                                    <td>株式会社〇〇</td>
                                    <td>売上高</td>
                                    <td style="text-align: left;">Webサイト制作 (9月分請求)</td>
                                    <td class="col-amount">500,000</td>
                                </tr>
                                <tr class="clickable-row"
                                    data-date="2025-09-28"
                                    data-type="経費"
                                    data-partner="光熱費"
                                    data-account="水道光熱費"
                                    data-project=""
                                    data-summary="事務所電気代 9月分"
                                    data-amount="15000">
                                    <td>2025/09/28</td>
                                    <td>経費</td>
                                    <td>光熱費</td>
                                    <td>水道光熱費</td>
                                    <td style="text-align: left;">事務所電気代 9月分</td>
                                    <td class="col-amount">15,000</td>
                                </tr>
                                <tr class="clickable-row"
                                    data-date="2025-09-25"
                                    data-type="売上"
                                    data-partner="△△デザイン"
                                    data-account="売上高"
                                    data-project="ロゴデザイン"
                                    data-summary=""
                                    data-amount="150000">
                                    <td>2025/09/25</td>
                                    <td>売上</td>
                                    <td>△△デザイン</td>
                                    <td>売上高</td>
                                    <td style="text-align: left;">ロゴデザイン</td>
                                    <td class="col-amount">150,000</td>
                                </tr>
                                 <tr class="clickable-row"
                                    data-date="2025-09-15"
                                    data-type="売上"
                                    data-partner="NPO法人□□"
                                    data-account="売上高"
                                    data-project="データ入力"
                                    data-summary=""
                                    data-amount="80000">
                                    <td>2025/09/15</td>
                                    <td>売上</td>
                                    <td>NPO法人□□</td>
                                    <td>売上高</td>
                                    <td style="text-align: left;">データ入力</td>
                                    <td class="col-amount">80,000</td>
                                </tr>
                                 <tr class="clickable-row"
                                    data-date="2025-09-10"
                                    data-type="経費"
                                    data-partner="消耗品店"
                                    data-account="消耗品費"
                                    data-project=""
                                    data-summary="コピー用紙、文房具"
                                    data-amount="5000">
                                    <td>2025/09/10</td>
                                    <td>経費</td>
                                    <td>消耗品店</td>
                                    <td>消耗品費</td>
                                    <td style="text-align: left;">コピー用紙、文房具</td>
                                    <td class="col-amount">5,000</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="edit-transaction-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">取引 編集/追加</h2>
                        <span class="modal-close" onclick="closeModal('edit-transaction-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <dl class="detail-grid" style="grid-template-columns: 100px 1fr;">
                            <dt><label for="modal-transaction-date" class="form-label">計上日</label></dt>
                            <dd><input type="date" id="modal-transaction-date" class="form-control" value="2025-09-30"></dd>

                            <dt><label for="modal-transaction-type" class="form-label">種別</label></dt>
                            <dd>
                                <select id="modal-transaction-type" class="form-control">
                                    <option value="売上" selected>売上</option>
                                    <option value="経費">経費</option>
                                    <option value="その他入金">その他入金</option>
                                    <option value="その他出金">その他出金</option>
                                </select>
                            </dd>

                            <dt><label for="modal-transaction-partner" class="form-label">取引先</label></dt>
                            <dd>
                                <select id="modal-transaction-partner" class="form-control">
                                    <option value="株式会社〇〇" selected>株式会社〇〇</option>
                                    <option value="△△デザイン">△△デザイン</option>
                                    <option value="NPO法人□□">NPO法人□□</option>
                                    <option value="光熱費">光熱費</option>
                                    <option value="消耗品店">消耗品店</option>
                                    </select>
                            </dd>

                            <dt><label for="modal-transaction-account" class="form-label">勘定科目</label></dt>
                             <dd>
                                <select id="modal-transaction-account" class="form-control">
                                    <option value="売上高" selected>売上高</option>
                                    <option value="水道光熱費">水道光熱費</option>
                                    <option value="消耗品費">消耗品費</option>
                                    <option value="雑収入">雑収入</option>
                                    <option value="支払手数料">支払手数料</option>
                                    </select>
                            </dd>

                            <dt><label for="modal-transaction-project" class="form-label">関連案件</label></dt>
                            <dd>
                                <select id="modal-transaction-project" class="form-control">
                                     <option value="">なし</option>
                                     <option value="Webサイト制作" selected>Webサイト制作 (株式会社〇〇)</option>
                                     <option value="ロゴデザイン">ロゴデザイン (△△デザイン)</option>
                                     <option value="データ入力">データ入力 (NPO法人□□)</option>
                                     </select>
                            </dd>

                            <dt><label for="modal-transaction-amount" class="form-label">金額（円）</label></dt>
                            <dd><input type="number" id="modal-transaction-amount" class="form-control" value="500000"></dd>

                            <dt><label for="modal-transaction-summary" class="form-label">摘要/備考</label></dt>
                            <dd><textarea id="modal-transaction-summary" class="form-control" rows="3">9月分請求</textarea></dd>
                        </dl>
                    </div>
                    <div class="modal-footer" style="display: flex; justify-content: space-between;">
                        <button type="button" class="button button-danger" onclick="alert('この取引を削除しますか？')">削除</button>
                        <div>
                            <button type="button" class="button button-secondary" onclick="closeModal('edit-transaction-modal')" style="margin-right: 0.5rem;">キャンセル</button>
                            <button type="button" class="button button-primary">保存</button>
                        </div>
                    </div>
                </div>
            </div>
            </main>
    </div>

    <script src="script.js"></script>

    <script>
        // 取引一覧の簡易フィルタリング関数
        function filterTransactions() {
            const dateStartInput = document.getElementById('search-transaction-date-start');
            const dateEndInput = document.getElementById('search-transaction-date-end');
            const typeSelect = document.getElementById('filter-transaction-type');
            const partnerSelect = document.getElementById('filter-transaction-partner');
            const keywordInput = document.getElementById('search-transaction-keyword');
            const tableBody = document.getElementById('transaction-list-tbody');

            if (!dateStartInput || !dateEndInput || !typeSelect || !partnerSelect || !keywordInput || !tableBody) {
                // console.warn("Filter elements or table body not found for transactions.");
                return;
            }

            const dateStartFilter = dateStartInput.value;
            const dateEndFilter = dateEndInput.value;
            const typeFilter = typeSelect.value;
            const partnerFilter = partnerSelect.value;
            const keywordFilter = keywordInput.value.toLowerCase();
            const rows = tableBody.getElementsByTagName('tr');

            Array.from(rows).forEach(row => {
                const dateData = row.dataset.date || '';
                const typeData = row.dataset.type || '';
                const partnerData = row.dataset.partner || '';
                const accountData = row.dataset.account?.toLowerCase() || ''; // 勘定科目もキーワード対象
                const projectData = row.dataset.project?.toLowerCase() || ''; // 案件名もキーワード対象
                const summaryData = row.dataset.summary?.toLowerCase() || ''; // 摘要もキーワード対象

                // 日付範囲チェック
                const dateMatch =
                    (!dateStartFilter || dateData >= dateStartFilter) &&
                    (!dateEndFilter || dateData <= dateEndFilter);

                const typeMatch = typeFilter === "" || typeData === typeFilter;
                const partnerMatch = partnerFilter === "" || partnerData === partnerFilter;

                // キーワードチェック (勘定科目, 案件名, 摘要)
                const keywordMatch = keywordFilter === "" ||
                                     accountData.includes(keywordFilter) ||
                                     projectData.includes(keywordFilter) ||
                                     summaryData.includes(keywordFilter);

                if (dateMatch && typeMatch && partnerMatch && keywordMatch) {
                    row.style.display = ''; // 表示
                } else {
                    row.style.display = 'none'; // 非表示
                }
            });
        }

        // 新規作成・編集モーダルを開く関数
        function openTransactionModal(rowData = null) {
            const modal = document.getElementById('edit-transaction-modal');
            if (!modal) return;

            // モーダル内の要素取得 (例)
            const dateInput = document.getElementById('modal-transaction-date');
            const typeSelect = document.getElementById('modal-transaction-type');
            const partnerSelect = document.getElementById('modal-transaction-partner');
            const accountSelect = document.getElementById('modal-transaction-account');
            const projectSelect = document.getElementById('modal-transaction-project');
            const amountInput = document.getElementById('modal-transaction-amount');
            const summaryTextarea = document.getElementById('modal-transaction-summary');
            const deleteButton = modal.querySelector('.button-danger'); // 削除ボタン

            if (rowData) {
                // 編集モード: データを行から取得してモーダルに設定
                dateInput.value = rowData.date || '';
                typeSelect.value = rowData.type || '';
                partnerSelect.value = rowData.partner || '';
                accountSelect.value = rowData.account || '';
                projectSelect.value = rowData.project || '';
                amountInput.value = rowData.amount || '';
                summaryTextarea.value = rowData.summary || '';
                if(deleteButton) deleteButton.style.display = ''; // 編集時は削除ボタン表示
            } else {
                // 新規作成モード: フォームをクリア (日付は今日など、必要に応じてデフォルト値設定)
                dateInput.valueAsDate = new Date(); // 今日
                typeSelect.value = '売上'; // デフォルト
                partnerSelect.value = '';
                accountSelect.value = '';
                projectSelect.value = '';
                amountInput.value = '';
                summaryTextarea.value = '';
                 if(deleteButton) deleteButton.style.display = 'none'; // 新規作成時は削除ボタン非表示
            }

            openModal('edit-transaction-modal'); // script.jsのグローバル関数を呼び出す
        }


        document.addEventListener('DOMContentLoaded', () => {
             // --- フィルタリングのイベントリスナー設定 ---
             if (typeof window.filterTransactions === 'function') {
                const dateStartListener = document.getElementById('search-transaction-date-start');
                const dateEndListener = document.getElementById('search-transaction-date-end');
                const typeSelectListener = document.getElementById('filter-transaction-type');
                const partnerSelectListener = document.getElementById('filter-transaction-partner');
                const keywordInputListener = document.getElementById('search-transaction-keyword');
                const clearButton = document.querySelector('#transactions .filter-form-inline .button-secondary'); // セレクタ修正

                // change または input イベントを適切に設定
                if(dateStartListener) dateStartListener.addEventListener('change', filterTransactions);
                if(dateEndListener) dateEndListener.addEventListener('change', filterTransactions);
                if(typeSelectListener) typeSelectListener.addEventListener('change', filterTransactions);
                if(partnerSelectListener) partnerSelectListener.addEventListener('change', filterTransactions);
                if(keywordInputListener) keywordInputListener.addEventListener('input', filterTransactions);

                if(clearButton) {
                    clearButton.addEventListener('click', () => {
                         const form = document.querySelector('#transactions .filter-form-inline'); // セレクタ修正
                         if (form) form.reset();
                         filterTransactions(); // フィルタリング実行
                    });
                }
                filterTransactions(); // 初期表示
            }

            // --- 行クリックで編集モーダル表示 ---
            const tableBody = document.getElementById('transaction-list-tbody');
            if (tableBody) {
                tableBody.addEventListener('click', (e) => {
                    const clickedRow = e.target.closest('tr.clickable-row');
                    if (clickedRow) {
                        openTransactionModal(clickedRow.dataset); // data属性を渡してモーダルを開く
                    }
                });
            }
        });
    </script>

</body>
</html>