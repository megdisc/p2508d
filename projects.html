<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>p2508d - 案件管理モックアップ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .skill-tag {
            display: inline-block;
            background-color: #e9ecef;
            color: #495057;
            padding: 0.2em 0.6em;
            margin: 0.2em;
            border-radius: 0.25rem;
            font-size: var(--font-size-xs);
        }
        .skill-selection-cell {
            min-height: 40px; 
            vertical-align: middle !important;
        }
        .skill-display-cell {
            text-align: left;
            vertical-align: middle !important;
            font-size: var(--font-size-sm);
        }
        .assignee-select-cell,
        .progress-table-cell {
             vertical-align: middle !important;
        }
        .assignee-type-display-cell {
             vertical-align: middle !important;
        }
         .cost-summary {
             text-align: right;
             font-size: var(--font-size-sm);
             margin-top: 1rem;
             padding-top: 1rem;
             border-top: 1px dashed var(--color-border);
         }
         .cost-summary strong {
             font-size: 1.1em;
             margin-left: 0.5rem;
         }
         .cost-summary .unallocated { color: var(--color-danger); }
         .cost-summary .profit { color: var(--color-primary); }
         .cost-summary .profit-plan { color: var(--color-text-secondary); }

         .filter-form-inline {
            display: flex;
            align-items: flex-end;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .filter-form-inline .form-group {
            margin-bottom: 0;
            flex-grow: 1;
        }
         .filter-form-inline .button-secondary {
             margin-bottom: 0;
             height: calc(1.5em + 1rem + 2px);
             flex-shrink: 0;
         }
        .chart-placeholder { text-align: center; padding: 4rem 1rem; background-color: var(--color-hover-bg); border: 1px dashed var(--color-border); border-radius: var(--border-radius); color: var(--color-text-secondary); font-size: var(--font-size-sm); }
        
        .section-divider {
            margin-top: 2rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.5rem;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }
        
        #progress-management-table .readonly-cell {
            text-align: left;
            padding: 0.5rem 0.75rem;
            font-size: var(--font-size-sm);
            vertical-align: middle;
        }
        #progress-management-table .calc-result-cell {
            text-align: right;
            padding: 0.5rem 0.75rem;
            font-weight: 700;
            color: var(--color-primary);
            vertical-align: middle;
        }
        #progress-management-table .form-control {
            text-align: right;
            width: 80px; /* 入力欄の幅を固定 */
            display: inline-block;
        }
        #progress-management-table .progress-delta-cell {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            text-align: right;
            padding-right: 1rem;
            width: 100px;
            vertical-align: middle; /* 垂直中央揃え */
        }
        #progress-management-table .progress-delta.positive {
            color: green;
        }
         #progress-management-table .progress-delta.negative {
            color: red;
        }
        #progress-management-table .assignee-type-cell {
             font-size: var(--font-size-sm);
             color: var(--color-text-primary);
             padding: 0.5rem 0.75rem;
             vertical-align: middle;
             text-align: left;
        }
        /* 貢献度セルのハイフン（-）のスタイル */
        #progress-management-table .contribution-placeholder {
            text-align: center;
            color: var(--color-text-secondary);
        }

        #select-skill-modal .modal-content {
            max-width: 800px;
        }
        .skill-modal-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 1.5rem;
            min-height: 400px;
        }
        .skill-modal-filters {
            border-right: 1px solid var(--color-border);
            padding-right: 1.5rem;
        }
        .skill-modal-list .table-wrapper {
            max-height: 300px;
            overflow-y: auto;
        }
        .skill-modal-list .table th:first-child,
        .skill-modal-list .table td:first-child {
            width: 50px; /* チェックボックス列 */
        }
        .skill-modal-list .table th:nth-child(4),
        .skill-modal-list .table td:nth-child(4) {
             width: 140px; /* レベル選択プルダウン用 */
        }
        .skill-modal-selected {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }
        .skill-modal-selected h4 {
            font-size: var(--font-size-sm);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .skill-modal-list .form-control {
            padding: 0.25rem 0.5rem;
            font-size: var(--font-size-xs);
            width: 100%;
        }
        .budget-summary-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 0.75rem 1rem;
            align-items: center;
            font-size: var(--font-size-sm);
        }
        .budget-summary-grid dt {
            font-weight: 600;
            text-align: right;
            color: var(--color-text-secondary);
        }
        .budget-summary-grid dd {
            font-weight: 600;
            text-align: right;
            font-size: 1.1em;
            margin: 0;
        }
        .budget-summary-grid dt.sub-item {
             padding-left: 2rem;
             font-weight: 500;
             color: var(--color-text-secondary);
        }
        .budget-summary-grid dd.sub-item {
             font-size: 1.0em;
             font-weight: 500;
        }
        
        .budget-summary-grid dd.total-profit-plan {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--color-primary);
            padding: 0.5rem 0;
            border-top: 1px dashed var(--color-border);
            border-bottom: 1px dashed var(--color-border);
            margin: 0.5rem 0;
        }

        /* ▼▼▼ スケジュール・アサインタブ用 ▼▼▼ */
        .assign-display-cell,
        .period-display-cell,
        .assignee-display-cell {
            vertical-align: middle !important;
            text-align: left;
        }
        .assign-display-list {
            list-style-type: none;
            padding: 0;
            margin: 0;
            /* ▼▼▼ 修正: フォントサイズをxsからsmに変更 ▼▼▼ */
            font-size: var(--font-size-sm);
            /* ▲▲▲ 修正 ▲▲▲ */
        }
        .assign-display-list li {
            margin-bottom: 0.25rem;
        }
        
        #schedule-assign-table-body tr {
             cursor: pointer;
             transition: background-color 0.2s;
        }
        #schedule-assign-table-body tr:hover {
             background-color: var(--color-hover-bg);
        }
        
        /* アサイン編集モーダル */
        #edit-schedule-assign-modal .modal-content {
            max-width: 800px;
        }
        #schedule-assign-modal-table th:nth-child(1), /* 担当者 */
        #schedule-assign-modal-table td:nth-child(1) {
            width: 200px;
        }
        #schedule-assign-modal-table th:nth-child(2), /* 開始日 */
        #schedule-assign-modal-table td:nth-child(2) {
            width: 140px;
        }
        #schedule-assign-modal-table th:nth-child(3), /* 終了日 */
        #schedule-assign-modal-table td:nth-child(3) {
            width: 140px;
        }
        #schedule-assign-modal-table .col-actions { /* 操作 */
            width: 80px;
        }
        /* ▲▲▲ スタイル追加ここまで ▲▲▲ */

    </style>
</head>
<body>
    <div class="mockup-container">
        <header class="header">
            <div>
                <h1 class="header-logo"><a href="dashboard.html">p2508d</a></h1>
            </div>

            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="dashboard.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="daily_records.html" class="nav-link">日々の記録</a></li>
                    <li><a href="members_menu.html" class="nav-link">利用者支援</a></li>
                    <li><a href="production_menu.html" class="nav-link">生産活動</a></li>
                    <li><a href="staff_menu.html" class="nav-link">施設と職員</a></li>
                    <li><a href="accounting_menu.html" class="nav-link">会計</a></li>
                    <li><a href="claims.html" class="nav-link">国保連請求</a></li>
                    <li><a href="analytics_menu.html" class="nav-link">データ分析</a></li>
                    <li><a href="settings.html" class="nav-link">設定</a></li>
                    <li><a href="my_page.html" class="nav-link">マイページ</a></li>
                </ul>
                <div class="nav-logout-section">
                    <a href="index.html" class="nav-link">ログアウト</a>
                </div>
            </nav>
        </header>

        <main class="mockup-main">
            <div id="projects" class="mockup-page active">
                <div class="list-page-header">
                    <h1 class="page-title">案件一覧</h1>
                     <div>
                         <a href="production_menu.html" class="button button-secondary" style="margin-right: 0.5rem;">生産活動メニューへ</a>
                         <button class="button button-primary" onclick="alert('新規案件作成画面へ遷移します')">＋ 新規作成</button>
                    </div>
                </div>

                <div class="section">
                    <form class="section-content filter-form-inline" style="margin-bottom: 1.5rem;">
                        <div class="form-group" style="flex-grow: 1.5;">
                            <label for="search-project-name" class="form-label">案件名</label>
                            <input type="text" id="search-project-name" class="form-control" placeholder="案件名で検索...">
                        </div>
                        <div class="form-group" style="flex-grow: 1.5;">
                            <label for="search-client-name" class="form-label">クライアント名</label>
                            <input type="text" id="search-client-name" class="form-control" placeholder="クライアント名で検索...">
                        </div>
                        <div class="form-group">
                            <label for="filter-project-status" class="form-label">ステータス</label>
                            <select id="filter-project-status" class="form-control">
                                <option value="">すべて</option>
                                <option value="未着手">未着手</option>
                                <option value="作業中">作業中</option>
                                <option value="完了">完了</option>
                                <option value="納品済">納品済</option>
                                <option value="キャンセル">キャンセル</option>
                            </select>
                        </div>
                        <button type="button" class="button button-secondary">クリア</button>
                    </form>

                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>案件名</th>
                                    <th>クライアント名</th>
                                    <th>ステータス</th>
                                    <th>納期</th>
                                </tr>
                            </thead>
                             <tbody id="project-list-tbody">
                                <tr class="clickable-row" onclick="showPage('project-detail')">
                                    <td>A社 DM封入作業</td>
                                    <td>株式会社A</td>
                                    <td>作業中</td>
                                    <td>2025.10.31</td>
                                </tr>
                                <tr class="clickable-row" onclick="showPage('project-detail')">
                                    <td>B社 部品組み立て</td>
                                    <td>有限会社B</td>
                                    <td>完了</td>
                                    <td>2025.09.30</td>
                                </tr>
                                 <tr class="clickable-row" onclick="showPage('project-detail')">
                                    <td>C社 データ入力</td>
                                    <td>C-Tech</td>
                                    <td>納品済</td>
                                    <td>2025.09.15</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="project-detail" class="mockup-page">
                <div class="list-page-header">
                    <h1 class="page-title">A社 DM封入作業</h1> <div>
                        <button class="button button-secondary" style="margin-right: 0.5rem;" onclick="showPage('projects')">一覧へ戻る</button>
                        <button type="button" class="button button-danger" onclick="alert('「A社 DM封入作業」のデータを削除します。よろしいですか？')">削除</button>
                    </div>
                </div>

                <div class="sub-nav">
                    <ul id="project-detail-subnav">
                        <li><a href="#" class="sub-nav-item active" data-tab="tab-project-overview">基本情報</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-task-definition">タスク定義</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-budget">予算配分</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-schedule-assign">スケジュール・アサイン</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-progress">進捗管理</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-delivery">納品・請求</a></li>
                    </ul>
                </div>
                <div class="tab-content-wrapper">
                    <div id="tab-project-overview" class="tab-content active">
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title-in-header">基本情報</h2>
                                <button class="button button-primary" onclick="openModal('edit-project-basic-modal')">編集</button>
                            </div>
                            <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>案件名</dt><dd>A社 DM封入作業</dd>
                                    <dt>顧客</dt><dd>株式会社A</dd>
                                    <dt>ステータス</dt><dd>作業中</dd>
                                    <dt>担当職員</dt><dd>支援員 次郎</dd>
                                    <dt>受注日</dt><dd>2025年10月1日</dd>
                                    <dt>納期</dt><dd>2025年10月31日</dd>
                                    <dt style="align-self: start;">概要</dt>
                                    <dd id="project-summary-display" style="white-space: pre-wrap; align-self: start;">チラシ、挨拶状、返信用封筒の3点をまとめて封入する。宛名ラベルを貼付後、指定の箱に500部ずつ梱包する。</dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <div id="tab-project-task-definition" class="tab-content">
                         <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">タスク定義</h2>
                                <button type="button" class="button button-primary" id="add-task-definition-row">＋ タスクを追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="task-definition-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th>作業指示/備考</th>
                                            <th style="width: 250px;">必要スキル</th>
                                            <th style="width: 150px;">担当者種別</th> 
                                            <th class="col-actions">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-definition-table-body">
                                         <tr data-task-id="task-static-1">
                                            <td><input type="text" class="form-control task-name-input" value="チラシ折り"></td>
                                            <td><input type="text" class="form-control" value="三つ折りにする"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">軽作業 Lv.1</span>
                                                    <span class="skill-tag">集中力 Lv.1</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="openModal('select-skill-modal')">スキル選択</button>
                                            </td>
                                            <td>
                                                <select class="form-control assignee-type-select" style="width: 100px; font-size: var(--font-size-sm);">
                                                    <option value="member" selected>利用者</option>
                                                    <option value="staff">職員</option>
                                                    <option value="partner">外注先</option>
                                                    <option value="customer">顧客</option>
                                                </select>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                         <tr data-task-id="task-static-2">
                                            <td><input type="text" class="form-control task-name-input" value="封入"></td>
                                            <td><input type="text" class="form-control" value="チラシ、挨拶状、返信用封筒を封入"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">軽作業 Lv.1</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="openModal('select-skill-modal')">スキル選択</button>
                                            </td>
                                            <td>
                                                <select class="form-control assignee-type-select" style="width: 100px; font-size: var(--font-size-sm);">
                                                    <option value="member">利用者</option>
                                                    <option value="staff" selected>職員</option>
                                                    <option value="partner">外注先</option>
                                                    <option value="customer">顧客</option>
                                                </select>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr data-task-id="task-static-3">
                                            <td><input type="text" class="form-control task-name-input" value="宛名貼り"></td>
                                            <td><input type="text" class="form-control" value="指定のラベルを貼付"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">PC基本操作 Lv.1</span>
                                                    <span class="skill-tag">正確性 Lv.2</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="openModal('select-skill-modal')">スキル選択</button>
                                            </td>
                                            <td>
                                                <select class="form-control assignee-type-select" style="width: 100px; font-size: var(--font-size-sm);">
                                                    <option value="member">利用者</option>
                                                    <option value="staff">職員</option>
                                                    <option value="partner" selected>外注先</option>
                                                    <option value="customer">顧客</option>
                                                </select>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                             <div class="section-footer">
                                <button type="button" class="button button-primary">タスク定義を保存</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-project-budget" class="tab-content">
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">総収益見込み</h2>
                                <button type="button" class="button button-primary" id="add-revenue-row-budget-plan">＋ 収益を追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="revenue-table-budget-plan">
                                    <thead>
                                        <tr>
                                            <th>収益項目</th>
                                            <th>摘要</th>
                                            <th style="width: 150px;">金額(円)</th>
                                            <th class="col-actions">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="revenue-table-body-budget-plan">
                                        <tr>
                                            <td>
                                                <select class="form-control" style="width: 100%; font-size: var(--font-size-sm);">
                                                    <option value="sales" selected>生産活動収入 (売上)</option>
                                                    <option value="grant">助成金</option>
                                                    <option value="other">その他</option>
                                                </select>
                                            </td>
                                            <td><input type="text" class="form-control" value="DM封入作業 受注分"></td>
                                            <td><input type="number" class="form-control revenue-amount-input-plan" value="100000"></td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr style="font-weight: bold; background-color: var(--color-hover-bg);">
                                            <td colspan="2" style="text-align: right;">総収益 見込み (A)</td>
                                            <td style="text-align: right;" id="summary-revenue-plan-footer">100,000</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                         <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">総費用見込み（タスク）</h2>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="budget-allocation-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th style="width: 150px;">担当者種別</th>
                                            <th style="width: 150px;">分配額(円)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="budget-allocation-table-body">
                                    </tbody>
                                    <tfoot>
                                        <tr style="font-weight: bold; background-color: var(--color-hover-bg);">
                                            <td colspan="2" style="text-align: right;">タスク費用 合計 (B-1)</td>
                                            <td style="text-align: right;" id="summary-allocated-plan-footer">0</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">総費用見込み（その他経費）</h2>
                                <button type="button" class="button button-primary" id="add-expense-row-budget-plan">＋ 経費予算を追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="expense-table-budget-plan">
                                    <thead><tr><th>費目</th><th>内容</th><th>金額(円)</th><th class="col-actions">操作</th></tr></thead>
                                    <tbody id="expense-table-body-budget-plan">
                                        <tr>
                                            <td>
                                                <select class="form-control" style="width: 100%; font-size: var(--font-size-sm);">
                                                    <option value="material" selected>材料費</option>
                                                    <option value="consumables">消耗品費</option>
                                                    <option value="shipping">発送費</option>
                                                    <option value="other">その他経費</option>
                                                </select>
                                            </td>
                                            <td><input type="text" class="form-control" value="封筒・ラベル代 (見込み)"></td>
                                            <td><input type="number" class="form-control expense-amount-input-plan" value="4500"></td>
                                            <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                                        </tr>
                                    </tbody>
                                    <tfoot>
                                        <tr style="font-weight: bold; background-color: var(--color-hover-bg);">
                                            <td colspan="2" style="text-align: right;">その他経費 合計 (B-2)</td>
                                            <td style="text-align: right;" id="summary-other-expense-plan-footer">4,500</td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <div class="section">
                             <h2 class="section-title">収支計画サマリー</h2>
                             <div class="section-content">
                                <dl class="budget-summary-grid">
                                    <dt>総収益 見込み (A)</dt>
                                    <dd id="summary-revenue-plan">100,000 円</dd>
                                    
                                    <dt>総費用 見込み (B)</dt>
                                    <dd id="summary-total-cost-plan">64,500 円</dd>
                                    
                                    <dt class="sub-item">└ タスク費用 (B-1)</dt>
                                    <dd class="sub-item" id="summary-allocated-plan">60,000 円</dd>
                                    
                                    <dt class="sub-item">└ その他経費 (B-2)</dt>
                                    <dd class="sub-item" id="summary-other-expense-plan">4,500 円</dd>
                                    
                                    <dt>計画利益 (A - B)</dt>
                                    <dd class="total-profit-plan" id="summary-planned-profit">35,500 円</dd>
                                </dl>
                             </div>
                        </div>
                        
                         <div class="section-footer">
                            <button type="button" class="button button-primary">予算計画を保存</button>
                        </div>
                    </div>

                    <div id="tab-project-schedule-assign" class="tab-content">
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">スケジュール・アサイン</h2>
                                <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">※行をクリックして編集</span>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="schedule-assign-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th style="width: 120px;">担当者種別</th>
                                            <th>担当者</th>
                                            <th style="width: 220px;">期間</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schedule-assign-table-body">
                                        </tbody>
                                </table>
                                </div>
                             <div class="section-footer">
                            </div>
                            </div>
                    </div>


                    <div id="tab-project-progress" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">進捗管理</h2>
                             <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                                 <label for="progress-month-select-progress" class="form-label" style="margin-bottom: 0;">対象月:</label>
                                 <input type="month" id="progress-month-select-progress" class="form-control" value="2025-10" style="width: auto;">
                             </div>
                            <div class="table-wrapper">
                                <table class="table" id="progress-management-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th>担当者</th>
                                            <th>担当者種別</th>
                                            <th>進捗率(%)</th>
                                            <th>先月比(%)</th>
                                            <th>貢献度(%)</th>
                                            <th>インセンティブ(円)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="progress-management-table-body">
                                        </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="section">
                            <h2 class="section-title">進捗サマリー（ガントチャート）</h2>
                            <div class="section-content">
                                <div class="chart-placeholder">（「スケジュール・アサイン」タブの予定期間と「進捗管理」タブの進捗率に基づいたガントチャートがここに表示されます）</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">その他経費（実績）</h2>
                                <button type="button" class="button button-primary" id="add-expense-row-actual">＋ 経費実績を追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="expense-table-actual">
                                    <thead><tr><th>日付</th><th>費目</th><th>内容</th><th>金額(円)</th><th class="col-actions">操作</th></tr></thead>
                                    <tbody id="expense-table-body-actual">
                                        <tr>
                                            <td><input type="date" class="form-control" value="2025-10-02"></td>
                                            <td><input type="text" class="form-control" value="材料費"></td>
                                            <td><input type="text" class="form-control" value="封筒・ラベル代"></td>
                                            <td><input type="number" class="form-control expense-amount-input-actual" value="5000"></td>
                                            <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="cost-summary" id="actual-revenue-summary">
                            <span>受注金額: <strong id="summary-revenue-actual">100,000</strong>円</span> |
                            <span>その他経費実績: <strong id="summary-other-expense-actual">5,000</strong>円</span> |
                            <span class="profit">実績利益: <strong id="summary-actual-profit">0</strong>円</span>
                        </div>

                        <div class="section-footer">
                            <button type="button" class="button button-primary">進捗管理情報を保存</button>
                        </div>
                    </div>

                    <div id="tab-project-delivery" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">納品情報</h2>
                             <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>納品日</dt>
                                    <dd>
                                        <input type="date" id="delivery-date" class="form-control"> <button type="button" class="button button-clear" id="clear-delivery-date">クリア</button>
                                    </dd>
                                    <dt>納品ステータス</dt>
                                    <dd><span id="delivery-status-text">未納品</span></dd>
                                </dl>
                            </div>
                        </div>
                        <div class="section">
                            <h2 class="section-title">請求情報</h2>
                             <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>請求日</dt>
                                    <dd>
                                        <input type="date" id="billing-date" class="form-control"> <button type="button" class="button button-clear" id="clear-billing-date">クリア</button>
                                    </dd>
                                    <dt>入金ステータス</dt>
                                    <dd><span id="payment-status-text">未請求</span></dd>
                                </dl>
                            </div>
                        </div>
                        <div class="section-footer">
                            <button type="button" class="button button-primary">納品・請求情報を保存</button>
                        </div>
                    </div>

                </div>
            </div>

            <div id="edit-project-basic-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">案件 基本情報編集</h2>
                        <span class="modal-close" onclick="closeModal('edit-project-basic-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-project-name" class="form-label">案件名</label>
                            <input type="text" id="edit-project-name" class="form-control" value="A社 DM封入作業">
                        </div>
                        <div class="form-group">
                             <label for="edit-project-client" class="form-label">顧客</label>
                             <select id="edit-project-client" class="form-control">
                                 <option value="client-a" selected>株式会社A</option>
                                 <option value="client-b">有限会社B</option>
                                 <option value="client-c">C-Tech</option>
                                 <option value="partner-d">□□商事</option>
                             </select>
                        </div>
                         <div class="form-group">
                            <label for="edit-project-status" class="form-label">ステータス</label>
                            <select id="edit-project-status" class="form-control">
                                <option value="未着手">未着手</option>
                                <option value="作業中" selected>作業中</option>
                                <option value="完了">完了</option>
                                <option value="納品済">納品済</option>
                                <option value="キャンセル">キャンセル</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-project-staff" class="form-label">担当職員</label>
                             <select id="edit-project-staff" class="form-control">
                                 <option value="staff-taro">管理者 太郎</option>
                                 <option value="staff-jiro" selected>支援員 次郎</option>
                                 <option value="staff-saburo">職業指導員 三郎</option>
                             </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-project-order-date" class="form-label">受注日</label>
                            <input type="date" id="edit-project-order-date" class="form-control" value="2025-10-01">
                        </div>
                        <div class="form-group">
                            <label for="edit-project-due-date" class="form-label">納期</label>
                            <input type="date" id="edit-project-due-date" class="form-control" value="2025-10-31">
                        </div>
                         <div class="form-group">
                            <label for="edit-project-summary-textarea" class="form-label">概要</label>
                            <textarea id="edit-project-summary-textarea" class="form-control" rows="5">チラシ、挨拶状、返信用封筒の3点をまとめて封入する。宛名ラベルを貼付後、指定の箱に500部ずつ梱包する。</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button button-secondary" onclick="closeModal('edit-project-basic-modal')">キャンセル</button>
                        <button type="button" class="button button-primary">保存</button>
                    </div>
                </div>
            </div>

            <div id="select-skill-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">必要スキル選択（タスク名: ...）</h2>
                        <span class="modal-close" onclick="closeModal('select-skill-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="skill-modal-layout">
                            <div class="skill-modal-filters">
                                <div class="form-group">
                                    <label for="skill-modal-search-name" class="form-label">スキル名検索</label>
                                    <input type="text" id="skill-modal-search-name" class="form-control" placeholder="スキル名...">
                                </div>
                                <div class="form-group">
                                    <label for="skill-modal-search-category" class="form-label">カテゴリ</label>
                                    <select id="skill-modal-search-category" class="form-control">
                                        <option value="">すべて</option>
                                        <option value="pc">PC基本操作</option>
                                        <option value="office">Officeソフト</option>
                                        <option value="work">軽作業</option>
                                        <option value="business">ビジネスマナー</option>
                                    </select>
                                </div>
                            </div>
                            <div class="skill-modal-list">
                                <div class="table-wrapper">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox"></th>
                                                <th>スキル名</th>
                                                <th>カテゴリ</th>
                                                <th>レベル</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><input type="checkbox"></td>
                                                <td style="text-align: left;">タイピング (かな)</td>
                                                <td>PC基本操作</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1">Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox" checked></td>
                                                <td style="text-align: left;">Word (基本文書作成)</td>
                                                <td>Officeソフト</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1" selected>Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox" checked></td>
                                                <td style="text-align: left;">軽作業 (梱包)</td>
                                                <td>軽作業</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1" selected>Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox"></td>
                                                <td style="text-align: left;">電話応対</td>
                                                <td>ビジネスマナー</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1">Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox"></td>
                                                <td style="text-align: left;">Excel (SUM関数)</td>
                                                <td>Officeソフト</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1">Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="skill-modal-selected">
                                    <h4>選択中のスキル</h4>
                                    <div>
                                        <span class="skill-tag">Word (基本文書作成) - Lv.1</span>
                                        <span class="skill-tag">軽作業 (梱包) - Lv.1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button button-secondary" onclick="closeModal('select-skill-modal')">キャンセル</button>
                        <button type="button" class="button button-primary">決定</button>
                    </div>
                </div>
            </div>

            <div id="edit-schedule-assign-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">スケジュール・アサイン編集 (<span id="modal-task-name-display">タスク名</span>)</h2>
                        <span class="modal-close" onclick="closeModal('edit-schedule-assign-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="list-page-header" style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--color-border);">
                            <h3 class="section-title" style="margin: 0; border: none; font-size: 1.1rem;">担当と期間</h3>
                            <button type="button" class="button button-primary" id="modal-schedule-assign-add-row-button">＋ アサイン追加</button>
                        </div>
                        <div class="table-wrapper">
                            <table class="table" id="schedule-assign-modal-table">
                                <thead>
                                    <tr>
                                        <th>担当者</th>
                                        <th>予定開始日</th>
                                        <th>予定終了日</th>
                                        <th class="col-actions">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="schedule-assign-modal-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button button-secondary" onclick="closeModal('edit-schedule-assign-modal')">キャンセル</button>
                        <button type="button" class="button button-primary" id="modal-schedule-assign-save-button" data-task-id="">保存</button>
                    </div>
                </div>
            </div>


            <template id="task-definition-row-template">
                <tr data-task-id=""> <td><input type="text" class="form-control task-name-input" placeholder="新規タスク名"></td>
                    <td><input type="text" class="form-control" placeholder="作業指示や備考を入力"></td>
                    <td class="skill-selection-cell">
                        <div></div>
                        <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="openModal('select-skill-modal')">スキル選択</button>
                    </td>
                    <td>
                        <select class="form-control assignee-type-select" style="width: 100px; font-size: var(--font-size-sm);">
                            <option value="member" selected>利用者</option>
                            <option value="staff">職員</option>
                            <option value="partner">外注先</option>
                            <option value="customer">顧客</option>
                        </select>
                    </td>
                    <td class="col-actions">
                        <div class="table-button-group">
                            <button type="button" class="button button-danger">削除</button>
                        </div>
                    </td>
                </tr>
            </template>
            
            <template id="schedule-assign-task-row-template">
                 <tr> 
                    <td class="task-name-readonly" style="text-align: left; padding-left: 0.75rem; font-weight: 500;">（タスク名）</td>
                    <td class="assignee-type-display-cell" style="font-size: var(--font-size-sm); text-align: left; padding-left: 1rem;">
                        （種別）
                    </td>
                    <td class="assignee-display-cell">
                        <ul class="assign-display-list">
                            </ul>
                    </td>
                    <td class="period-display-cell">
                        <ul class="assign-display-list">
                            </ul>
                    </td>
                </tr>
             </template>
             <template id="budget-allocation-row-template">
                 <tr>
                    <td style="text-align: left;" class="task-name-readonly">（タスク名）</td>
                    <td class="assignee-type-display-cell">
                        <span class="readonly-text" data-field="assigneeType" style="font-size: var(--font-size-sm); padding-left: 0.75rem;">（未設定）</span>
                    </td>
                    <td><input type="number" class="form-control budget-allocation-input" placeholder="0"></td>
                </tr>
            </template>
             
             <template id="progress-management-row-template">
                 <tr>
                    <td class="readonly-cell" data-field="taskName">（タスク名）</td>
                    <td class="readonly-cell" data-field="assigneeName">（担当者）</td>
                    <td class="assignee-type-cell" data-field="assigneeType">（種別）</td>
                    <td class="progress-table-cell">
                        <input type="number" class="form-control progress-rate-input" placeholder="0" min="0" max="100">
                    </td>
                    <td class="progress-delta-cell">
                        <span class="progress-delta"></span>
                    </td>
                    <td class="progress-table-cell" data-field="contribution-cell">
                        </td>
                    <td class="calc-result-cell" data-field="calculatedIncentive">0</td>
                </tr>
             </template>

            <template id="revenue-row-template-plan">
                 <tr>
                    <td>
                        <select class="form-control" style="width: 100%; font-size: var(--font-size-sm);">
                            <option value="sales" selected>生産活動収入 (売上)</option>
                            <option value="grant">助成金</option>
                            <option value="other">その他</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control" placeholder="摘要"></td>
                    <td><input type="number" class="form-control revenue-amount-input-plan" value="0"></td>
                    <td class="col-actions">
                        <div class="table-button-group">
                            <button type="button" class="button button-danger">削除</button>
                        </div>
                    </td>
                </tr>
            </template>

             <template id="expense-row-template-plan">
                <tr>
                    <td>
                        <select class="form-control" style="width: 100%; font-size: var(--font-size-sm);">
                            <option value="material" selected>材料費</option>
                            <option value="consumables">消耗品費</option>
                            <option value="shipping">発送費</option>
                            <option value="other">その他経費</option>
                        </select>
                    </td>
                    <td><input type="text" class="form-control" placeholder="内容"></td>
                    <td><input type="number" class="form-control expense-amount-input-plan" placeholder="0"></td>
                    <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                </tr>
            </template>
             <template id="expense-row-template-actual">
                <tr>
                    <td><input type="date" class="form-control" value=""></td>
                    <td><input type="text" class="form-control" placeholder="例: 交通費"></td>
                    <td><input type="text" class="form-control" placeholder="内容"></td>
                    <td><input type="number" class="form-control expense-amount-input-actual" placeholder="0"></td>
                    <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                </tr>
            </template>
            
            <template id="schedule-assign-modal-row-template">
                <tr data-assignment-id="">
                    <td>
                        <select class="form-control modal-assignee-select-edit" style="width: 100%; font-size: var(--font-size-sm);">
                            </select>
                    </td>
                    <td>
                        <input type="date" class="form-control modal-start-date-edit" style="width: 100%; font-size: var(--font-size-sm);">
                    </td>
                    <td>
                        <input type="date" class="form-control modal-end-date-edit" style="width: 100%; font-size: var(--font-size-sm);">
                    </td>
                    <td class="col-actions">
                        <div class="table-button-group">
                            <button type="button" class="button button-danger modal-assign-delete-button">削除</button>
                        </div>
                    </td>
                </tr>
            </template>

        </main>
    </div>

    <script src="script.js"></script>

    <script>
        // ▼▼▼ 修正: モックデータ（複数アサイン） ▼▼▼
        let mockScheduleData = {
            "task-static-1": [ // チラシ折り
                { id: "assign-1a", assigneeId: "member:A001", assigneeName: "青木 誠", type: "利用者", startDate: "2025-10-01", endDate: "2025-10-05" },
                { id: "assign-1b", assigneeId: "member:A002", assigneeName: "五十嵐 直人", type: "利用者", startDate: "2025-10-06", endDate: "2025-10-10" }
            ],
            "task-static-2": [ // 封入
                { id: "assign-2", assigneeId: "staff:S002", assigneeName: "支援員 次郎", type: "職員", startDate: "2025-10-11", endDate: "2025-10-25" }
            ],
            "task-static-3": [ // 宛名貼り
                { id: "assign-3", assigneeId: "partner:P001", assigneeName: "〇〇印刷", type: "外注先", startDate: "2025-10-26", endDate: "2025-10-31" }
            ]
        };
        // ▲▲▲ 修正 ▲▲▲

        function filterProjects() {
            const nameInput = document.getElementById('search-project-name');
            const clientInput = document.getElementById('search-client-name');
            const statusSelect = document.getElementById('filter-project-status');
            const tableBody = document.getElementById('project-list-tbody');

            if (!nameInput || !clientInput || !statusSelect || !tableBody) return;

            const nameFilter = nameInput.value.toLowerCase();
            const clientFilter = clientInput.value.toLowerCase();
            const statusFilter = statusSelect.value;
            const rows = tableBody.getElementsByTagName('tr');

            Array.from(rows).forEach(row => {
                const projectName = row.cells[0]?.textContent.toLowerCase() || '';
                const clientName = row.cells[1]?.textContent.toLowerCase() || '';
                const status = row.cells[2]?.textContent || '';

                const nameMatch = projectName.includes(nameFilter);
                const clientMatch = clientName.includes(clientFilter);
                const statusMatch = statusFilter === "" || status === statusFilter;

                row.style.display = (nameMatch && clientMatch && statusMatch) ? '' : 'none';
            });
        }

        function updateBudgetSummary() {
            const revenueTbody = document.getElementById('revenue-table-body-budget-plan'); 
            const budgetAllocationTbody = document.getElementById('budget-allocation-table-body');
            const expensePlanTbody = document.getElementById('expense-table-body-budget-plan');
            
            const summaryRevenuePlan = document.getElementById('summary-revenue-plan');
            const summaryTotalCostPlan = document.getElementById('summary-total-cost-plan');
            const summaryAllocatedPlan = document.getElementById('summary-allocated-plan');
            
            const summaryOtherExpensePlan = document.getElementById('summary-other-expense-plan');
            const summaryPlannedProfit = document.getElementById('summary-planned-profit');
            
            const summaryRevenuePlanFooter = document.getElementById('summary-revenue-plan-footer');
            const summaryAllocatedPlanFooter = document.getElementById('summary-allocated-plan-footer');
            const summaryOtherExpensePlanFooter = document.getElementById('summary-other-expense-plan-footer');

            if (!revenueTbody || !budgetAllocationTbody || !expensePlanTbody || !summaryRevenuePlan || !summaryTotalCostPlan || !summaryAllocatedPlan || !summaryOtherExpensePlan || !summaryPlannedProfit || !summaryRevenuePlanFooter || !summaryAllocatedPlanFooter || !summaryOtherExpensePlanFooter) {
                console.warn('Budget summary elements missing.');
                return;
            }

            let totalRevenue = 0;
            revenueTbody.querySelectorAll('.revenue-amount-input-plan').forEach(input => {
                totalRevenue += parseFloat(input.value) || 0;
            });

            let totalAllocatedPlan = 0;
            budgetAllocationTbody.querySelectorAll('.budget-allocation-input').forEach(input => {
                totalAllocatedPlan += parseFloat(input.value) || 0;
            });

            let totalExpensePlan = 0;
            expensePlanTbody.querySelectorAll('.expense-amount-input-plan').forEach(input => {
                totalExpensePlan += parseFloat(input.value) || 0;
            });

            let totalCostPlan = totalAllocatedPlan + totalExpensePlan;
            let plannedProfit = totalRevenue - totalCostPlan;

            summaryRevenuePlanFooter.textContent = totalRevenue.toLocaleString();
            summaryAllocatedPlanFooter.textContent = totalAllocatedPlan.toLocaleString();
            summaryOtherExpensePlanFooter.textContent = totalExpensePlan.toLocaleString();

            summaryRevenuePlan.textContent = totalRevenue.toLocaleString() + ' 円';
            summaryTotalCostPlan.textContent = totalCostPlan.toLocaleString() + ' 円';
            summaryAllocatedPlan.textContent = totalAllocatedPlan.toLocaleString() + ' 円';
            
            summaryOtherExpensePlan.textContent = totalExpensePlan.toLocaleString() + ' 円';
            summaryPlannedProfit.textContent = plannedProfit.toLocaleString() + ' 円';
        }

        function updateActualSummary() {
            const revenueTbody = document.getElementById('revenue-table-body-budget-plan'); 
            const expenseActualTbody = document.getElementById('expense-table-body-actual');
            const summaryRevenueActual = document.getElementById('summary-revenue-actual');
            const summaryOtherExpenseActual = document.getElementById('summary-other-expense-actual');
            const summaryActualProfit = document.getElementById('summary-actual-profit');

            if (!revenueTbody || !expenseActualTbody || !summaryRevenueActual || !summaryOtherExpenseActual || !summaryActualProfit) {
                console.warn('Actual summary elements missing.');
                return;
            }

            let totalRevenue = 0;
             revenueTbody.querySelectorAll('.revenue-amount-input-plan').forEach(input => {
                totalRevenue += parseFloat(input.value) || 0;
            });

            let totalExpenseActual = 0;
            expenseActualTbody.querySelectorAll('.expense-amount-input-actual').forEach(input => {
                totalExpenseActual += parseFloat(input.value) || 0;
            });

            let actualProfit = totalRevenue - totalExpenseActual;

            summaryRevenueActual.textContent = totalRevenue.toLocaleString() + ' 円';
            summaryOtherExpenseActual.textContent = totalExpenseActual.toLocaleString() + ' 円';
            summaryActualProfit.textContent = actualProfit.toLocaleString() + ' 円';
        }

        function getTaskDefinitions() {
            const definitionTbody = document.getElementById('task-definition-table-body');
            if (!definitionTbody) return [];

            const tasks = [];
            const rows = definitionTbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                let taskId = row.dataset.taskId; 
                if (!taskId) { 
                    taskId = `task-${Date.now()}-${index}`; 
                    row.dataset.taskId = taskId; 
                }
                
                const nameInput = row.querySelector('.task-name-input');
                const skillCell = row.querySelector('.skill-selection-cell > div'); 
                const typeSelect = row.querySelector('.assignee-type-select'); 
                
                const skillsHtml = skillCell ? skillCell.innerHTML : ''; 
                const assigneeType = typeSelect ? typeSelect.value : 'member'; 

                tasks.push({
                    id: taskId, 
                    name: nameInput ? nameInput.value : `タスク ${index + 1}`,
                    requiredSkillsHtml: skillsHtml,
                    assigneeType: assigneeType 
                });
            });
            return tasks;
        }
        
        function getBudgetData() {
            const budgetTbody = document.getElementById('budget-allocation-table-body');
            if (!budgetTbody) return {};
            
            const budgetMap = {};
            budgetTbody.querySelectorAll('tr').forEach(row => {
                const taskName = row.querySelector('.task-name-readonly')?.textContent;
                const budgetInput = row.querySelector('.budget-allocation-input');
                if (taskName && budgetInput) {
                    budgetMap[taskName] = parseFloat(budgetInput.value) || 0;
                }
            });
            return budgetMap;
        }

        function getScheduleAssignData() {
            const assignments = [];
            
            for (const taskId in mockScheduleData) {
                const taskAssignments = mockScheduleData[taskId];
                const tasks = getTaskDefinitions();
                const task = tasks.find(t => t.id === taskId);
                
                if (task && taskAssignments) {
                    taskAssignments.forEach(assign => {
                        assignments.push({
                            taskId: task.id,
                            taskName: task.name,
                            assigneeId: assign.assigneeId,
                            assigneeName: assign.assigneeName,
                            assigneeType: assign.type, // "利用者", "職員" ...
                            startDate: assign.startDate,
                            endDate: assign.endDate
                        });
                    });
                }
            }
            return assignments;
        }

        function renderBudgetAllocationTable() {
            const budgetTbody = document.getElementById('budget-allocation-table-body');
            const budgetTemplate = document.getElementById('budget-allocation-row-template');
            if (!budgetTbody || !budgetTemplate) return;

            const tasks = getTaskDefinitions(); 
            
            const existingData = {};
            budgetTbody.querySelectorAll('tr').forEach(row => {
                const taskName = row.querySelector('.task-name-readonly').textContent;
                const budgetValue = row.querySelector('.budget-allocation-input').value;
                existingData[taskName] = { budget: budgetValue };
            });

            budgetTbody.innerHTML = '';
            const typeMap = { member: '利用者', staff: '職員', partner: '外注先', customer: '顧客' };

            tasks.forEach(task => {
                const clone = budgetTemplate.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                newRow.querySelector('.task-name-readonly').textContent = task.name;
                
                const typeDisplayCell = newRow.querySelector('[data-field="assigneeType"]');
                if (typeDisplayCell) {
                    typeDisplayCell.textContent = typeMap[task.assigneeType] || '（未設定）';
                    typeDisplayCell.closest('tr').dataset.assigneeType = task.assigneeType;
                }

                const budgetInput = newRow.querySelector('.budget-allocation-input');

                if (existingData[task.name]) {
                    budgetInput.value = existingData[task.name].budget;
                } else if (task.name === 'チラシ折り') {
                    budgetInput.value = '20000';
                } else if (task.name === '封入') {
                    budgetInput.value = '30000';
                } else if (task.name === '宛名貼り') {
                    budgetInput.value = '10000';
                }

                budgetTbody.appendChild(newRow);
            });
            updateBudgetSummary();
        }

         function updateAssigneeOptions(assigneeType, assigneeSelectElement) {
            assigneeSelectElement.innerHTML = '<option value="">（未割当）</option>';
            assigneeSelectElement.dataset.taskType = assigneeType; 

             if (assigneeType === 'member') {
                 const memberOptgroup = document.createElement('optgroup');
                 memberOptgroup.label = '利用者';
                 memberOptgroup.appendChild(new Option('青木 誠', 'member:A001'));
                 memberOptgroup.appendChild(new Option('五十嵐 直人', 'member:A002'));
                 memberOptgroup.appendChild(new Option('遠藤 雅彦', 'member:A003'));
                 assigneeSelectElement.appendChild(memberOptgroup);
             } else if (assigneeType === 'staff') {
                 const staffOptgroup = document.createElement('optgroup');
                 staffOptgroup.label = '職員';
                 staffOptgroup.appendChild(new Option('管理者 太郎', 'staff:S001')); 
                 staffOptgroup.appendChild(new Option('支援員 次郎', 'staff:S002'));
                 staffOptgroup.appendChild(new Option('職業指導員 三郎', 'staff:S003'));
                 assigneeSelectElement.appendChild(staffOptgroup);
             } else if (assigneeType === 'partner') {
                 const partnerOptgroup = document.createElement('optgroup');
                 partnerOptgroup.label = '外注先';
                 partnerOptgroup.appendChild(new Option('〇〇印刷', 'partner:P001'));
                 partnerOptgroup.appendChild(new Option('□□商事', 'partner:P002'));
                 assigneeSelectElement.appendChild(partnerOptgroup);
             } else if (assigneeType === 'customer') {
                 const customerOptgroup = document.createElement('optgroup');
                 customerOptgroup.label = '顧客';
                 customerOptgroup.appendChild(new Option('株式会社A', 'customer:C001'));
                 customerOptgroup.appendChild(new Option('有限会社B', 'customer:C002'));
                 customerOptgroup.appendChild(new Option('C-Tech', 'customer:C003'));
                 assigneeSelectElement.appendChild(customerOptgroup);
             }
        }

        function renderProgressManagementTable() {
            const tableBody = document.getElementById('progress-management-table-body');
            const template = document.getElementById('progress-management-row-template');
            
            if (!tableBody || !template) return;

            const assignments = getScheduleAssignData(); 
            const budgetData = getBudgetData();     
            
            // ▼▼▼ 修正: モックデータ（複数アサイン） ▼▼▼
            const currentMonthProgressData = {
                "チラシ折り-青木 誠": { progress: 100, contribution: 100 }, 
                "チラシ折り-五十嵐 直人": { progress: 100, contribution: 100 },
                "封入-支援員 次郎": { progress: 50, contribution: 100 },
                "宛名貼り-〇〇印刷": { progress: 10, contribution: 100 }
            };
            const lastMonthProgressData = {
                 "チラシ折り-青木 誠": { progress: 50 },
                 "チラシ折り-五十嵐 直人": { progress: 40 },
                 "封入-支援員 次郎": { progress: 20 },
                 "宛名貼り-〇〇印刷": { progress: 0 }
            };
            // ▲▲▲ 修正 ▲▲▲

            tableBody.innerHTML = '';
            
            assignments.forEach(assign => {
                const taskName = assign.taskName;
                const taskBudget = budgetData[taskName] || 0; 
                const assigneeType = assign.assigneeType.trim(); 
                const typeMap = { '利用者': 'member', '職員': 'staff', '外注先': 'partner', '顧客': 'customer' };
                const assigneeTypeKey = typeMap[assigneeType] || 'unknown'; 

                const clone = template.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                
                const progressKey = `${taskName}-${assign.assigneeName}`;
                const currentData = currentMonthProgressData[progressKey] || { progress: 0, contribution: 100 };
                const lastMonthData = lastMonthProgressData[progressKey] || { progress: 0 };

                newRow.querySelector('[data-field="taskName"]').textContent = taskName;
                newRow.querySelector('[data-field="assigneeName"]').textContent = assign.assigneeName;
                newRow.querySelector('[data-field="assigneeType"]').textContent = assigneeType;
                
                newRow.dataset.taskBudget = taskBudget; 
                newRow.dataset.lastMonthProgress = lastMonthData.progress; 
                newRow.dataset.assigneeType = assigneeTypeKey;

                const progressInput = newRow.querySelector('.progress-rate-input');
                progressInput.value = currentData.progress;
                
                const deltaSpan = newRow.querySelector('.progress-delta');
                const delta = currentData.progress - lastMonthData.progress;
                deltaSpan.textContent = `(${delta >= 0 ? '+' : ''}${delta}%)`;
                deltaSpan.className = delta > 0 ? 'progress-delta positive' : (delta < 0 ? 'progress-delta negative' : 'progress-delta');

                const contributionCell = newRow.querySelector('[data-field="contribution-cell"]'); 
                
                if (assigneeTypeKey !== 'member') { 
                    if (contributionCell) {
                        contributionCell.innerHTML = '<div class="contribution-placeholder">-</div>'; 
                    }
                } else {
                    const contributionInputHTML = '<input type="number" class="form-control contribution-input" placeholder="100" min="0" max="100">';
                    contributionCell.innerHTML = contributionInputHTML;
                    const contributionInput = contributionCell.querySelector('.contribution-input');
                    contributionInput.value = currentData.contribution;
                }

                tableBody.appendChild(newRow);
            });
            
            calculateAllIncentives();
        }

        function calculateAllIncentives() {
            const tableBody = document.getElementById('progress-management-table-body');
            if (!tableBody) return;

            tableBody.querySelectorAll('tr').forEach(row => {
                calculateIncentiveForRow(row);
            });
        }
        
        function calculateIncentiveForRow(row) {
            const assigneeType = row.dataset.assigneeType;
            const resultCell = row.querySelector('[data-field="calculatedIncentive"]');
            if (!resultCell) return;
            
            const progressRateInput = row.querySelector('.progress-rate-input');
            const contributionCell = row.querySelector('[data-field="contribution-cell"]');
            const contributionInput = contributionCell?.querySelector('.contribution-input'); 
            const deltaSpan = row.querySelector('.progress-delta');
            
            const budget = parseFloat(row.dataset.taskBudget) || 0;
            const lastMonthProgress = parseFloat(row.dataset.lastMonthProgress) || 0;
            const currentProgress = parseFloat(progressRateInput?.value) || 0;

            if (!progressRateInput || !deltaSpan) return;

            const delta = currentProgress - lastMonthProgress;
            deltaSpan.textContent = `(${delta >= 0 ? '+' : ''}${delta}%)`;
            deltaSpan.className = delta > 0 ? 'progress-delta positive' : (delta < 0 ? 'progress-delta negative' : 'progress-delta');

            let effectiveContributionRate;

            if (assigneeType === 'member') {
                if (!contributionInput) {
                     resultCell.textContent = 'エラー';
                     return;
                }
                const contributionRate = parseFloat(contributionInput.value);
                effectiveContributionRate = isNaN(contributionRate) ? 100 : contributionRate;
                
            } else {
                effectiveContributionRate = 100;
                if (contributionCell && !contributionInput) {
                    contributionCell.innerHTML = '<div class="contribution-placeholder">-</div>';
                }
            }
            
            const progressDelta = Math.max(0, currentProgress - lastMonthProgress); 
            // ▼▼▼ 修正: 複数アサインの場合の按分（仮：担当者数で均等割） ▼▼▼
            const taskName = row.querySelector('[data-field="taskName"]').textContent;
            const assignmentsForTask = getScheduleAssignData().filter(a => a.taskName === taskName);
            const assigneeCount = assignmentsForTask.length > 0 ? assignmentsForTask.length : 1;
            const incentive = (budget / assigneeCount) * (progressDelta / 100) * (effectiveContributionRate / 100);
            // ▲▲▲ 修正 ▲▲▲
            
            resultCell.textContent = Math.floor(incentive).toLocaleString();
        }

        // ▼▼▼ 修正: スケジュール・アサイン関連の関数群（表示スタイル変更） ▼▼▼

        function renderScheduleAssignTab() {
            const scheduleTbody = document.getElementById('schedule-assign-table-body');
            const template = document.getElementById('schedule-assign-task-row-template');
            if (!scheduleTbody || !template) return;

            scheduleTbody.innerHTML = '';
            const tasks = getTaskDefinitions(); 
            const typeMap = { member: '利用者', staff: '職員', partner: '外注先', customer: '顧客' };

            tasks.forEach(task => {
                const clone = template.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                
                newRow.querySelector('.task-name-readonly').textContent = task.name;
                // ▼▼▼ 修正: 「必要スキル」セルを削除 ▼▼▼
                // newRow.querySelector('.skill-display-cell').innerHTML = task.requiredSkillsHtml;
                // ▲▲▲ 修正 ▲▲▲
                newRow.querySelector('.assignee-type-display-cell').textContent = typeMap[task.assigneeType] || '（未設定）';
                
                const periodListUl = newRow.querySelector('.period-display-cell > .assign-display-list');
                const assigneeListUl = newRow.querySelector('.assignee-display-cell > .assign-display-list');
            
                const assignments = mockScheduleData[task.id] || [];
                
                if (assignments.length > 0) {
                    assignments.forEach(assign => {
                        // ▼▼▼ 修正: 期間表示（括弧なし） ▼▼▼
                        const periodLi = document.createElement('li');
                        periodLi.textContent = `${assign.startDate} ~ ${assign.endDate}`;
                        periodListUl.appendChild(periodLi);
                        // ▲▲▲ 修正 ▲▲▲
                        
                        const assigneeLi = document.createElement('li');
                        assigneeLi.textContent = assign.assigneeName;
                        assigneeListUl.appendChild(assigneeLi);
                    });
                } else {
                    periodListUl.innerHTML = '<li>（未設定）</li>';
                    assigneeListUl.innerHTML = '<li>（未割当）</li>';
                }

                newRow.dataset.taskId = task.id;
                newRow.dataset.taskName = task.name;
                newRow.dataset.assigneeType = task.assigneeType;
                
                scheduleTbody.appendChild(newRow);
            });
        }
        
        /**
         * スケジュール・アサイン編集モーダルを開く
         */
        function openScheduleAssignModal(taskId, taskName, assigneeType) {
            const modal = document.getElementById('edit-schedule-assign-modal');
            if (!modal) return;

            document.getElementById('modal-task-name-display').textContent = taskName || 'タスク名不明';
            
            const saveButton = document.getElementById('modal-schedule-assign-save-button');
            saveButton.dataset.taskId = taskId;
            const addRowButton = document.getElementById('modal-schedule-assign-add-row-button');
            addRowButton.dataset.assigneeType = assigneeType;

            const modalTbody = document.getElementById('schedule-assign-modal-table-body');
            const rowTemplate = document.getElementById('schedule-assign-modal-row-template');
            modalTbody.innerHTML = ''; 
            
            const existingAssignments = mockScheduleData[taskId] || [];

            if (existingAssignments.length > 0) {
                existingAssignments.forEach(assign => {
                    const clone = rowTemplate.content.cloneNode(true);
                    const newRow = clone.querySelector('tr');
                    
                    newRow.dataset.assignmentId = assign.id;
                    
                    const assigneeSelect = newRow.querySelector('.modal-assignee-select-edit');
                    const startDateInput = newRow.querySelector('.modal-start-date-edit');
                    const endDateInput = newRow.querySelector('.modal-end-date-edit');

                    updateAssigneeOptions(assigneeType, assigneeSelect);
                    assigneeSelect.value = assign.assigneeId;

                    startDateInput.value = assign.startDate;
                    endDateInput.value = assign.endDate;

                    modalTbody.appendChild(newRow);
                });
            }

            window.openModal('edit-schedule-assign-modal');
        }

        /**
         * 期間の重複チェック (モーダル内テーブル用)
         */
        function checkDateOverlap(newStart, newEnd, tbody, currentRow) {
            const rows = tbody.querySelectorAll('tr');
            if (!newStart || !newEnd) return false; 

            const newStartDate = new Date(newStart);
            const newEndDate = new Date(newEnd);

            if (newStartDate > newEndDate) {
                alert('開始日が終了日より後になっています。');
                return true; 
            }

            for (const row of rows) {
                if (row === currentRow) {
                    continue; 
                }
                
                const existingStart = row.querySelector('.modal-start-date-edit')?.value;
                const existingEnd = row.querySelector('.modal-end-date-edit')?.value;
                
                if (existingStart && existingEnd) {
                    const existingStartDate = new Date(existingStart);
                    const existingEndDate = new Date(existingEnd);
                    
                    if (newStartDate <= existingEndDate && newEndDate >= existingStartDate) {
                        return true; 
                    }
                }
            }
            return false; 
        }

        // モーダル内の「アサイン追加」ボタン処理
        document.getElementById('modal-schedule-assign-add-row-button')?.addEventListener('click', (e) => {
            const assigneeType = e.target.dataset.assigneeType;
            const modalTbody = document.getElementById('schedule-assign-modal-table-body');
            const rowTemplate = document.getElementById('schedule-assign-modal-row-template');
            
            if (!assigneeType || !modalTbody || !rowTemplate) return;

            const clone = rowTemplate.content.cloneNode(true);
            const newRow = clone.querySelector('tr');
            
            newRow.dataset.assignmentId = `new-${Date.now()}`; 
            
            const assigneeSelect = newRow.querySelector('.modal-assignee-select-edit');
            updateAssigneeOptions(assigneeType, assigneeSelect);
            
            newRow.querySelector('.modal-start-date-edit').value = '';
            newRow.querySelector('.modal-end-date-edit').value = '';

            modalTbody.appendChild(newRow);
        });

        // モーダル内の「削除」ボタン処理 (イベント委任)
        document.getElementById('schedule-assign-modal-table-body')?.addEventListener('click', (e) => {
             const deleteButton = e.target.closest('.modal-assign-delete-button');
             if (deleteButton) {
                 deleteButton.closest('tr').remove();
             }
        });
        
        // モーダル内の「保存」ボタン処理
        document.getElementById('modal-schedule-assign-save-button')?.addEventListener('click', (e) => {
            const taskId = e.target.dataset.taskId;
            if (!taskId) {
                console.error('保存ボタンにタスクIDがありません。');
                return;
            }
            
            const modalTbody = document.getElementById('schedule-assign-modal-table-body');
            const rows = modalTbody.querySelectorAll('tr');
            const newAssignments = [];
            const typeMap = { 'member': '利用者', 'staff': '職員', 'partner': '外注先', 'customer': '顧客' };
            let hasError = false;

            for (const row of rows) {
                const assigneeSelect = row.querySelector('.modal-assignee-select-edit');
                const startDateInput = row.querySelector('.modal-start-date-edit');
                const endDateInput = row.querySelector('.modal-end-date-edit');

                const assigneeId = assigneeSelect.value;
                const assigneeName = assigneeSelect.options[assigneeSelect.selectedIndex]?.text || '';
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                if (!assigneeId || !startDate || !endDate) {
                    alert('担当者、開始日、終了日をすべて入力してください。');
                    hasError = true;
                    break;
                }
                
                if (checkDateOverlap(startDate, endDate, modalTbody, row)) {
                    alert(`期間が重複しています。\n担当者: ${assigneeName}\n期間: ${startDate} ~ ${endDate}`);
                    hasError = true;
                    break;
                }

                const assigneeTypeKey = assigneeId.split(':')[0]; 
                
                newAssignments.push({
                    id: row.dataset.assignmentId.startsWith('new-') ? `assign-${Date.now()}-${Math.random()}` : row.dataset.assignmentId,
                    assigneeId: assigneeId,
                    assigneeName: assigneeName,
                    type: typeMap[assigneeTypeKey] || '不明',
                    startDate: startDate,
                    endDate: endDate
                });
            };

            if (hasError) {
                return; 
            }

            mockScheduleData[taskId] = newAssignments;
            
            renderScheduleAssignTab();
            renderProgressManagementTable();

            closeModal('edit-schedule-assign-modal');
        });

        // ▲▲▲ 修正ここまで ▲▲▲


        document.addEventListener('DOMContentLoaded', () => {
            const subNavContainer = document.getElementById('project-detail-subnav');
            const tabContents = document.querySelectorAll('#project-detail .tab-content-wrapper .tab-content');

            if (subNavContainer && tabContents.length > 0) {
                subNavContainer.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.sub-nav-item');
                    if (!navItem || navItem.classList.contains('active')) { return; }
                    e.preventDefault();
                    const targetTabId = navItem.dataset.tab;
                    subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => item.classList.remove('active'));
                    navItem.classList.add('active');
                    tabContents.forEach(content => {
                        const isActive = content.id === targetTabId;
                        content.classList.toggle('active', isActive);
                        content.style.display = isActive ? 'block' : 'none'; 
                    });
                    
                    if (targetTabId === 'tab-project-progress') {
                        renderProgressManagementTable();
                    }
                    if (targetTabId === 'tab-project-budget') {
                        renderBudgetAllocationTable();
                    }
                    if (targetTabId === 'tab-project-schedule-assign') { 
                        renderScheduleAssignTab();
                    }
                });
                
                const initialActiveNavItem = subNavContainer.querySelector('.sub-nav-item.active');
                const initialTargetTabId = initialActiveNavItem?.dataset.tab;
                 tabContents.forEach(content => {
                    const isActive = initialTargetTabId && content.id === initialTargetTabId;
                     content.classList.toggle('active', isActive);
                     content.style.display = isActive ? 'block' : 'none';
                 });
            }

            if (typeof window.filterProjects === 'function') {
                const nameInputListener = document.getElementById('search-project-name');
                const clientInputListener = document.getElementById('search-client-name');
                const statusSelectListener = document.getElementById('filter-project-status');
                const clearButton = document.querySelector('#projects .filter-form-inline .button-secondary');

                if (nameInputListener) nameInputListener.addEventListener('input', filterProjects);
                if (clientInputListener) clientInputListener.addEventListener('input', filterProjects);
                if (statusSelectListener) statusSelectListener.addEventListener('change', filterProjects);
                if (clearButton) {
                    clearButton.addEventListener('click', () => {
                        const form = document.querySelector('#projects .filter-form-inline');
                        if (form) form.reset();
                        filterProjects();
                    });
                }
                filterProjects();
            }

             const projectSummaryTextarea = document.getElementById('edit-project-summary-textarea');
             const projectSummaryDisplay = document.getElementById('project-summary-display');
             const saveProjectBasicButton = document.querySelector('#edit-project-basic-modal .button-primary');

             if (saveProjectBasicButton && projectSummaryTextarea && projectSummaryDisplay) {
                 saveProjectBasicButton.addEventListener('click', () => {
                     projectSummaryDisplay.textContent = projectSummaryTextarea.value;
                     closeModal('edit-project-basic-modal');
                 });
             }

            if (window.setupTableRowAdder) {
                setupTableRowAdder('revenue-table-body-budget-plan', 'add-revenue-row-budget-plan', 'revenue-row-template-plan'); 
                setupTableRowAdder('task-definition-table-body', 'add-task-definition-row', 'task-definition-row-template');
                setupTableRowAdder('expense-table-body-budget-plan', 'add-expense-row-budget-plan', 'expense-row-template-plan');
                setupTableRowAdder('expense-table-body-actual', 'add-expense-row-actual', 'expense-row-template-actual');
            }

            const taskDefTbody = document.getElementById('task-definition-table-body');
            if (taskDefTbody) {
                taskDefTbody.querySelectorAll('tr').forEach((row, index) => {
                    if (!row.dataset.taskId) {
                         row.dataset.taskId = `task-static-${index + 1}`;
                    }
                });

                const observer = new MutationObserver((mutations) => {
                    if (mutations.some(m => m.type === 'childList')) {
                        renderBudgetAllocationTable();
                        renderScheduleAssignTab(); 
                        renderProgressManagementTable(); 
                    }
                });
                observer.observe(taskDefTbody, { childList: true });

                 taskDefTbody.addEventListener('input', (e) => {
                     const target = e.target;
                     if (target.classList.contains('task-name-input') || target.classList.contains('assignee-type-select')) {
                        setTimeout(() => {
                            renderBudgetAllocationTable();
                            renderScheduleAssignTab(); 
                            renderProgressManagementTable();
                        }, 50); 
                    }
                 });
                 
                 taskDefTbody.addEventListener('click', (e) => {
                     if(e.target.classList.contains('skill-selection-cell') || e.target.closest('.skill-selection-cell')) {
                         setTimeout(() => {
                             const cell = e.target.closest('.skill-selection-cell');
                             if(cell && !cell.querySelector('.skill-tag[data-skill="dummy"]')) {
                                 cell.querySelector('div').innerHTML = `
                                     <span class="skill-tag">Word (基本文書作成) - Lv.1</span>
                                     <span class="skill-tag">軽作業 (梱包) - Lv.1</span>
                                 `;
                             }
                             
                             renderScheduleAssignTab(); 
                             renderProgressManagementTable();
                         }, 500); 
                     }
                 });
            }
            
            const budgetAllocationTbody = document.getElementById('budget-allocation-table-body');
            if (budgetAllocationTbody) { 
                budgetAllocationTbody.addEventListener('input', (e) => {
                    if (e.target.matches('.budget-allocation-input')) {
                        updateBudgetSummary();
                        renderProgressManagementTable(); 
                    }
                });
            }
            
            const budgetTab = document.getElementById('tab-project-budget');
            if (budgetTab) {
                budgetTab.addEventListener('input', (e) => {
                        if (e.target.matches('.revenue-amount-input-plan, .expense-amount-input-plan')) {
                            updateBudgetSummary();
                            if (e.target.matches('.revenue-amount-input-plan')) {
                                updateActualSummary();
                            }
                        }
                });
                budgetTab.addEventListener('click', (e) => {
                     if (e.target.closest('#add-revenue-row-budget-plan, #revenue-table-body-budget-plan .button-danger, #add-expense-row-budget-plan, #expense-table-body-budget-plan .button-danger')) {
                         setTimeout(() => {
                             updateBudgetSummary();
                             updateActualSummary(); 
                         }, 50);
                     }
                 });
            }
            
            const scheduleAssignTbody = document.getElementById('schedule-assign-table-body');
            if (scheduleAssignTbody) { 
                scheduleAssignTbody.addEventListener('click', (e) => {
                    if (e.target.closest('button, input, select, textarea, a')) {
                        return; 
                    }

                    const clickedRow = e.target.closest('tr');
                    
                    if (clickedRow) {
                        const taskId = clickedRow.dataset.taskId;
                        const taskName = clickedRow.dataset.taskName;
                        const assigneeType = clickedRow.dataset.assigneeType;

                        if (taskId && taskName != null && assigneeType != null) { 
                            openScheduleAssignModal(taskId, taskName, assigneeType);
                        } else {
                            console.warn('Task data missing on clicked row for schedule/assign modal.', clickedRow.dataset);
                        }
                    }
                });
            }

            const progressTab = document.getElementById('tab-project-progress');
            if (progressTab) {
                progressTab.addEventListener('input', (e) => {
                    if (e.target.matches('.expense-amount-input-actual')) {
                        updateActualSummary();
                    }
                });
                 progressTab.addEventListener('click', (e) => {
                     if (e.target.closest('#add-expense-row-actual') || e.target.closest('#expense-table-body-actual .button-danger')) {
                         setTimeout(updateActualSummary, 50);
                     }
                 });
                 
                const progressTableBody = document.getElementById('progress-management-table-body');
                if (progressTableBody) {
                    progressTableBody.addEventListener('input', (e) => {
                        if (e.target.classList.contains('progress-rate-input') || e.target.classList.contains('contribution-input')) {
                            const row = e.target.closest('tr');
                            if (row) {
                                calculateIncentiveForRow(row);
                            }
                        }
                    });
                }

                const monthSelector = document.getElementById('progress-month-select-progress');
                if (monthSelector) {
                    monthSelector.addEventListener('change', () => {
                         renderProgressManagementTable();
                    });
                }
            }
             
             updateBudgetSummary();
             updateActualSummary(); 

             const deliveryDateInput = document.getElementById('delivery-date');
             const clearDeliveryDateButton = document.getElementById('clear-delivery-date');
             const deliveryStatusText = document.getElementById('delivery-status-text');

             const billingDateInput = document.getElementById('billing-date');
             const clearBillingDateButton = document.getElementById('clear-billing-date');
             const paymentStatusText = document.getElementById('payment-status-text');

             function updateDeliveryStatus() {
                 if (deliveryDateInput && deliveryStatusText) {
                    deliveryStatusText.textContent = deliveryDateInput.value ? '納品済' : '未納品';
                 }
                 updatePaymentStatus(); 
             }
             function updatePaymentStatus() {
                 if(billingDateInput && paymentStatusText && deliveryDateInput){
                    if(billingDateInput.value){
                        paymentStatusText.textContent = '請求済 (未入金)';
                    } else if (deliveryDateInput.value) {
                         paymentStatusText.textContent = '未請求 (納品済)';
                    } else {
                         paymentStatusText.textContent = '未請求 (未納品)';
                    }
                 }
             }

             if(deliveryDateInput) deliveryDateInput.addEventListener('change', updateDeliveryStatus);
             if(clearDeliveryDateButton) clearDeliveryDateButton.addEventListener('click', () => { deliveryDateInput.value = ''; updateDeliveryStatus(); });
             if(billingDateInput) billingDateInput.addEventListener('change', updatePaymentStatus);
             if(clearBillingDateButton) clearBillingDateButton.addEventListener('click', () => { billingDateInput.value = ''; updatePaymentStatus(); });

             updateDeliveryStatus(); 

             // 初期描画
             renderBudgetAllocationTable();
             renderScheduleAssignTab(); // 修正
             renderProgressManagementTable(); 

        });
    </script>
    </body>
</html>