<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>p2508d - 案件管理モックアップ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* 必要スキル表示用のスタイル */
        .skill-tag {
            display: inline-block;
            background-color: #e9ecef;
            color: #495057;
            padding: 0.2em 0.6em;
            margin: 0.2em;
            border-radius: 0.25rem;
            font-size: var(--font-size-xs);
        }
        .skill-selection-cell {
            min-height: 40px; /* ボタンの高さを考慮 */
            vertical-align: middle !important;
        }
        .assignee-select-cell,
        .progress-table-cell {
             vertical-align: middle !important;
        }
        /* 予算・原価管理タブ用 */
         .cost-summary {
             text-align: right;
             font-size: var(--font-size-sm);
             margin-top: 1rem;
             padding-top: 1rem;
             border-top: 1px dashed var(--color-border);
         }
         .cost-summary strong {
             font-size: 1.1em;
             margin-left: 0.5rem;
         }
         .cost-summary .unallocated { color: var(--color-danger); }
         .cost-summary .profit { color: var(--color-primary); }
    </style>
</head>
<body>
    <div class="mockup-container">
        <header class="header">
            <div>
                <h1 class="header-logo"><a href="dashboard.html">p2508d</a></h1>
            </div>
            
            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="dashboard.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="daily_records.html" class="nav-link">日々の記録</a></li>
                    <li><a href="members_menu.html" class="nav-link">利用者支援</a></li>
                    <li><a href="staff.html" class="nav-link">職員管理</a></li>
                    <li><a href="work_activities_menu.html" class="nav-link active">生産活動</a></li>
                    <li><a href="accounting_menu.html" class="nav-link">会計管理</a></li>
                    <li><a href="claims.html" class="nav-link">国保連請求</a></li>
                    <li><a href="analytics.html" class="nav-link">データ分析</a></li>
                    <li><a href="settings.html" class="nav-link">設定</a></li>
                </ul>
                <div class="nav-logout-section">
                    <a href="index.html" class="nav-link">ログアウト</a>
                </div>
            </nav>
        </header>

        <main class="mockup-main">
            <div id="projects" class="mockup-page active"> 
                <div class="list-page-header">
                    <h1 class="page-title">案件一覧</h1>
                     <div>
                         <a href="work_activities_menu.html" class="button button-secondary" style="margin-right: 0.5rem;">生産活動メニューへ</a>
                         <button class="button button-primary" onclick="alert('新規案件作成画面へ遷移します')">＋ 新規作成</button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title-in-header">検索条件</h2>
                        <button type="button" class="button button-secondary">クリア</button>
                    </div>
                    <form class="section-content filter-form">
                        <div class="form-group">
                            <label for="search-project-name" class="form-label">案件名</label>
                            <input type="text" id="search-project-name" class="form-control" placeholder="案件名で検索...">
                        </div>
                        <div class="form-group">
                            <label for="search-client-name" class="form-label">クライアント名</label>
                            <input type="text" id="search-client-name" class="form-control" placeholder="クライアント名で検索...">
                        </div>
                        <div class="form-group">
                            <label for="filter-project-status" class="form-label">ステータス</label>
                            <select id="filter-project-status" class="form-control">
                                <option value="">すべて</option>
                                <option value="未着手">未着手</option>
                                <option value="作業中">作業中</option>
                                <option value="完了">完了</option>
                                <option value="納品済">納品済</option>
                                <option value="キャンセル">キャンセル</option>
                            </select>
                        </div>
                        </form>
                </div>
                <div class="table-wrapper" style="margin-top: 1.5rem;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>案件名</th>
                                <th>クライアント名</th>
                                <th>ステータス</th>
                                <th>納期</th>
                                </tr>
                        </thead>
                         <tbody id="project-list-tbody">
                            <tr class="clickable-row" onclick="showPage('project-detail')">
                                <td>A社 DM封入作業</td>
                                <td>株式会社A</td>
                                <td>作業中</td>
                                <td>2025.10.31</td>
                                </tr>
                            <tr class="clickable-row" onclick="showPage('project-detail')">
                                <td>B社 部品組み立て</td>
                                <td>有限会社B</td>
                                <td>完了</td>
                                <td>2025.09.30</td>
                                </tr>
                             <tr class="clickable-row" onclick="showPage('project-detail')">
                                <td>C社 データ入力</td>
                                <td>C-Tech</td>
                                <td>納品済</td>
                                <td>2025.09.15</td>
                                </tr>
                        </tbody>
                        </table>
                </div>
            </div>

            <div id="project-detail" class="mockup-page"> 
                <div class="list-page-header">
                    <h1 class="page-title">A社 DM封入作業</h1> <div>
                        <button class="button button-secondary" style="margin-right: 0.5rem;" onclick="showPage('projects')">一覧へ戻る</button>
                        <button type="button" class="button button-danger" onclick="alert('「A社 DM封入作業」のデータを削除します。よろしいですか？')">削除</button>
                    </div>
                </div>

                <div class="sub-nav">
                    <ul id="project-detail-subnav">
                        <li><a href="#" class="sub-nav-item active" data-tab="tab-project-overview">案件情報</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-task-definition">タスク定義</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-budget-cost">予算・原価管理</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-assignee-assignment">担当者割当</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-progress">進捗管理</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-process">工程管理</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-delivery">納品・請求</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-files">関連ファイル</a></li>
                    </ul>
                </div>
                <div class="tab-content-wrapper">
                    <div id="tab-project-overview" class="tab-content active">
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title-in-header">基本情報</h2>
                                <button class="button button-primary" onclick="openModal('edit-project-basic-modal')">編集</button>
                            </div>
                            <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>案件名</dt><dd>A社 DM封入作業</dd>
                                    <dt>顧客</dt><dd>株式会社A</dd>
                                    <dt>ステータス</dt><dd>作業中</dd>
                                    <dt>担当職員</dt><dd>支援員 次郎</dd>
                                    <dt>受注日</dt><dd>2025年10月1日</dd>
                                    <dt>納期</dt><dd>2025年10月31日</dd>
                                    <dt style="align-self: start;">概要</dt>
                                    <dd id="project-summary-display" style="white-space: pre-wrap; align-self: start;">チラシ、挨拶状、返信用封筒の3点をまとめて封入する。宛名ラベルを貼付後、指定の箱に500部ずつ梱包する。</dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <div id="tab-project-task-definition" class="tab-content">
                         <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">タスク定義</h2>
                                <button type="button" class="button button-primary" id="add-task-definition-row">＋ タスクを追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="task-definition-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th>作業指示/備考</th>
                                            <th style="width: 150px;">想定工数(H)</th>
                                            <th style="width: 250px;">必要スキル</th>
                                            <th class="col-actions">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-definition-table-body">
                                         <tr>
                                            <td><input type="text" class="form-control task-name-input" value="チラシ折り"></td>
                                            <td><input type="text" class="form-control" value="三つ折りにする"></td>
                                            <td><input type="number" class="form-control" value="20"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">軽作業 Lv.1</span>
                                                    <span class="skill-tag">集中力 Lv.1</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="alert('スキル選択モーダルを開く (未実装)')">スキル選択</button>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                         <tr>
                                            <td><input type="text" class="form-control task-name-input" value="封入"></td>
                                            <td><input type="text" class="form-control" value="チラシ、挨拶状、返信用封筒を封入"></td>
                                            <td><input type="number" class="form-control" value="40"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">軽作業 Lv.1</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="alert('スキル選択モーダルを開く (未実装)')">スキル選択</button>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" class="form-control task-name-input" value="宛名貼り"></td>
                                            <td><input type="text" class="form-control" value="指定のラベルを貼付"></td>
                                            <td><input type="number" class="form-control" value="15"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">PC基本操作 Lv.1</span>
                                                    <span class="skill-tag">正確性 Lv.2</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="alert('スキル選択モーダルを開く (未実装)')">スキル選択</button>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                             <div class="section-footer">
                                <button type="button" class="button button-primary">タスク定義を保存</button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-project-budget-cost" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">予算（収益）</h2>
                            <div class="section-content">
                                 <dl class="detail-grid" style="grid-template-columns: 100px 1fr;">
                                    <dt>受注金額</dt><dd><input type="number" class="form-control" id="project-revenue-input-budget" value="100000"> 円</dd>
                                </dl>
                            </div>
                        </div>
                         <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">タスク別 予算分配</h2>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="budget-allocation-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th style="width: 150px;">分配額(円)</th>
                                            <th style="width: 150px;">実績原価(円)</th></tr>
                                    </thead>
                                    <tbody id="budget-allocation-table-body">
                                        <tr>
                                            <td style="text-align: left;" class="task-name-readonly">チラシ折り</td>
                                            <td><input type="number" class="form-control budget-allocation-input" value="20000"></td>
                                            <td><span class="readonly-text actual-cost-display" style="text-align: right;">18,500</span></td> </tr>
                                        <tr>
                                            <td style="text-align: left;" class="task-name-readonly">封入</td>
                                            <td><input type="number" class="form-control budget-allocation-input" value="30000"></td>
                                            <td><span class="readonly-text actual-cost-display" style="text-align: right;">(計算中)</span></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: left;" class="task-name-readonly">宛名貼り</td>
                                            <td><input type="number" class="form-control budget-allocation-input" value="10000"></td>
                                             <td><span class="readonly-text actual-cost-display" style="text-align: right;">(未着手)</span></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="cost-summary">
                                <span>受注金額: <strong id="summary-revenue-budget">100,000</strong>円</span> |
                                <span>予算分配済: <strong id="summary-allocated-budget">60,000</strong>円</span> |
                                <span class="unallocated">予算未分配: <strong id="summary-unallocated-budget">40,000</strong>円</span> |
                                <span class="profit">現在利益予測: <strong id="summary-predicted-profit">21,500</strong>円</span>
                                <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-left: 1em;">(受注額 - 分配済予算 - その他経費)</span>
                            </div>
                        </div>
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">その他経費</h2>
                                <button type="button" class="button button-primary" id="add-expense-row-budget">＋ 経費を追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="expense-table-budget">
                                    <thead><tr><th>日付</th><th>費目</th><th>内容</th><th>金額(円)</th><th class="col-actions">操作</th></tr></thead>
                                    <tbody id="expense-table-body-budget">
                                        <tr>
                                            <td><input type="date" class="form-control" value="2025-10-02"></td>
                                            <td><input type="text" class="form-control" value="材料費"></td>
                                            <td><input type="text" class="form-control" value="封筒・ラベル代"></td>
                                            <td><input type="number" class="form-control expense-amount-input" value="5000"></td>
                                            <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                             <div class="cost-summary" style="border: none; padding-top: 0;">
                                 <span>その他経費合計: <strong id="summary-other-expense">5,000</strong>円</span>
                             </div>
                        </div>
                        <div class="section-footer">
                            <button type="button" class="button button-primary">予算・原価情報を保存</button>
                        </div>
                    </div>
                    <div id="tab-project-assignee-assignment" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">担当者割当</h2>
                            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-bottom: 1rem;">「タスク定義」タブで設定したタスクごとに、内外製区分と担当者を選択します。</p>
                            <div class="table-wrapper">
                                <table class="table" id="assignee-assignment-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th style="width: 120px;">内外製</th>
                                            <th style="width: 300px;">必要スキル</th>
                                            <th style="width: 250px;">担当者</th>
                                            <th class="col-actions">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assignee-assignment-table-body">
                                        <tr>
                                            <td style="text-align: left;" class="task-name-readonly">チラシ折り</td>
                                            <td>
                                                <select class="form-control task-type-select">
                                                    <option value="internal" selected>内製</option>
                                                    <option value="external">外注</option>
                                                </select>
                                            </td>
                                            <td class="skill-display-cell">
                                                <span class="skill-tag">軽作業 Lv.1</span>
                                                <span class="skill-tag">集中力 Lv.1</span>
                                            </td>
                                            <td class="assignee-select-cell">
                                                <select class="form-control assignee-select" data-task-type="internal">
                                                    <option value="">（未割当）</option>
                                                    <optgroup label="利用者 (適合)">
                                                        <option value="member:A001" selected>青木 誠</option>
                                                        <option value="member:A002">五十嵐 直人</option>
                                                    </optgroup>
                                                    <optgroup label="利用者 (一部適合/不適合)">
                                                        <option value="member:A003">遠藤 雅彦</option>
                                                    </optgroup>
                                                    <optgroup label="職員">
                                                        <option value="staff:S002">支援員 次郎</option>
                                                        <option value="staff:S003">職業指導員 三郎</option>
                                                    </optgroup>
                                                </select>
                                            </td>
                                            <td class="col-actions">
                                                 <div class="table-button-group">
                                                    <button type="button" class="button button-clear" style="border: 1px solid var(--color-border); color: var(--color-text-secondary); font-size: var(--font-size-xs);" onclick="this.closest('tr').querySelector('.assignee-select').value=''">クリア</button>
                                                </div>
                                            </td>
                                        </tr>
                                         <tr>
                                            <td style="text-align: left;" class="task-name-readonly">封入</td>
                                             <td>
                                                <select class="form-control task-type-select">
                                                    <option value="internal" selected>内製</option>
                                                    <option value="external">外注</option>
                                                </select>
                                            </td>
                                            <td class="skill-display-cell">
                                                <span class="skill-tag">軽作業 Lv.1</span>
                                            </td>
                                            <td class="assignee-select-cell">
                                                <select class="form-control assignee-select" data-task-type="internal">
                                                    <option value="">（未割当）</option>
                                                    <optgroup label="利用者 (適合)">
                                                        <option value="member:A001">青木 誠</option>
                                                        <option value="member:A003" selected>遠藤 雅彦</option>
                                                        <option value="member:A002">五十嵐 直人</option>
                                                    </optgroup>
                                                     <optgroup label="職員">
                                                        <option value="staff:S002">支援員 次郎</option>
                                                    </optgroup>
                                                </select>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-clear" style="border: 1px solid var(--color-border); color: var(--color-text-secondary); font-size: var(--font-size-xs);" onclick="this.closest('tr').querySelector('.assignee-select').value=''">クリア</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: left;" class="task-name-readonly">宛名貼り</td>
                                             <td>
                                                <select class="form-control task-type-select">
                                                    <option value="internal" selected>内製</option>
                                                    <option value="external">外注</option>
                                                </select>
                                            </td>
                                            <td class="skill-display-cell">
                                                <span class="skill-tag">PC基本操作 Lv.1</span>
                                                <span class="skill-tag">正確性 Lv.2</span>
                                            </td>
                                            <td class="assignee-select-cell">
                                                <select class="form-control assignee-select" data-task-type="internal">
                                                    <option value="" selected>（未割当）</option>
                                                    <optgroup label="利用者 (適合)">
                                                        <option value="member:A001">青木 誠</option>
                                                    </optgroup>
                                                     <optgroup label="職員">
                                                         <option value="staff:S002">支援員 次郎</option>
                                                         <option value="staff:S003">職業指導員 三郎</option>
                                                    </optgroup>
                                                    </select>
                                            </td>
                                             <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-clear" style="border: 1px solid var(--color-border); color: var(--color-text-secondary); font-size: var(--font-size-xs);" onclick="this.closest('tr').querySelector('.assignee-select').value=''">クリア</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="section-footer">
                                <button type="button" class="button button-primary">担当者割当を保存</button>
                            </div>
                        </div>
                    </div>
                    <div id="tab-project-progress" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">進捗管理</h2>
                             <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                                 <label for="progress-month-select-progress" class="form-label" style="margin-bottom: 0;">対象月:</label>
                                 <input type="month" id="progress-month-select-progress" class="form-control" value="2025-10" style="width: auto;">
                             </div>
                            <div class="table-wrapper">
                                <table class="table" id="progress-management-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th style="width: 220px;">作業時期</th>
                                            <th style="width: 150px;">ステータス</th>
                                            <th style="width: 120px;">進捗率(%)</th>
                                            <th style="width: 120px;">貢献度(今月Pt)</th>
                                            <th class="col-actions"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="progress-management-table-body">
                                         <tr>
                                            <td style="text-align: left;" class="task-name-readonly">チラシ折り</td>
                                            <td class="progress-table-cell">
                                                <div style="display: flex; align-items: center; gap: 0.2rem;">
                                                    <input type="date" class="form-control start-date-input" value="2025-10-01" style="flex: 1;">
                                                    <span>～</span>
                                                    <input type="date" class="form-control end-date-input" value="2025-10-10" style="flex: 1;">
                                                </div>
                                            </td>
                                            <td class="progress-table-cell">
                                                <select class="form-control status-select">
                                                    <option value="pending">未着手</option>
                                                    <option value="inprogress">作業中</option>
                                                    <option value="review">確認待</option>
                                                    <option value="done" selected>完了</option>
                                                </select>
                                            </td>
                                            <td class="progress-table-cell"><input type="number" class="form-control progress-rate-input" value="100" min="0" max="100"></td>
                                            <td class="progress-table-cell"><input type="number" class="form-control contribution-input" value="10"></td>
                                            <td class="col-actions"></td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: left;" class="task-name-readonly">封入</td>
                                             <td class="progress-table-cell">
                                                <div style="display: flex; align-items: center; gap: 0.2rem;">
                                                    <input type="date" class="form-control start-date-input" value="2025-10-11" style="flex: 1;">
                                                    <span>～</span>
                                                    <input type="date" class="form-control end-date-input" value="2025-10-25" style="flex: 1;">
                                                </div>
                                            </td>
                                            <td class="progress-table-cell">
                                                <select class="form-control status-select">
                                                    <option value="pending">未着手</option>
                                                    <option value="inprogress" selected>作業中</option>
                                                    <option value="review">確認待</option>
                                                    <option value="done">完了</option>
                                                </select>
                                            </td>
                                            <td class="progress-table-cell"><input type="number" class="form-control progress-rate-input" value="50" min="0" max="100"></td>
                                            <td class="progress-table-cell"><input type="number" class="form-control contribution-input" value="8"></td>
                                            <td class="col-actions"></td>
                                        </tr>
                                         <tr>
                                            <td style="text-align: left;" class="task-name-readonly">宛名貼り</td>
                                             <td class="progress-table-cell">
                                                <div style="display: flex; align-items: center; gap: 0.2rem;">
                                                    <input type="date" class="form-control start-date-input" value="2025-10-26" style="flex: 1;">
                                                    <span>～</span>
                                                    <input type="date" class="form-control end-date-input" value="2025-10-31" style="flex: 1;">
                                                </div>
                                            </td>
                                            <td class="progress-table-cell">
                                                <select class="form-control status-select">
                                                    <option value="pending" selected>未着手</option>
                                                    <option value="inprogress">作業中</option>
                                                    <option value="review">確認待</option>
                                                    <option value="done">完了</option>
                                                </select>
                                            </td>
                                            <td class="progress-table-cell"><input type="number" class="form-control progress-rate-input" value="0" min="0" max="100"></td>
                                            <td class="progress-table-cell"><input type="number" class="form-control contribution-input" value=""></td>
                                            <td class="col-actions"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="section-footer">
                                <button type="button" class="button button-primary">進捗情報を保存</button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-project-process" class="tab-content">
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">工程一覧</h2>
                                <button type="button" class="button button-primary" id="add-process-row">＋ 工程を追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="process-table">
                                    <thead>
                                        <tr><th>No</th><th>工程名</th><th>担当者</th><th>進捗</th><th>予定/実績</th><th class="col-actions">操作</th></tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>1</td>
                                            <td><input type="text" class="form-control" value="チラシ折り"></td>
                                            <td><input type="text" class="form-control" value="青木, 五十嵐"></td>
                                            <td><input type="text" class="form-control" value="完了"></td>
                                            <td><input type="text" class="form-control" value="20h / 18.5h"></td>
                                            <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                                        </tr>
                                        <tr>
                                            <td>2</td>
                                            <td><input type="text" class="form-control" value="封入"></td>
                                            <td><input type="text" class="form-control" value="遠藤"></td>
                                            <td><input type="text" class="form-control" value="作業中 50%"></td>
                                            <td><input type="text" class="form-control" value="40h / 25h"></td>
                                            <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                                        </tr>
                                        <tr>
                                            <td>3</td>
                                            <td><input type="text" class="form-control" value="宛名貼り"></td>
                                            <td><input type="text" class="form-control" value="-"></td>
                                            <td><input type="text" class="form-control" value="未着手"></td>
                                            <td><input type="text" class="form-control" value="15h / -"></td>
                                            <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="section-footer">
                                <button type="button" class="button button-primary">工程情報を保存</button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-project-delivery" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">納品情報</h2>
                             <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>納品日</dt>
                                    <dd>
                                        <input type="date" id="delivery-date" class="form-control"> <button type="button" class="button button-clear" id="clear-delivery-date">クリア</button>
                                    </dd>
                                    <dt>納品ステータス</dt>
                                    <dd><span id="delivery-status-text">未納品</span></dd>
                                </dl>
                            </div>
                        </div>
                        <div class="section">
                            <h2 class="section-title">請求情報</h2>
                             <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>請求日</dt>
                                    <dd>
                                        <input type="date" id="billing-date" class="form-control"> <button type="button" class="button button-clear" id="clear-billing-date">クリア</button>
                                    </dd>
                                    <dt>入金ステータス</dt>
                                    <dd><span id="payment-status-text">未請求</span></dd>
                                </dl>
                            </div>
                        </div>
                        <div class="section-footer">
                            <button type="button" class="button button-primary">納品・請求情報を保存</button>
                        </div>
                    </div>

                    <div id="tab-project-files" class="tab-content">
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">ファイル一覧</h2>
                                <button type="button" class="button button-primary">＋ アップロード</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table">
                                    <thead><tr><th>ファイル名</th><th>更新日時</th><th class="col-actions">操作</th></tr></thead>
                                    <tbody>
                                        <tr>
                                            <td>仕様書_rev2.pdf</td>
                                            <td>2025/10/01 10:30</td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary">ダウンロード</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>宛名リスト.xlsx</td>
                                            <td>2025/10/05 14:00</td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-secondary">ダウンロード</button>
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>

            <div id="edit-project-basic-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">案件 基本情報編集</h2>
                        <span class="modal-close" onclick="closeModal('edit-project-basic-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-project-name" class="form-label">案件名</label>
                            <input type="text" id="edit-project-name" class="form-control" value="A社 DM封入作業">
                        </div>
                        <div class="form-group">
                             <label for="edit-project-client" class="form-label">顧客</label>
                             <select id="edit-project-client" class="form-control">
                                 <option value="client-a" selected>株式会社A</option>
                                 <option value="client-b">有限会社B</option>
                                 <option value="client-c">C-Tech</option>
                                 <option value="partner-d">□□商事</option>
                             </select>
                        </div>
                         <div class="form-group">
                            <label for="edit-project-status" class="form-label">ステータス</label>
                            <select id="edit-project-status" class="form-control">
                                <option value="未着手">未着手</option>
                                <option value="作業中" selected>作業中</option>
                                <option value="完了">完了</option>
                                <option value="納品済">納品済</option>
                                <option value="キャンセル">キャンセル</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-project-staff" class="form-label">担当職員</label>
                             <select id="edit-project-staff" class="form-control">
                                 <option value="staff-taro">管理者 太郎</option>
                                 <option value="staff-jiro" selected>支援員 次郎</option>
                                 <option value="staff-saburo">職業指導員 三郎</option>
                             </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-project-order-date" class="form-label">受注日</label>
                            <input type="date" id="edit-project-order-date" class="form-control" value="2025-10-01">
                        </div>
                        <div class="form-group">
                            <label for="edit-project-due-date" class="form-label">納期</label>
                            <input type="date" id="edit-project-due-date" class="form-control" value="2025-10-31">
                        </div>
                         <div class="form-group">
                            <label for="edit-project-summary-textarea" class="form-label">概要</label>
                            <textarea id="edit-project-summary-textarea" class="form-control" rows="5">チラシ、挨拶状、返信用封筒の3点をまとめて封入する。宛名ラベルを貼付後、指定の箱に500部ずつ梱包する。</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button button-secondary" onclick="closeModal('edit-project-basic-modal')">キャンセル</button>
                        <button type="button" class="button button-primary">保存</button>
                    </div>
                </div>
            </div>

            <template id="task-definition-row-template">
                <tr>
                    <td><input type="text" class="form-control task-name-input" placeholder="新規タスク名"></td>
                    <td><input type="text" class="form-control" placeholder="作業指示や備考を入力"></td>
                    <td><input type="number" class="form-control" placeholder="0"></td>
                    <td class="skill-selection-cell">
                        <div></div>
                        <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="alert('スキル選択モーダルを開く (未実装)')">スキル選択</button>
                    </td>
                    <td class="col-actions">
                        <div class="table-button-group">
                            <button type="button" class="button button-danger">削除</button>
                        </div>
                    </td>
                </tr>
            </template>

            <template id="budget-allocation-row-template">
                 <tr>
                    <td style="text-align: left;" class="task-name-readonly">（タスク名）</td>
                    <td><input type="number" class="form-control budget-allocation-input" placeholder="0"></td>
                    <td><span class="readonly-text actual-cost-display" style="text-align: right;">(未計算)</span></td>
                </tr>
            </template>

            <template id="assignee-assignment-row-template">
                 <tr>
                    <td style="text-align: left;" class="task-name-readonly">（タスク名）</td>
                    <td>
                        <select class="form-control task-type-select">
                            <option value="internal" selected>内製</option>
                            <option value="external">外注</option>
                        </select>
                    </td>
                    <td class="skill-display-cell">
                         </td>
                    <td class="assignee-select-cell">
                        <select class="form-control assignee-select" data-task-type="">
                            <option value="">（未割当）</option>
                            </select>
                    </td>
                     <td class="col-actions">
                         <div class="table-button-group">
                            <button type="button" class="button button-clear" style="border: 1px solid var(--color-border); color: var(--color-text-secondary); font-size: var(--font-size-xs);" onclick="this.closest('tr').querySelector('.assignee-select').value=''">クリア</button>
                        </div>
                    </td>
                </tr>
            </template>
             <template id="progress-management-row-template">
                 <tr>
                    <td style="text-align: left;" class="task-name-readonly">（タスク名）</td>
                    <td class="progress-table-cell">
                        <div style="display: flex; align-items: center; gap: 0.2rem;">
                            <input type="date" class="form-control start-date-input" style="flex: 1;">
                            <span>～</span>
                            <input type="date" class="form-control end-date-input" style="flex: 1;">
                        </div>
                    </td>
                    <td class="progress-table-cell">
                        <select class="form-control status-select">
                            <option value="pending" selected>未着手</option>
                            <option value="inprogress">作業中</option>
                            <option value="review">確認待</option>
                            <option value="done">完了</option>
                        </select>
                    </td>
                    <td class="progress-table-cell"><input type="number" class="form-control progress-rate-input" placeholder="0" min="0" max="100"></td>
                    <td class="progress-table-cell"><input type="number" class="form-control contribution-input" placeholder=""></td>
                    <td class="col-actions"></td>
                </tr>
             </template>
             <template id="expense-row-template-budget">
                <tr>
                    <td><input type="date" class="form-control" value=""></td>
                    <td><input type="text" class="form-control" placeholder="例: 交通費"></td>
                    <td><input type="text" class="form-control" placeholder="内容"></td>
                    <td><input type="number" class="form-control expense-amount-input" placeholder="0"></td>
                    <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                </tr>
            </template>

        </main>
    </div>

    <script src="script.js"></script>
    
    <script>
        // 案件一覧フィルタリング関数 (変更なし)
        function filterProjects() { /* ... */ }

        // 予算タブ用 収支サマリー計算関数 (変更なし)
        function updateBudgetSummary() { /* ... */ }

        // --- タスク定義データ取得 (変更: スキル情報も取得) ---
        function getTaskDefinitions() {
            const definitionTbody = document.getElementById('task-definition-table-body');
            if (!definitionTbody) return [];
            
            const tasks = [];
            const rows = definitionTbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const nameInput = row.querySelector('td:nth-child(1) input.task-name-input');
                const skillCell = row.querySelector('td:nth-child(4)'); // 4番目のセルがスキル
                const skillTags = skillCell ? skillCell.querySelectorAll('.skill-tag') : [];
                const skills = Array.from(skillTags).map(tag => tag.textContent); // スキルテキストを取得

                tasks.push({
                    id: `task-${index}`, // 仮ID
                    name: nameInput ? nameInput.value : `タスク ${index + 1}`,
                    requiredSkills: skills // スキル情報を追加
                });
            });
            return tasks;
        }

        // --- 担当者割当データ取得 (内外製区分を取得) ---
        function getAssigneePlans() {
            const assigneeTbody = document.getElementById('assignee-assignment-table-body');
             if (!assigneeTbody) return {};
             const plans = {};
             const taskDefs = getTaskDefinitions(); // タスク定義からIDと名前を取得

            assigneeTbody.querySelectorAll('tr').forEach((row, index) => {
                 const task = taskDefs[index]; // 対応するタスクを取得
                 if (!task) return;

                 const typeSelect = row.querySelector('.task-type-select'); // 内外製Select
                 const assigneeSelect = row.querySelector('.assignee-select'); // 担当者Select

                 plans[task.id] = {
                     name: task.name,
                     type: typeSelect ? typeSelect.value : 'internal',
                     assignee: assigneeSelect ? assigneeSelect.value : '', // 担当者情報も追加
                     requiredSkills: task.requiredSkills // タスク定義からスキルを継承
                 };
             });
             return plans;
        }

        // --- 予算・原価管理テーブルを描画 ---
        function renderBudgetAllocationTable() {
            const budgetTbody = document.getElementById('budget-allocation-table-body');
            const budgetTemplate = document.getElementById('budget-allocation-row-template');
            if (!budgetTbody || !budgetTemplate) return;

            budgetTbody.innerHTML = ''; // クリア
            const tasks = getTaskDefinitions(); // 最新のタスクリストを取得

            tasks.forEach(task => {
                const clone = budgetTemplate.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                newRow.querySelector('.task-name-readonly').textContent = task.name;
                // TODO: 保存された分配額、実績原価を読み込んで設定する
                budgetTbody.appendChild(newRow);
            });
            updateBudgetSummary(); // テーブル描画後にサマリー計算
        }

        // --- 担当者割当テーブルを描画 (変更: 内外製Selectとスキル表示を追加) ---
         function renderAssigneeAssignmentTable() {
            const assigneeTbody = document.getElementById('assignee-assignment-table-body');
            const assigneeTemplate = document.getElementById('assignee-assignment-row-template');
            // ▼▼▼ 変更: getTaskDefinitions を直接使う ▼▼▼
            const taskDefs = getTaskDefinitions(); 
            // ▲▲▲ 変更ここまで ▲▲▲

            if (!assigneeTbody || !assigneeTemplate) return;

            assigneeTbody.innerHTML = ''; // クリア

            // ▼▼▼ 変更: taskDefs をループ ▼▼▼
            taskDefs.forEach(task => { 
                const clone = assigneeTemplate.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                
                newRow.querySelector('.task-name-readonly').textContent = task.name;

                // スキル表示
                 const skillCell = newRow.querySelector('.skill-display-cell');
                 skillCell.innerHTML = ''; // クリア
                 task.requiredSkills.forEach(skillText => {
                     const span = document.createElement('span');
                     span.className = 'skill-tag';
                     span.textContent = skillText;
                     skillCell.appendChild(span);
                 });

                const taskTypeSelect = newRow.querySelector('.task-type-select');
                const assigneeSelect = newRow.querySelector('.assignee-select');
                
                // TODO: 保存された内外製区分を読み込んで設定する
                // const savedType = 'internal'; // 例
                // taskTypeSelect.value = savedType; 

                // 内外製に応じて担当者リストを更新
                updateAssigneeOptions(taskTypeSelect.value, assigneeSelect);
                
                // TODO: 保存された担当者を読み込んで選択状態にする
                // assigneeSelect.value = savedAssignee;

                assigneeTbody.appendChild(newRow);
            });
            // ▲▲▲ 変更ここまで ▲▲▲
        }

        // --- 担当者選択肢を更新するヘルパー関数 ---
        function updateAssigneeOptions(taskType, assigneeSelectElement) {
            assigneeSelectElement.innerHTML = '<option value="">（未割当）</option>'; // クリア
            assigneeSelectElement.dataset.taskType = taskType; // data属性を更新

             if (taskType === 'internal') {
                 // 内製の場合：利用者と職員を追加 (スキル考慮は未実装)
                 const memberOptgroup = document.createElement('optgroup');
                 memberOptgroup.label = '利用者'; 
                 memberOptgroup.appendChild(new Option('青木 誠', 'member:A001'));
                 memberOptgroup.appendChild(new Option('五十嵐 直人', 'member:A002'));
                 memberOptgroup.appendChild(new Option('遠藤 雅彦', 'member:A003'));
                 assigneeSelectElement.appendChild(memberOptgroup);

                 const staffOptgroup = document.createElement('optgroup');
                 staffOptgroup.label = '職員';
                 staffOptgroup.appendChild(new Option('支援員 次郎', 'staff:S002'));
                 staffOptgroup.appendChild(new Option('職業指導員 三郎', 'staff:S003'));
                 assigneeSelectElement.appendChild(staffOptgroup);
             } else { // external
                 // 外注の場合：外注先を追加
                 const partnerOptgroup = document.createElement('optgroup');
                 partnerOptgroup.label = '外注先';
                 partnerOptgroup.appendChild(new Option('〇〇印刷', 'partner:P001'));
                 partnerOptgroup.appendChild(new Option('□□商事', 'partner:P002'));
                 assigneeSelectElement.appendChild(partnerOptgroup);
             }
        }

        // --- 進捗管理テーブルを描画 (変更なし) ---
        function renderProgressManagementTable() {
            const progressTbody = document.getElementById('progress-management-table-body');
            const progressTemplate = document.getElementById('progress-management-row-template');
             if (!progressTbody || !progressTemplate) return;

            progressTbody.innerHTML = ''; // クリア
            const tasks = getTaskDefinitions();

            tasks.forEach(task => {
                const clone = progressTemplate.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                newRow.querySelector('.task-name-readonly').textContent = task.name;
                // TODO: 保存された進捗情報を読み込んで設定する
                progressTbody.appendChild(newRow);
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            // (タブ切り替えロジック - 上記で修正済み) ...
            // (案件一覧フィルタリング - 変更なし) ...
            // (基本情報モーダル保存 - 変更なし) ...
            // (工程管理テーブル 行追加・削除 - 変更なし) ...
            // (収支管理タブ 計算 - 変更なしだが、予算タブと役割分担が必要) ...

            // --- タスク定義テーブル 行追加・削除 ---
            if (window.setupTableRowAdder) {
                setupTableRowAdder('task-definition-table-body', 'add-task-definition-row', 'task-definition-row-template');
            }
             // タスク定義が変更されたら他のタブも更新
            const taskDefTbody = document.getElementById('task-definition-table-body');
            if (taskDefTbody) {
                 // 行追加/削除時の更新 (MutationObserver)
                const observer = new MutationObserver((mutations) => {
                    // 追加・削除があった場合のみ再描画
                    if (mutations.some(m => m.type === 'childList')) {
                        renderBudgetAllocationTable();
                        renderAssigneeAssignmentTable();
                        renderProgressManagementTable();
                    }
                });
                observer.observe(taskDefTbody, { childList: true }); 

                 // Input変更時の更新 (イベント委任)
                 taskDefTbody.addEventListener('input', (e) => { 
                     if (e.target.classList.contains('task-name-input')) { // タスク名変更時のみ
                        // 少し遅延させて、入力完了後に再描画
                        setTimeout(() => {
                            renderBudgetAllocationTable();
                            renderAssigneeAssignmentTable();
                            renderProgressManagementTable();
                        }, 300); 
                    }
                 });
                  // スキル選択ボタンのダミー処理はHTML側にonclickで記述済み
                  // TODO: スキル選択後のコールバックで担当者タブを更新する renderAssigneeAssignmentTable();
            }

            // --- 予算・原価管理タブ ---
            const budgetTbody = document.getElementById('budget-allocation-table-body');
            const expenseTbodyBudget = document.getElementById('expense-table-body-budget');
            const revenueInputBudget = document.getElementById('project-revenue-input-budget');

            // 予算分配額変更時のサマリー更新
            if(budgetTbody) {
                 budgetTbody.addEventListener('input', (e) => {
                    if (e.target.classList.contains('budget-allocation-input')) {
                        updateBudgetSummary();
                    }
                 });
            }
             // その他経費テーブル 行追加・削除
            if (window.setupTableRowAdder) {
                setupTableRowAdder('expense-table-body-budget', 'add-expense-row-budget', 'expense-row-template-budget');
            }
            // その他経費変更・削除時のサマリー更新
            if (expenseTbodyBudget) {
                expenseTbodyBudget.addEventListener('input', (e) => {
                     if (e.target.classList.contains('expense-amount-input')) {
                         updateBudgetSummary();
                     }
                 });
                 expenseTbodyBudget.addEventListener('click', (e) => {
                     if (e.target.closest('.button-danger')) {
                         setTimeout(updateBudgetSummary, 50); 
                     }
                 });
                 const addExpenseButton = document.getElementById('add-expense-row-budget');
                 if(addExpenseButton){
                     addExpenseButton.addEventListener('click', () => {
                         setTimeout(updateBudgetSummary, 50);
                     });
                 }
            }
            // 受注金額変更時のサマリー更新
             if(revenueInputBudget) {
                 revenueInputBudget.addEventListener('input', updateBudgetSummary);
             }
             // 初期計算実行
             updateBudgetSummary();

             // --- 担当者割当タブ ---
             const assigneeTbody = document.getElementById('assignee-assignment-table-body');
             if (assigneeTbody) {
                 // 内外製Select変更時に担当者選択肢を更新 (イベント委任)
                 assigneeTbody.addEventListener('change', (e) => {
                     if (e.target.classList.contains('task-type-select')) {
                         const assigneeSelect = e.target.closest('tr').querySelector('.assignee-select');
                         if (assigneeSelect) {
                             updateAssigneeOptions(e.target.value, assigneeSelect);
                         }
                     }
                 });
             }

             // --- 初期描画 ---
             renderBudgetAllocationTable(); // 予算タブ
             renderAssigneeAssignmentTable(); // 担当者タブ
             renderProgressManagementTable(); // 進捗タブ

        }); // End of DOMContentLoaded
    </script>
</body>
</html>