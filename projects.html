<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>p2508d - 案件管理モックアップ</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .skill-tag {
            display: inline-block;
            background-color: #e9ecef;
            color: #495057;
            padding: 0.2em 0.6em;
            margin: 0.2em;
            border-radius: 0.25rem;
            font-size: var(--font-size-xs);
        }
        .skill-selection-cell {
            min-height: 40px; 
            vertical-align: middle !important;
        }
        .skill-display-cell {
            text-align: left;
            vertical-align: middle !important;
            font-size: var(--font-size-sm);
        }
        .assignee-select-cell,
        .progress-table-cell {
             vertical-align: middle !important;
        }
         .cost-summary {
             text-align: right;
             font-size: var(--font-size-sm);
             margin-top: 1rem;
             padding-top: 1rem;
             border-top: 1px dashed var(--color-border);
         }
         .cost-summary strong {
             font-size: 1.1em;
             margin-left: 0.5rem;
         }
         .cost-summary .unallocated { color: var(--color-danger); }
         .cost-summary .profit { color: var(--color-primary); }
         .cost-summary .profit-plan { color: var(--color-text-secondary); }

         .filter-form-inline {
            display: flex;
            align-items: flex-end;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .filter-form-inline .form-group {
            margin-bottom: 0;
            flex-grow: 1;
        }
         .filter-form-inline .button-secondary {
             margin-bottom: 0;
             height: calc(1.5em + 1rem + 2px);
             flex-shrink: 0;
         }
        .chart-placeholder { text-align: center; padding: 4rem 1rem; background-color: var(--color-hover-bg); border: 1px dashed var(--color-border); border-radius: var(--border-radius); color: var(--color-text-secondary); font-size: var(--font-size-sm); }
        
        .section-divider {
            margin-top: 2rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 0.5rem;
            font-size: var(--font-size-lg);
            font-weight: 600;
        }
        
        #progress-management-table .readonly-cell {
            text-align: left;
            padding: 0.5rem 0.75rem;
            font-size: var(--font-size-sm);
            vertical-align: middle;
        }
        #progress-management-table .calc-result-cell {
            text-align: right;
            padding: 0.5rem 0.75rem;
            font-weight: 700;
            color: var(--color-primary);
            vertical-align: middle;
        }
        #progress-management-table .form-control {
            text-align: right;
            width: 80px; /* 入力欄の幅を固定 */
            display: inline-block;
        }
        #progress-management-table .progress-delta {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            margin-left: 0.5rem;
            display: inline-block;
            width: 70px; /* 先月比の幅を固定 */
        }
        #progress-management-table .progress-delta.positive {
            color: green;
        }
         #progress-management-table .progress-delta.negative {
            color: red;
        }
        #progress-management-table .assignee-type-cell {
             font-size: var(--font-size-xs);
             color: var(--color-text-secondary);
             padding: 0.5rem 0.75rem;
             vertical-align: middle;
             text-align: center;
        }

        /* ▼▼▼ スキル選択モーダル用スタイル 修正 ▼▼▼ */
        #select-skill-modal .modal-content {
            max-width: 800px;
        }
        .skill-modal-layout {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 1.5rem;
            min-height: 400px;
        }
        .skill-modal-filters {
            border-right: 1px solid var(--color-border);
            padding-right: 1.5rem;
        }
        .skill-modal-list .table-wrapper {
            max-height: 300px;
            overflow-y: auto;
        }
        .skill-modal-list .table th:first-child,
        .skill-modal-list .table td:first-child {
            width: 50px; /* チェックボックス列 */
        }
        /* (追加) スキル名(2)・カテゴリ(3)は自動、レベル(4)を固定 */
        .skill-modal-list .table th:nth-child(4),
        .skill-modal-list .table td:nth-child(4) {
             width: 140px; /* レベル選択プルダウン用 */
        }
        .skill-modal-selected {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }
        .skill-modal-selected h4 {
            font-size: var(--font-size-sm);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        /* (追加) モーダル内テーブル用プルダウンのスタイル調整 */
        .skill-modal-list .form-control {
            padding: 0.25rem 0.5rem;
            font-size: var(--font-size-xs);
            width: 100%;
        }
        /* ▲▲▲ スキル選択モーダル用スタイル 修正 ▲▲▲ */

    </style>
</head>
<body>
    <div class="mockup-container">
        <header class="header">
            <div>
                <h1 class="header-logo"><a href="dashboard.html">p2508d</a></h1>
            </div>

            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="dashboard.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="daily_records.html" class="nav-link">日々の記録</a></li>
                    <li><a href="members_menu.html" class="nav-link">利用者支援</a></li>
                    <li><a href="production_menu.html" class="nav-link">生産活動</a></li>
                    <li><a href="staff_menu.html" class="nav-link">施設と職員</a></li>
                    <li><a href="accounting_menu.html" class="nav-link">会計</a></li>
                    <li><a href="claims.html" class="nav-link">国保連請求</a></li>
                    <li><a href="analytics_menu.html" class="nav-link">データ分析</a></li>
                    <li><a href="settings.html" class="nav-link">設定</a></li>
                    <li><a href="my_page.html" class="nav-link">マイページ</a></li>
                </ul>
                <div class="nav-logout-section">
                    <a href="index.html" class="nav-link">ログアウト</a>
                </div>
            </nav>
        </header>

        <main class="mockup-main">
            <div id="projects" class="mockup-page active">
                <div class="list-page-header">
                    <h1 class="page-title">案件一覧</h1>
                     <div>
                         <a href="production_menu.html" class="button button-secondary" style="margin-right: 0.5rem;">生産活動メニューへ</a>
                         <button class="button button-primary" onclick="alert('新規案件作成画面へ遷移します')">＋ 新規作成</button>
                    </div>
                </div>

                <div class="section">
                    <form class="section-content filter-form-inline" style="margin-bottom: 1.5rem;">
                        <div class="form-group" style="flex-grow: 1.5;">
                            <label for="search-project-name" class="form-label">案件名</label>
                            <input type="text" id="search-project-name" class="form-control" placeholder="案件名で検索...">
                        </div>
                        <div class="form-group" style="flex-grow: 1.5;">
                            <label for="search-client-name" class="form-label">クライアント名</label>
                            <input type="text" id="search-client-name" class="form-control" placeholder="クライアント名で検索...">
                        </div>
                        <div class="form-group">
                            <label for="filter-project-status" class="form-label">ステータス</label>
                            <select id="filter-project-status" class="form-control">
                                <option value="">すべて</option>
                                <option value="未着手">未着手</option>
                                <option value="作業中">作業中</option>
                                <option value="完了">完了</option>
                                <option value="納品済">納品済</option>
                                <option value="キャンセル">キャンセル</option>
                            </select>
                        </div>
                        <button type="button" class="button button-secondary">クリア</button>
                    </form>

                    <div class="table-wrapper">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>案件名</th>
                                    <th>クライアント名</th>
                                    <th>ステータス</th>
                                    <th>納期</th>
                                </tr>
                            </thead>
                             <tbody id="project-list-tbody">
                                <tr class="clickable-row" onclick="showPage('project-detail')">
                                    <td>A社 DM封入作業</td>
                                    <td>株式会社A</td>
                                    <td>作業中</td>
                                    <td>2025.10.31</td>
                                </tr>
                                <tr class="clickable-row" onclick="showPage('project-detail')">
                                    <td>B社 部品組み立て</td>
                                    <td>有限会社B</td>
                                    <td>完了</td>
                                    <td>2025.09.30</td>
                                </tr>
                                 <tr class="clickable-row" onclick="showPage('project-detail')">
                                    <td>C社 データ入力</td>
                                    <td>C-Tech</td>
                                    <td>納品済</td>
                                    <td>2025.09.15</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="project-detail" class="mockup-page">
                <div class="list-page-header">
                    <h1 class="page-title">A社 DM封入作業</h1> <div>
                        <button class="button button-secondary" style="margin-right: 0.5rem;" onclick="showPage('projects')">一覧へ戻る</button>
                        <button type="button" class="button button-danger" onclick="alert('「A社 DM封入作業」のデータを削除します。よろしいですか？')">削除</button>
                    </div>
                </div>

                <div class="sub-nav">
                    <ul id="project-detail-subnav">
                        <li><a href="#" class="sub-nav-item active" data-tab="tab-project-overview">基本情報</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-task-definition">タスク定義</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-budget">予算配分</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-schedule">スケジュール</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-assignee">アサイン</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-progress">進捗管理</a></li>
                        <li><a href="#" class="sub-nav-item" data-tab="tab-project-delivery">納品・請求</a></li>
                    </ul>
                </div>
                <div class="tab-content-wrapper">
                    <div id="tab-project-overview" class="tab-content active">
                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title-in-header">基本情報</h2>
                                <button class="button button-primary" onclick="openModal('edit-project-basic-modal')">編集</button>
                            </div>
                            <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>案件名</dt><dd>A社 DM封入作業</dd>
                                    <dt>顧客</dt><dd>株式会社A</dd>
                                    <dt>ステータス</dt><dd>作業中</dd>
                                    <dt>担当職員</dt><dd>支援員 次郎</dd>
                                    <dt>受注日</dt><dd>2025年10月1日</dd>
                                    <dt>納期</dt><dd>2025年10月31日</dd>
                                    <dt style="align-self: start;">概要</dt>
                                    <dd id="project-summary-display" style="white-space: pre-wrap; align-self: start;">チラシ、挨拶状、返信用封筒の3点をまとめて封入する。宛名ラベルを貼付後、指定の箱に500部ずつ梱包する。</dd>
                                </dl>
                            </div>
                        </div>
                    </div>

                    <div id="tab-project-task-definition" class="tab-content">
                         <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">タスク定義</h2>
                                <button type="button" class="button button-primary" id="add-task-definition-row">＋ タスクを追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="task-definition-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th>作業指示/備考</th>
                                            <th style="width: 250px;">必要スキル</th>
                                            <th class="col-actions">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="task-definition-table-body">
                                         <tr>
                                            <td><input type="text" class="form-control task-name-input" value="チラシ折り"></td>
                                            <td><input type="text" class="form-control" value="三つ折りにする"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">軽作業 Lv.1</span>
                                                    <span class="skill-tag">集中力 Lv.1</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="openModal('select-skill-modal')">スキル選択</button>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                         <tr>
                                            <td><input type="text" class="form-control task-name-input" value="封入"></td>
                                            <td><input type="text" class="form-control" value="チラシ、挨拶状、返信用封筒を封入"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">軽作業 Lv.1</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="openModal('select-skill-modal')">スキル選択</button>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td><input type="text" class="form-control task-name-input" value="宛名貼り"></td>
                                            <td><input type="text" class="form-control" value="指定のラベルを貼付"></td>
                                            <td class="skill-selection-cell">
                                                <div>
                                                    <span class="skill-tag">PC基本操作 Lv.1</span>
                                                    <span class="skill-tag">正確性 Lv.2</span>
                                                </div>
                                                <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="openModal('select-skill-modal')">スキル選択</button>
                                            </td>
                                            <td class="col-actions">
                                                <div class="table-button-group">
                                                    <button type="button" class="button button-danger">削除</button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                             <div class="section-footer">
                                <button type="button" class="button button-primary">タスク定義を保存</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="tab-project-budget" class="tab-content">
                        <div class="section">
                            <h2 class="section-title">総収益見込み</h2>
                            <div class="section-content">
                                 <dl class="detail-grid" style="grid-template-columns: 100px 1fr;">
                                    <dt>受注金額</dt><dd><input type="number" class="form-control" id="project-revenue-input-budget" value="100000"> 円</dd>
                                </dl>
                            </div>
                        </div>
                         <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">予算配分（タスク）</h2>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="budget-allocation-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th>必要スキル</th>
                                            <th style="width: 150px;">分配額(円)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="budget-allocation-table-body">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">予算配分（その他経費）</h2>
                                <button type="button" class="button button-primary" id="add-expense-row-budget-plan">＋ 経費予算を追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="expense-table-budget-plan">
                                    <thead><tr><th>費目</th><th>内容</th><th>金額(円)</th><th class="col-actions">操作</th></tr></thead>
                                    <tbody id="expense-table-body-budget-plan">
                                        <tr>
                                            <td><input type="text" class="form-control" value="材料費"></td>
                                            <td><input type="text" class="form-control" value="封筒・ラベル代 (見込み)"></td>
                                            <td><input type="number" class="form-control expense-amount-input-plan" value="4500"></td>
                                            <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="cost-summary" id="budget-plan-summary">
                            <span>受注金額: <strong id="summary-revenue-plan">100,000</strong>円</span> |
                            <span>予算分配済: <strong id="summary-allocated-plan">0</strong>円</span> |
                            <span class="unallocated">予算未分配: <strong id="summary-unallocated-plan">0</strong>円</span> |
                            <span>その他経費予算: <strong id="summary-other-expense-plan">0</strong>円</span> |
                            <span class="profit-plan">計画利益: <strong id="summary-planned-profit">0</strong>円</span>
                        </div>
                         <div class="section-footer">
                            <button type="button" class="button button-primary">予算計画を保存</button>
                        </div>
                    </div>

                    <div id="tab-project-schedule" class="tab-content">
                         <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">スケジュール</h2>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="schedule-creation-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th>必要スキル</th>
                                            <th style="width: 150px;">予定開始日</th>
                                            <th style="width: 150px;">予定終了日</th>
                                            <th style="width: 120px;">想定工数(H)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="schedule-creation-table-body">
                                    </tbody>
                                </table>
                            </div>
                             <div class="section-footer">
                                <button type="button" class="button button-primary">スケジュールを保存</button>
                            </div>
                        </div>
                    </div>

                    <div id="tab-project-assignee" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">アサイン</h2>
                            <div class="table-wrapper">
                                <table class="table" id="assignee-assignment-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th style="width: 150px;">担当者種別</th> 
                                            <th style="width: 300px;">必要スキル</th>
                                            <th style="width: 250px;">担当者</th>
                                            <th class="col-actions">操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="assignee-assignment-table-body">
                                    </tbody>
                                </table>
                            </div>
                            <div class="section-footer">
                                <button type="button" class="button button-primary">アサインを保存</button>
                            </div>
                        </div>
                    </div>


                    <div id="tab-project-progress" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">進捗管理</h2>
                             <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                                 <label for="progress-month-select-progress" class="form-label" style="margin-bottom: 0;">対象月:</label>
                                 <input type="month" id="progress-month-select-progress" class="form-control" value="2025-10" style="width: auto;">
                             </div>
                            <div class="table-wrapper">
                                <table class="table" id="progress-management-table">
                                    <thead>
                                        <tr>
                                            <th>タスク名</th>
                                            <th>担当者</th>
                                            <th>担当者種別</th>
                                            <th>進捗率(%)</th>
                                            <th>貢献度(%)</th>
                                            <th>算定インセンティブ(円)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="progress-management-table-body">
                                        </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="section">
                            <h2 class="section-title">進捗サマリー（ガントチャート）</h2>
                            <div class="section-content">
                                <div class="chart-placeholder">（「スケジュール」タブの予定期間と「進捗管理」タブの進捗率に基づいたガントチャートがここに表示されます）</div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="list-page-header" style="margin-bottom: 1rem;">
                                <h2 class="section-title" style="margin: 0; border: none;">その他経費（実績）</h2>
                                <button type="button" class="button button-primary" id="add-expense-row-actual">＋ 経費実績を追加</button>
                            </div>
                            <div class="table-wrapper">
                                <table class="table" id="expense-table-actual">
                                    <thead><tr><th>日付</th><th>費目</th><th>内容</th><th>金額(円)</th><th class="col-actions">操作</th></tr></thead>
                                    <tbody id="expense-table-body-actual">
                                        <tr>
                                            <td><input type="date" class="form-control" value="2025-10-02"></td>
                                            <td><input type="text" class="form-control" value="材料費"></td>
                                            <td><input type="text" class="form-control" value="封筒・ラベル代"></td>
                                            <td><input type="number" class="form-control expense-amount-input-actual" value="5000"></td>
                                            <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="cost-summary" id="actual-revenue-summary">
                            <span>受注金額: <strong id="summary-revenue-actual">100,000</strong>円</span> |
                            <span>その他経費実績: <strong id="summary-other-expense-actual">5,000</strong>円</span> |
                            <span class="profit">実績利益: <strong id="summary-actual-profit">0</strong>円</span>
                        </div>

                        <div class="section-footer">
                            <button type="button" class="button button-primary">進捗管理情報を保存</button>
                        </div>
                    </div>

                    <div id="tab-project-delivery" class="tab-content">
                         <div class="section">
                            <h2 class="section-title">納品情報</h2>
                             <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>納品日</dt>
                                    <dd>
                                        <input type="date" id="delivery-date" class="form-control"> <button type="button" class="button button-clear" id="clear-delivery-date">クリア</button>
                                    </dd>
                                    <dt>納品ステータス</dt>
                                    <dd><span id="delivery-status-text">未納品</span></dd>
                                </dl>
                            </div>
                        </div>
                        <div class="section">
                            <h2 class="section-title">請求情報</h2>
                             <div class="section-content">
                                <dl class="detail-grid">
                                    <dt>請求日</dt>
                                    <dd>
                                        <input type="date" id="billing-date" class="form-control"> <button type="button" class="button button-clear" id="clear-billing-date">クリア</button>
                                    </dd>
                                    <dt>入金ステータス</dt>
                                    <dd><span id="payment-status-text">未請求</span></dd>
                                </dl>
                            </div>
                        </div>
                        <div class="section-footer">
                            <button type="button" class="button button-primary">納品・請求情報を保存</button>
                        </div>
                    </div>

                </div>
            </div>

            <div id="edit-project-basic-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">案件 基本情報編集</h2>
                        <span class="modal-close" onclick="closeModal('edit-project-basic-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="edit-project-name" class="form-label">案件名</label>
                            <input type="text" id="edit-project-name" class="form-control" value="A社 DM封入作業">
                        </div>
                        <div class="form-group">
                             <label for="edit-project-client" class="form-label">顧客</label>
                             <select id="edit-project-client" class="form-control">
                                 <option value="client-a" selected>株式会社A</option>
                                 <option value="client-b">有限会社B</option>
                                 <option value="client-c">C-Tech</option>
                                 <option value="partner-d">□□商事</option>
                             </select>
                        </div>
                         <div class="form-group">
                            <label for="edit-project-status" class="form-label">ステータス</label>
                            <select id="edit-project-status" class="form-control">
                                <option value="未着手">未着手</option>
                                <option value="作業中" selected>作業中</option>
                                <option value="完了">完了</option>
                                <option value="納品済">納品済</option>
                                <option value="キャンセル">キャンセル</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-project-staff" class="form-label">担当職員</label>
                             <select id="edit-project-staff" class="form-control">
                                 <option value="staff-taro">管理者 太郎</option>
                                 <option value="staff-jiro" selected>支援員 次郎</option>
                                 <option value="staff-saburo">職業指導員 三郎</option>
                             </select>
                        </div>
                        <div class="form-group">
                            <label for="edit-project-order-date" class="form-label">受注日</label>
                            <input type="date" id="edit-project-order-date" class="form-control" value="2025-10-01">
                        </div>
                        <div class="form-group">
                            <label for="edit-project-due-date" class="form-label">納期</label>
                            <input type="date" id="edit-project-due-date" class="form-control" value="2025-10-31">
                        </div>
                         <div class="form-group">
                            <label for="edit-project-summary-textarea" class="form-label">概要</label>
                            <textarea id="edit-project-summary-textarea" class="form-control" rows="5">チラシ、挨拶状、返信用封筒の3点をまとめて封入する。宛名ラベルを貼付後、指定の箱に500部ずつ梱包する。</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button button-secondary" onclick="closeModal('edit-project-basic-modal')">キャンセル</button>
                        <button type="button" class="button button-primary">保存</button>
                    </div>
                </div>
            </div>

            <div id="select-skill-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">必要スキル選択（タスク名: ...）</h2>
                        <span class="modal-close" onclick="closeModal('select-skill-modal')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="skill-modal-layout">
                            <div class="skill-modal-filters">
                                <div class="form-group">
                                    <label for="skill-modal-search-name" class="form-label">スキル名検索</label>
                                    <input type="text" id="skill-modal-search-name" class="form-control" placeholder="スキル名...">
                                </div>
                                <div class="form-group">
                                    <label for="skill-modal-search-category" class="form-label">カテゴリ</label>
                                    <select id="skill-modal-search-category" class="form-control">
                                        <option value="">すべて</option>
                                        <option value="pc">PC基本操作</option>
                                        <option value="office">Officeソフト</option>
                                        <option value="work">軽作業</option>
                                        <option value="business">ビジネスマナー</option>
                                    </select>
                                </div>
                            </div>
                            <div class="skill-modal-list">
                                <div class="table-wrapper">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th><input type="checkbox"></th>
                                                <th>スキル名</th>
                                                <th>カテゴリ</th>
                                                <th>レベル</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><input type="checkbox"></td>
                                                <td style="text-align: left;">タイピング (かな)</td>
                                                <td>PC基本操作</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1">Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox" checked></td>
                                                <td style="text-align: left;">Word (基本文書作成)</td>
                                                <td>Officeソフト</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1" selected>Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox" checked></td>
                                                <td style="text-align: left;">軽作業 (梱包)</td>
                                                <td>軽作業</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1" selected>Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox"></td>
                                                <td style="text-align: left;">電話応対</td>
                                                <td>ビジネスマナー</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1">Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="checkbox"></td>
                                                <td style="text-align: left;">Excel (SUM関数)</td>
                                                <td>Officeソフト</td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="">未選択</option>
                                                        <option value="lv0">Lv.0 (見学)</option>
                                                        <option value="lv1">Lv.1 (要支援)</option>
                                                        <option value="lv2">Lv.2 (自立)</option>
                                                        <option value="lv3">Lv.3 (指導可)</option>
                                                    </select>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="skill-modal-selected">
                                    <h4>選択中のスキル</h4>
                                    <div>
                                        <span class="skill-tag">Word (基本文書作成) - Lv.1</span>
                                        <span class="skill-tag">軽作業 (梱包) - Lv.1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="button button-secondary" onclick="closeModal('select-skill-modal')">キャンセル</button>
                        <button type="button" class="button button-primary">決定</button>
                    </div>
                </div>
            </div>
            <template id="task-definition-row-template">
                <tr>
                    <td><input type="text" class="form-control task-name-input" placeholder="新規タスク名"></td>
                    <td><input type="text" class="form-control" placeholder="作業指示や備考を入力"></td>
                    <td class="skill-selection-cell">
                        <div></div>
                        <button type="button" class="button button-secondary" style="font-size: var(--font-size-xs); padding: 0.2rem 0.5rem; margin-top: 0.2rem;" onclick="openModal('select-skill-modal')">スキル選択</button>
                    </td>
                    <td class="col-actions">
                        <div class="table-button-group">
                            <button type="button" class="button button-danger">削除</button>
                        </div>
                    </td>
                </tr>
            </template>
            
            <template id="schedule-creation-row-template">
                <tr>
                    <td style="text-align: left;" class="task-name-readonly">（タスク名）</td>
                    <td class="skill-display-cell"></td>
                    <td><input type="date" class="form-control schedule-start-date-input"></td>
                    <td><input type="date" class="form-control schedule-end-date-input"></td>
                    <td><input type="number" class="form-control schedule-effort-input" placeholder="0"></td>
                </tr>
            </template>

            <template id="budget-allocation-row-template">
                 <tr>
                    <td style="text-align: left;" class="task-name-readonly">（タスク名）</td>
                    <td class="skill-display-cell"></td>
                    <td><input type="number" class="form-control budget-allocation-input" placeholder="0"></td>
                </tr>
            </template>

            <template id="assignee-assignment-row-template">
                 <tr>
                    <td style="text-align: left;" class="task-name-readonly">（タスク名）</td>
                    <td>
                        <select class="form-control assignee-type-select">
                            <option value="member" selected>利用者</option>
                            <option value="staff">職員</option>
                            <option value="partner">外注先</option>
                            <option value="customer">顧客</option>
                        </select>
                    </td>
                    <td class="skill-display-cell">
                         </td>
                    <td class="assignee-select-cell">
                        <select class="form-control assignee-select" data-task-type="member"> <option value="">（未割当）</option>
                        </select>
                    </td>
                     <td class="col-actions">
                         <div class="table-button-group">
                            <button type="button" class="button button-clear" style="border: 1px solid var(--color-border); color: var(--color-text-secondary); font-size: var(--font-size-xs);" onclick="this.closest('tr').querySelector('.assignee-select').value=''">クリア</button>
                        </div>
                    </td>
                </tr>
             </template>
             <template id="progress-management-row-template">
                 <tr>
                    <td class="readonly-cell" data-field="taskName">（タスク名）</td>
                    <td class="readonly-cell" data-field="assigneeName">（担当者）</td>
                    <td class="assignee-type-cell" data-field="assigneeType">（種別）</td>
                    <td class="progress-table-cell">
                        <input type="number" class="form-control progress-rate-input" placeholder="0" min="0" max="100">
                        <span class="progress-delta"></span>
                    </td>
                    <td class="progress-table-cell">
                        <input type="number" class="form-control contribution-input" placeholder="100" min="0" max="100">
                    </td>
                    <td class="calc-result-cell" data-field="calculatedIncentive">0</td>
                </tr>
             </template>

             <template id="expense-row-template-plan">
                <tr>
                    <td><input type="text" class="form-control" placeholder="例: 交通費"></td>
                    <td><input type="text" class="form-control" placeholder="内容"></td>
                    <td><input type="number" class="form-control expense-amount-input-plan" placeholder="0"></td>
                    <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                </tr>
            </template>
             <template id="expense-row-template-actual">
                <tr>
                    <td><input type="date" class="form-control" value=""></td>
                    <td><input type="text" class="form-control" placeholder="例: 交通費"></td>
                    <td><input type="text" class="form-control" placeholder="内容"></td>
                    <td><input type="number" class="form-control expense-amount-input-actual" placeholder="0"></td>
                    <td class="col-actions"><div class="table-button-group"><button type="button" class="button button-danger">削除</button></div></td>
                </tr>
            </template>

        </main>
    </div>

    <script src="script.js"></script>

    <script>
        function filterProjects() {
            const nameInput = document.getElementById('search-project-name');
            const clientInput = document.getElementById('search-client-name');
            const statusSelect = document.getElementById('filter-project-status');
            const tableBody = document.getElementById('project-list-tbody');

            if (!nameInput || !clientInput || !statusSelect || !tableBody) return;

            const nameFilter = nameInput.value.toLowerCase();
            const clientFilter = clientInput.value.toLowerCase();
            const statusFilter = statusSelect.value;
            const rows = tableBody.getElementsByTagName('tr');

            Array.from(rows).forEach(row => {
                const projectName = row.cells[0]?.textContent.toLowerCase() || '';
                const clientName = row.cells[1]?.textContent.toLowerCase() || '';
                const status = row.cells[2]?.textContent || '';

                const nameMatch = projectName.includes(nameFilter);
                const clientMatch = clientName.includes(clientFilter);
                const statusMatch = statusFilter === "" || status === statusFilter;

                row.style.display = (nameMatch && clientMatch && statusMatch) ? '' : 'none';
            });
        }

        function updateBudgetSummary() {
            const revenueInput = document.getElementById('project-revenue-input-budget');
            const budgetAllocationTbody = document.getElementById('budget-allocation-table-body');
            const expensePlanTbody = document.getElementById('expense-table-body-budget-plan');
            
            const summaryRevenuePlan = document.getElementById('summary-revenue-plan');
            const summaryAllocatedPlan = document.getElementById('summary-allocated-plan');
            const summaryUnallocatedPlan = document.getElementById('summary-unallocated-plan');
            const summaryOtherExpensePlan = document.getElementById('summary-other-expense-plan');
            const summaryPlannedProfit = document.getElementById('summary-planned-profit');

            if (!revenueInput || !budgetAllocationTbody || !expensePlanTbody || !summaryRevenuePlan) return;

            let totalRevenue = parseFloat(revenueInput.value) || 0;

            let totalAllocatedPlan = 0;
            budgetAllocationTbody.querySelectorAll('.budget-allocation-input').forEach(input => {
                totalAllocatedPlan += parseFloat(input.value) || 0;
            });

            let totalExpensePlan = 0;
            expensePlanTbody.querySelectorAll('.expense-amount-input-plan').forEach(input => {
                totalExpensePlan += parseFloat(input.value) || 0;
            });

            let unallocatedPlan = totalRevenue - totalAllocatedPlan;
            let plannedProfit = totalRevenue - totalAllocatedPlan - totalExpensePlan;

            summaryRevenuePlan.textContent = totalRevenue.toLocaleString();
            summaryAllocatedPlan.textContent = totalAllocatedPlan.toLocaleString();
            summaryUnallocatedPlan.textContent = unallocatedPlan.toLocaleString();
            summaryOtherExpensePlan.textContent = totalExpensePlan.toLocaleString();
            summaryPlannedProfit.textContent = plannedProfit.toLocaleString();
        }

        function updateActualSummary() {
            const revenueInput = document.getElementById('project-revenue-input-budget');
            const expenseActualTbody = document.getElementById('expense-table-body-actual');
            const summaryRevenueActual = document.getElementById('summary-revenue-actual');
            const summaryOtherExpenseActual = document.getElementById('summary-other-expense-actual');
            const summaryActualProfit = document.getElementById('summary-actual-profit');

            if (!revenueInput || !expenseActualTbody || !summaryRevenueActual || !summaryOtherExpenseActual || !summaryActualProfit) {
                return;
            }

            let totalRevenue = parseFloat(revenueInput.value) || 0;
            let totalExpenseActual = 0;
            expenseActualTbody.querySelectorAll('.expense-amount-input-actual').forEach(input => {
                totalExpenseActual += parseFloat(input.value) || 0;
            });

            let actualProfit = totalRevenue - totalExpenseActual;

            summaryRevenueActual.textContent = totalRevenue.toLocaleString();
            summaryOtherExpenseActual.textContent = totalExpenseActual.toLocaleString();
            summaryActualProfit.textContent = actualProfit.toLocaleString();
        }


        function getTaskDefinitions() {
            const definitionTbody = document.getElementById('task-definition-table-body');
            if (!definitionTbody) return [];

            const tasks = [];
            const rows = definitionTbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                const nameInput = row.querySelector('td:nth-child(1) input.task-name-input');
                const skillCell = row.querySelector('.skill-selection-cell > div'); 
                const skillsHtml = skillCell ? skillCell.innerHTML : ''; 

                tasks.push({
                    id: `task-${index}`,
                    name: nameInput ? nameInput.value : `タスク ${index + 1}`,
                    requiredSkillsHtml: skillsHtml 
                });
            });
            return tasks;
        }
        
        function getScheduleData() {
            const scheduleTbody = document.getElementById('schedule-creation-table-body');
            if (!scheduleTbody) return {};
            
            const scheduleMap = {};
            scheduleTbody.querySelectorAll('tr').forEach(row => {
                const taskName = row.querySelector('.task-name-readonly')?.textContent;
                const startDate = row.querySelector('.schedule-start-date-input')?.value;
                const endDate = row.querySelector('.schedule-end-date-input')?.value;
                if (taskName) {
                    scheduleMap[taskName] = { startDate, endDate };
                }
            });
            return scheduleMap;
        }

        function getAssigneePlans() {
            const assigneeTbody = document.getElementById('assignee-assignment-table-body');
             if (!assigneeTbody) return [];
             
             const taskDefs = getTaskDefinitions();
             const plans = []; 

            assigneeTbody.querySelectorAll('tr').forEach((row, index) => {
                 const task = taskDefs[index]; 
                 if (!task) return;

                 const typeSelect = row.querySelector('.assignee-type-select'); // 修正
                 const assigneeSelect = row.querySelector('.assignee-select');
                 
                 let assigneeId = assigneeSelect ? assigneeSelect.value : '';
                 let assigneeName = assigneeSelect && assigneeSelect.value ? assigneeSelect.options[assigneeSelect.selectedIndex].text : '（未割当）';
                 let taskType = typeSelect ? typeSelect.value : 'member'; 
                 let assigneeType = '（未割当）'; 

                 if (taskType === 'member') {
                     assigneeType = '利用者';
                     if (!assigneeId.startsWith('member:')) assigneeName = '（未割当）';
                 } else if (taskType === 'staff') {
                     assigneeType = '職員';
                     if (!assigneeId.startsWith('staff:')) assigneeName = '（未割当）';
                 } else if (taskType === 'partner') {
                     assigneeType = '外注先';
                     if (!assigneeId.startsWith('partner:')) assigneeName = '（未割当）';
                 } else if (taskType === 'customer') {
                     assigneeType = '顧客';
                     if (!assigneeId.startsWith('customer:')) assigneeName = '（未割当）';
                 }

                 plans.push({
                     taskName: task.name,
                     assigneeId: assigneeId,
                     assigneeName: assigneeName,
                     assigneeType: assigneeType,
                     requiredSkillsHtml: task.requiredSkillsHtml // スキル情報も渡す
                 });
             });
             return plans;
        }

        function getBudgetData() {
            const budgetTbody = document.getElementById('budget-allocation-table-body');
            if (!budgetTbody) return {};
            
            const budgetMap = {};
            budgetTbody.querySelectorAll('tr').forEach(row => {
                const taskName = row.querySelector('.task-name-readonly')?.textContent;
                const budgetInput = row.querySelector('.budget-allocation-input');
                if (taskName && budgetInput) {
                    budgetMap[taskName] = parseFloat(budgetInput.value) || 0;
                }
            });
            return budgetMap;
        }


        function renderScheduleCreationTable() {
            const scheduleTbody = document.getElementById('schedule-creation-table-body');
            const scheduleTemplate = document.getElementById('schedule-creation-row-template');
            if (!scheduleTbody || !scheduleTemplate) return;

            const tasks = getTaskDefinitions();
            
            const existingData = {};
            scheduleTbody.querySelectorAll('tr').forEach(row => {
                const taskName = row.querySelector('.task-name-readonly').textContent;
                existingData[taskName] = {
                    startDate: row.querySelector('.schedule-start-date-input').value,
                    endDate: row.querySelector('.schedule-end-date-input').value,
                    effort: row.querySelector('.schedule-effort-input').value,
                };
            });

            scheduleTbody.innerHTML = '';

            tasks.forEach(task => {
                const clone = scheduleTemplate.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                newRow.querySelector('.task-name-readonly').textContent = task.name;
                
                const skillCell = newRow.querySelector('.skill-display-cell');
                if (skillCell) skillCell.innerHTML = task.requiredSkillsHtml;

                if (existingData[task.name]) {
                    newRow.querySelector('.schedule-start-date-input').value = existingData[task.name].startDate;
                    newRow.querySelector('.schedule-end-date-input').value = existingData[task.name].endDate;
                    newRow.querySelector('.schedule-effort-input').value = existingData[task.name].effort;
                } else if (task.name === 'チラシ折り') {
                    newRow.querySelector('.schedule-start-date-input').value = '2025-10-01';
                    newRow.querySelector('.schedule-end-date-input').value = '2025-10-10';
                    newRow.querySelector('.schedule-effort-input').value = '20';
                } else if (task.name === '封入') {
                    newRow.querySelector('.schedule-start-date-input').value = '2025-10-11';
                    newRow.querySelector('.schedule-end-date-input').value = '2025-10-25';
                    newRow.querySelector('.schedule-effort-input').value = '40';
                } else if (task.name === '宛名貼り') {
                    newRow.querySelector('.schedule-start-date-input').value = '2025-10-26';
                    newRow.querySelector('.schedule-end-date-input').value = '2025-10-31';
                    newRow.querySelector('.schedule-effort-input').value = '15';
                }
                
                scheduleTbody.appendChild(newRow);
            });
        }

        function renderBudgetAllocationTable() {
            const budgetTbody = document.getElementById('budget-allocation-table-body');
            const budgetTemplate = document.getElementById('budget-allocation-row-template');
            if (!budgetTbody || !budgetTemplate) return;

            const tasks = getTaskDefinitions();
            
            const existingData = {};
            budgetTbody.querySelectorAll('tr').forEach(row => {
                const taskName = row.querySelector('.task-name-readonly').textContent;
                const value = row.querySelector('.budget-allocation-input').value;
                existingData[taskName] = value;
            });

            budgetTbody.innerHTML = '';

            tasks.forEach(task => {
                const clone = budgetTemplate.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                newRow.querySelector('.task-name-readonly').textContent = task.name;

                const skillCell = newRow.querySelector('.skill-display-cell');
                if (skillCell) skillCell.innerHTML = task.requiredSkillsHtml;

                if (existingData[task.name]) {
                    newRow.querySelector('.budget-allocation-input').value = existingData[task.name];
                } else if (task.name === 'チラシ折り') {
                    newRow.querySelector('.budget-allocation-input').value = '20000';
                } else if (task.name === '封入') {
                    newRow.querySelector('.budget-allocation-input').value = '30000';
                } else if (task.name === '宛名貼り') {
                    newRow.querySelector('.budget-allocation-input').value = '10000';
                }

                budgetTbody.appendChild(newRow);
            });
            updateBudgetSummary();
        }

         function renderAssigneeAssignmentTable() {
            const assigneeTbody = document.getElementById('assignee-assignment-table-body');
            const assigneeTemplate = document.getElementById('assignee-assignment-row-template');
            const taskDefs = getTaskDefinitions();

            if (!assigneeTbody || !assigneeTemplate) return;
            
            const existingData = {};
            assigneeTbody.querySelectorAll('tr').forEach(row => {
                const taskName = row.querySelector('.task-name-readonly').textContent;
                const type = row.querySelector('.assignee-type-select').value; // 修正
                const assignee = row.querySelector('.assignee-select').value;
                existingData[taskName] = { type, assignee };
            });

            assigneeTbody.innerHTML = '';

            taskDefs.forEach(task => {
                const clone = assigneeTemplate.content.cloneNode(true);
                const newRow = clone.querySelector('tr');

                newRow.querySelector('.task-name-readonly').textContent = task.name;

                const skillCell = newRow.querySelector('.skill-display-cell');
                skillCell.innerHTML = task.requiredSkillsHtml; 

                const taskTypeSelect = newRow.querySelector('.assignee-type-select'); // 修正
                const assigneeSelect = newRow.querySelector('.assignee-select');
                
                const taskData = existingData[task.name];
                let taskType = taskData ? taskData.type : 'member'; 

                if (!taskData) {
                    if (task.name === '封入') {
                        taskType = 'staff'; 
                    } else if (task.name === '宛名貼り') {
                        taskType = 'partner'; 
                    }
                }

                taskTypeSelect.value = taskType; // 種別プルダウンの値を設定
                updateAssigneeOptions(taskType, assigneeSelect); // オプションを更新
                
                if (taskData) {
                    // taskTypeSelect.value = taskData.type; // (上で設定済み)
                    assigneeSelect.value = taskData.assignee;
                } else if (task.name === 'チラシ折り') {
                    // taskTypeSelect.value = 'member'; // (デフォルト)
                    assigneeSelect.value = 'member:A001';
                } else if (task.name === '封入') {
                    // taskTypeSelect.value = 'staff'; // (設定済み)
                    assigneeSelect.value = 'staff:S002'; // 支援員 次郎
                } else if (task.name === '宛名貼り') {
                    // taskTypeSelect.value = 'partner'; // (設定済み)
                    assigneeSelect.value = 'partner:P001'; // 〇〇印刷
                }

                assigneeTbody.appendChild(newRow);
            });
        }

        // ▼▼▼ 修正: updateAssigneeOptions のロジック修正 ▼▼▼
        function updateAssigneeOptions(assigneeType, assigneeSelectElement) {
            assigneeSelectElement.innerHTML = '<option value="">（未割当）</option>';
            assigneeSelectElement.dataset.taskType = assigneeType; 

             if (assigneeType === 'member') {
                 const memberOptgroup = document.createElement('optgroup');
                 memberOptgroup.label = '利用者';
                 memberOptgroup.appendChild(new Option('青木 誠', 'member:A001'));
                 memberOptgroup.appendChild(new Option('五十嵐 直人', 'member:A002'));
                 memberOptgroup.appendChild(new Option('遠藤 雅彦', 'member:A003'));
                 assigneeSelectElement.appendChild(memberOptgroup);
             } else if (assigneeType === 'staff') {
                 const staffOptgroup = document.createElement('optgroup');
                 staffOptgroup.label = '職員';
                 staffOptgroup.appendChild(new Option('管理者 太郎', 'staff:S001')); 
                 staffOptgroup.appendChild(new Option('支援員 次郎', 'staff:S002'));
                 staffOptgroup.appendChild(new Option('職業指導員 三郎', 'staff:S003'));
                 assigneeSelectElement.appendChild(staffOptgroup);
             } else if (assigneeType === 'partner') {
                 const partnerOptgroup = document.createElement('optgroup');
                 partnerOptgroup.label = '外注先';
                 partnerOptgroup.appendChild(new Option('〇〇印刷', 'partner:P001'));
                 partnerOptgroup.appendChild(new Option('□□商事', 'partner:P002'));
                 assigneeSelectElement.appendChild(partnerOptgroup);
             } else if (assigneeType === 'customer') {
                 const customerOptgroup = document.createElement('optgroup');
                 customerOptgroup.label = '顧客';
                 customerOptgroup.appendChild(new Option('株式会社A', 'customer:C001'));
                 customerOptgroup.appendChild(new Option('有限会社B', 'customer:C002'));
                 customerOptgroup.appendChild(new Option('C-Tech', 'customer:C003'));
                 assigneeSelectElement.appendChild(customerOptgroup);
             }
        }
        // ▲▲▲ 修正 ▲▲▲

        function renderProgressManagementTable() {
            const tableBody = document.getElementById('progress-management-table-body');
            const template = document.getElementById('progress-management-row-template');
            
            if (!tableBody || !template) return;

            const assigneePlans = getAssigneePlans(); 
            const budgetMap = getBudgetData();     
            
            const currentMonthProgressData = {
                "チラシ折り": { progress: 100, contribution: 100 }, // 利用者
                "封入": { progress: 50, contribution: 90 }, // 職員
                "宛名貼り": { progress: 10, contribution: 100 } // 外注先
            };
            const lastMonthProgressData = {
                 "チラシ折り": { progress: 50 },
                 "封入": { progress: 20 },
                 "宛名貼り": { progress: 0 }
            };

            tableBody.innerHTML = '';
            
            assigneePlans.forEach(plan => {
                const clone = template.content.cloneNode(true);
                const newRow = clone.querySelector('tr');
                
                const taskBudget = budgetMap[plan.taskName] || 0;
                const currentData = currentMonthProgressData[plan.taskName] || { progress: 0, contribution: 100 };
                const lastMonthData = lastMonthProgressData[plan.taskName] || { progress: 0 };

                newRow.querySelector('[data-field="taskName"]').textContent = plan.taskName;
                newRow.querySelector('[data-field="assigneeName"]').textContent = plan.assigneeName;
                newRow.querySelector('[data-field="assigneeType"]').textContent = `(${plan.assigneeType})`;
                
                newRow.dataset.taskBudget = taskBudget;
                newRow.dataset.lastMonthProgress = lastMonthData.progress; 
                newRow.dataset.assigneeType = plan.assigneeType; 

                const progressInput = newRow.querySelector('.progress-rate-input');
                progressInput.value = currentData.progress;
                
                const deltaSpan = newRow.querySelector('.progress-delta');
                const delta = currentData.progress - lastMonthData.progress;
                deltaSpan.textContent = `(${delta >= 0 ? '+' : ''}${delta}%)`;
                deltaSpan.className = delta > 0 ? 'progress-delta positive' : (delta < 0 ? 'progress-delta negative' : 'progress-delta');

                const contributionInput = newRow.querySelector('.contribution-input');
                contributionInput.value = currentData.contribution;

                if (plan.assigneeType !== '利用者') {
                    progressInput.disabled = true;
                    contributionInput.disabled = true;
                    deltaSpan.textContent = '-'; 
                    deltaSpan.className = 'progress-delta';
                }

                tableBody.appendChild(newRow);
            });
            
            calculateAllIncentives();
        }

        function calculateAllIncentives() {
            const tableBody = document.getElementById('progress-management-table-body');
            if (!tableBody) return;

            tableBody.querySelectorAll('tr').forEach(row => {
                calculateIncentiveForRow(row);
            });
        }
        
        function calculateIncentiveForRow(row) {
            const assigneeType = row.dataset.assigneeType;
            const resultCell = row.querySelector('[data-field="calculatedIncentive"]');
            if (!resultCell) return;
            
            const progressRateInput = row.querySelector('.progress-rate-input');
            const contributionInput = row.querySelector('.contribution-input');
            const deltaSpan = row.querySelector('.progress-delta');

            if (assigneeType !== '利用者') {
                resultCell.textContent = '-'; 
                if (deltaSpan) deltaSpan.textContent = '-';
                if (progressRateInput) progressRateInput.disabled = true;
                if (contributionInput) contributionInput.disabled = true;
                return;
            }

            const budget = parseFloat(row.dataset.taskBudget) || 0;
            const lastMonthProgress = parseFloat(row.dataset.lastMonthProgress) || 0;
            
            if (!progressRateInput || !contributionInput || !deltaSpan) return;

            const currentProgress = parseFloat(progressRateInput.value) || 0;
            const contributionRate = parseFloat(contributionInput.value) || 0;

            const delta = currentProgress - lastMonthProgress;
            deltaSpan.textContent = `(${delta >= 0 ? '+' : ''}${delta}%)`;
            deltaSpan.className = delta > 0 ? 'progress-delta positive' : (delta < 0 ? 'progress-delta negative' : 'progress-delta');

            const progressDelta = Math.max(0, currentProgress - lastMonthProgress); 
            const incentive = budget * (progressDelta / 100) * (contributionRate / 100);
            
            resultCell.textContent = Math.floor(incentive).toLocaleString();
        }


        document.addEventListener('DOMContentLoaded', () => {
            const subNavContainer = document.getElementById('project-detail-subnav');
            const tabContents = document.querySelectorAll('#project-detail .tab-content-wrapper .tab-content');

            if (subNavContainer && tabContents.length > 0) {
                subNavContainer.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.sub-nav-item');
                    if (!navItem || navItem.classList.contains('active')) { return; }
                    e.preventDefault();
                    const targetTabId = navItem.dataset.tab;
                    subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => item.classList.remove('active'));
                    navItem.classList.add('active');
                    tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === targetTabId);
                    });
                    
                    if (targetTabId === 'tab-project-progress') {
                        renderProgressManagementTable();
                    }
                    if (targetTabId === 'tab-project-budget') {
                        renderBudgetAllocationTable();
                    }
                    if (targetTabId === 'tab-project-assignee') {
                        renderAssigneeAssignmentTable();
                    }
                    if (targetTabId === 'tab-project-schedule') {
                        renderScheduleCreationTable();
                    }
                });
            }

            if (typeof window.filterProjects === 'function') {
                const nameInputListener = document.getElementById('search-project-name');
                const clientInputListener = document.getElementById('search-client-name');
                const statusSelectListener = document.getElementById('filter-project-status');
                const clearButton = document.querySelector('#projects .filter-form-inline .button-secondary');

                if (nameInputListener) nameInputListener.addEventListener('input', filterProjects);
                if (clientInputListener) clientInputListener.addEventListener('input', filterProjects);
                if (statusSelectListener) statusSelectListener.addEventListener('change', filterProjects);
                if (clearButton) {
                    clearButton.addEventListener('click', () => {
                        const form = document.querySelector('#projects .filter-form-inline');
                        if (form) form.reset();
                        filterProjects();
                    });
                }
                filterProjects();
            }

             const projectSummaryTextarea = document.getElementById('edit-project-summary-textarea');
             const projectSummaryDisplay = document.getElementById('project-summary-display');
             const saveProjectBasicButton = document.querySelector('#edit-project-basic-modal .button-primary');

             if (saveProjectBasicButton && projectSummaryTextarea && projectSummaryDisplay) {
                 saveProjectBasicButton.addEventListener('click', () => {
                     projectSummaryDisplay.textContent = projectSummaryTextarea.value;
                     closeModal('edit-project-basic-modal');
                 });
             }

            if (window.setupTableRowAdder) {
                setupTableRowAdder('task-definition-table-body', 'add-task-definition-row', 'task-definition-row-template');
                setupTableRowAdder('expense-table-body-budget-plan', 'add-expense-row-budget-plan', 'expense-row-template-plan');
                setupTableRowAdder('expense-table-body-actual', 'add-expense-row-actual', 'expense-row-template-actual');
            }

            const taskDefTbody = document.getElementById('task-definition-table-body');
            if (taskDefTbody) {
                const observer = new MutationObserver((mutations) => {
                    if (mutations.some(m => m.type === 'childList')) {
                        renderScheduleCreationTable();
                        renderBudgetAllocationTable();
                        renderAssigneeAssignmentTable();
                        renderProgressManagementTable(); 
                    }
                });
                observer.observe(taskDefTbody, { childList: true });

                 taskDefTbody.addEventListener('input', (e) => {
                     if (e.target.classList.contains('task-name-input')) {
                        setTimeout(() => {
                            renderScheduleCreationTable();
                            renderBudgetAllocationTable();
                            renderAssigneeAssignmentTable();
                            renderProgressManagementTable();
                        }, 300);
                    }
                 });
                 
                 taskDefTbody.addEventListener('click', (e) => {
                     if(e.target.classList.contains('skill-selection-cell') || e.target.closest('.skill-selection-cell')) {
                         setTimeout(() => {
                             const cell = e.target.closest('.skill-selection-cell');
                             if(cell && !cell.querySelector('.skill-tag[data-skill="dummy"]')) {
                                 // (ダミー) モーダルで選択されたとして、タグを追加
                                 cell.querySelector('div').innerHTML = `
                                     <span class="skill-tag">Word (基本文書作成) - Lv.1</span>
                                     <span class="skill-tag">軽作業 (梱包) - Lv.1</span>
                                 `;
                             }
                             
                             renderScheduleCreationTable();
                             renderBudgetAllocationTable();
                             renderAssigneeAssignmentTable();
                             renderProgressManagementTable();
                         }, 500); 
                     }
                 });
            }
            
            const budgetTab = document.getElementById('tab-project-budget');
            if (budgetTab) {
                budgetTab.addEventListener('input', (e) => {
                    if (e.target.matches('#project-revenue-input-budget, .budget-allocation-input, .expense-amount-input-plan')) {
                        updateBudgetSummary();
                        renderProgressManagementTable(); 
                    }
                });
                budgetTab.addEventListener('click', (e) => {
                     if (e.target.closest('#add-expense-row-budget-plan') || e.target.closest('#expense-table-body-budget-plan .button-danger')) {
                         setTimeout(updateBudgetSummary, 50);
                     }
                 });
            }
            
             const assigneeTbody = document.getElementById('assignee-assignment-table-body');
             if (assigneeTbody) {
                 assigneeTbody.addEventListener('change', (e) => {
                     // ▼▼▼ 修正: `assignee-type-select` に変更 ▼▼▼
                     if (e.target.classList.contains('assignee-type-select')) { 
                         const assigneeSelect = e.target.closest('tr').querySelector('.assignee-select');
                         if (assigneeSelect) {
                             updateAssigneeOptions(e.target.value, assigneeSelect);
                         }
                         renderProgressManagementTable(); // アサインが変わったら再描画
                     } else if (e.target.classList.contains('assignee-select')) {
                         renderProgressManagementTable(); // アサインが変わったら再描画
                     }
                     // ▲▲▲ 修正 ▲▲▲
                 });
             }

            const progressTab = document.getElementById('tab-project-progress');
            if (progressTab) {
                progressTab.addEventListener('input', (e) => {
                    if (e.target.matches('.expense-amount-input-actual')) {
                        updateActualSummary();
                    }
                });
                 progressTab.addEventListener('click', (e) => {
                     if (e.target.closest('#add-expense-row-actual') || e.target.closest('#expense-table-body-actual .button-danger')) {
                         setTimeout(updateActualSummary, 50);
                     }
                 });
                 
                const progressTableBody = document.getElementById('progress-management-table-body');
                if (progressTableBody) {
                    progressTableBody.addEventListener('input', (e) => {
                        if (e.target.classList.contains('progress-rate-input') || e.target.classList.contains('contribution-input')) {
                            const row = e.target.closest('tr');
                            if (row) {
                                calculateIncentiveForRow(row);
                            }
                        }
                    });
                }

                const monthSelector = document.getElementById('progress-month-select-progress');
                if (monthSelector) {
                    monthSelector.addEventListener('change', () => {
                         renderProgressManagementTable();
                    });
                }
            }
             
             updateBudgetSummary();
             updateActualSummary(); 

             const deliveryDateInput = document.getElementById('delivery-date');
             const clearDeliveryDateButton = document.getElementById('clear-delivery-date');
             const deliveryStatusText = document.getElementById('delivery-status-text');

             const billingDateInput = document.getElementById('billing-date');
             const clearBillingDateButton = document.getElementById('clear-billing-date');
             const paymentStatusText = document.getElementById('payment-status-text');

             function updateDeliveryStatus() {
                 if (deliveryDateInput && deliveryStatusText) {
                    deliveryStatusText.textContent = deliveryDateInput.value ? '納品済' : '未納品';
                 }
                 updatePaymentStatus(); 
             }
             function updatePaymentStatus() {
                 if(billingDateInput && paymentStatusText && deliveryDateInput){
                    if(billingDateInput.value){
                        paymentStatusText.textContent = '請求済 (未入金)';
                    } else if (deliveryDateInput.value) {
                         paymentStatusText.textContent = '未請求 (納品済)';
                    } else {
                         paymentStatusText.textContent = '未請求 (未納品)';
                    }
                 }
             }

             if(deliveryDateInput) deliveryDateInput.addEventListener('change', updateDeliveryStatus);
             if(clearDeliveryDateButton) clearDeliveryDateButton.addEventListener('click', () => { deliveryDateInput.value = ''; updateDeliveryStatus(); });
             if(billingDateInput) billingDateInput.addEventListener('change', updatePaymentStatus);
             if(clearBillingDateButton) clearBillingDateButton.addEventListener('click', () => { billingDateInput.value = ''; updatePaymentStatus(); });

             updateDeliveryStatus(); 

             // 初期描画
             renderScheduleCreationTable();
             renderBudgetAllocationTable();
             renderAssigneeAssignmentTable();
             renderProgressManagementTable(); 

        });
    </script>
    </body>
</html>