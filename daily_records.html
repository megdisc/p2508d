<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>p2508d - 記録・書類管理モックアップ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mockup-container">
        <header class="header">
            <div>
                <h1 class="header-logo"><a href="dashboard.html">p2508d</a></h1>
            </div>

            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="dashboard.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="daily_records.html" class="nav-link active">日々の記録</a></li>
                    <li><a href="members_menu.html" class="nav-link">利用者支援</a></li>
                    <li><a href="production_menu.html" class="nav-link">生産活動</a></li>
                    <li><a href="staff_menu.html" class="nav-link">施設と職員</a></li>
                    <li><a href="accounting_menu.html" class="nav-link">会計</a></li>
                    <li><a href="claims.html" class="nav-link">国保連請求</a></li>
                    <li><a href="analytics_menu.html" class="nav-link">データ分析</a></li>
                    <li><a href="settings.html" class="nav-link">設定</a></li>
                    <li><a href="my_page.html" class="nav-link">マイページ</a></li>
                </ul>
                <div class="nav-logout-section">
                    <a href="index.html" class="nav-link">ログアウト</a>
                </div>
            </nav>
            </header>

        <main class="mockup-main">

            <div class="list-page-header" style="margin-bottom: 1.5rem;">
                <h1 class="page-title">日々の記録</h1>
                <div>
                    <button class="button button-primary" id="new-incident-report-button" style="display: none;">＋ 新規報告作成</button>
                </div>
            </div>
            <div class="sub-nav">
                <ul id="records-subnav">
                    <li><a href="#" class="sub-nav-item active" data-tab="tab-daily-logs">業務日誌</a></li>
                    <li><a href="#" class="sub-nav-item" data-tab="tab-incident-reports">ヒヤリハット・事故報告</a></li>
                </ul>
            </div>
            <div class="tab-content-wrapper">

                <div id="tab-daily-logs" class="tab-content active">

                    <div class="section date-selector-section" style="margin-bottom: 1.5rem;">
                         <div class="section-content">
                             <label for="daily-log-date-selector" class="form-label">対象日:</label>
                             <input type="date" id="daily-log-date-selector" class="form-control" value="2025-10-15">
                         </div>
                    </div>

                    <div class="section">
                        <h2 class="section-title">利用状況</h2>

                        <form class="section-content filter-form-inline" style="margin-bottom: 1.5rem;">
                            <div class="form-group" style="flex-grow: 2;">
                                <label for="search-log-member-name" class="form-label">利用者名</label>
                                <input type="text" id="search-log-member-name" class="form-control" placeholder="氏名で検索...">
                            </div>
                            <div class="form-group">
                                <label for="filter-log-status" class="form-label">利用実績</label>
                                <select id="filter-log-status" class="form-control">
                                    <option value="">すべて</option>
                                    <option value="利用">利用</option>
                                    <option value="欠席">欠席</option>
                                    <option value="お休み">お休み</option>
                                </select>
                            </div>
                            <button type="button" class="button button-secondary">クリア</button>
                        </form>

                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>利用者名</th>
                                        <th>利用実績</th>
                                        <th>利用時間</th>
                                        <th>昼食</th>
                                        <th>送迎</th>
                                        <th>作業メモ</th>
                                        <th>支援メモ</th>
                                    </tr>
                                </thead>
                                <tbody id="daily-records-tbody">
                                    <tr class="clickable-row"
                                        data-member-name="青木 誠" data-status="利用" data-status-detail="通所"
                                        data-start-time="09:30" data-end-time="15:30" data-lunch="yes" data-pickup="roundtrip"
                                        data-absence-reason="" data-greeting="yes" data-cleaning="no"
                                        data-work-memo="データ入力作業 (A案件) を実施。" data-support-memo="集中して取り組めていた。15時にやや疲れが見られたため声掛け。">
                                        <td>青木 誠</td>
                                        <td>利用 (通所)</td>
                                        <td>09:30-15:30</td>
                                        <td>要</td>
                                        <td>往復</td>
                                        <td style="text-align: left; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="データ入力作業 (A案件) を実施。">データ入力作業...</td>
                                        <td style="text-align: left; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="集中して取り組めていた。15時にやや疲れが見られたため声掛け。">集中して取り組めて...</td>
                                    </tr>
                                    <tr class="clickable-row"
                                        data-member-name="五十嵐 直人" data-status="利用" data-status-detail="通所"
                                        data-start-time="09:00" data-end-time="15:00" data-lunch="yes" data-pickup="none"
                                        data-absence-reason="" data-greeting="yes" data-cleaning="yes"
                                        data-work-memo="B社 部品組み立て" data-support-memo="">
                                        <td>五十嵐 直人</td>
                                        <td>利用 (通所)</td>
                                        <td>09:00-15:00</td>
                                        <td>要</td>
                                        <td>無</td>
                                        <td style="text-align: left;">B社 部品組み立て</td>
                                        <td style="text-align: left;"></td>
                                    </tr>
                                    <tr class="clickable-row"
                                        data-member-name="遠藤 雅彦" data-status="欠席" data-status-detail=""
                                        data-start-time="" data-end-time="" data-lunch="no" data-pickup="none"
                                        data-absence-reason="体調不良のため欠席（連絡あり）" data-greeting="no" data-cleaning="no"
                                        data-work-memo="" data-support-memo="自宅へ連絡、様子伺い。">
                                        <td>遠藤 雅彦</td>
                                        <td>欠席</td>
                                        <td>-</td>
                                        <td>不要</td>
                                        <td>無</td>
                                        <td style="text-align: left;"></td>
                                        <td style="text-align: left;" title="自宅へ連絡、様子伺い。">自宅へ連絡、様子伺い。</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="section">
                         <div class="section-header">
                             <h2 class="section-title-in-header">特記事項</h2>
                             <button class="button button-primary" onclick="openModal('edit-daily-notes-modal')">編集</button>
                         </div>
                        <div class="section-content">
                            <p id="daily-notes-display">- 青木様、新しい作業工程「検品」のトレーニングを開始。順調な滑り出し。<br>- 午後、株式会社Aの鈴木部長が来所。</p>
                        </div>
                    </div>

                    <div class="section-footer" style="display: flex; justify-content: space-between; align-items: center;">
                         <div>
                            <label for="log-author">記録者:</label>
                            <select id="log-author" class="form-control" style="width: auto; display: inline-block; padding: 0.5rem;">
                                <option>管理者 太郎</option>
                                <option selected>支援員 次郎</option>
                            </select>
                        </div>
                        <button class="button button-danger">日誌を記録</button>
                    </div>
                </div>

                <div id="tab-incident-reports" class="tab-content">
                    <div class="section">
                        <h2 class="section-title">ヒヤリハット・事故報告一覧</h2>
                        <form class="section-content filter-form-inline" style="margin-bottom: 1.5rem;">
                            <div class="form-group">
                                <label for="search-incident-date-start" class="form-label">発生日(始)</label>
                                <input type="date" id="search-incident-date-start" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="search-incident-date-end" class="form-label">発生日(終)</label>
                                <input type="date" id="search-incident-date-end" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="filter-incident-type" class="form-label">種別</label>
                                <select id="filter-incident-type" class="form-control">
                                    <option value="">すべて</option>
                                    <option value="ヒヤリハット">ヒヤリハット</option>
                                    <option value="事故報告">事故報告</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filter-incident-reporter" class="form-label">報告者</label>
                                <select id="filter-incident-reporter" class="form-control">
                                    <option value="">すべて</option>
                                    <option value="管理者 太郎">管理者 太郎</option>
                                    <option value="支援員 次郎">支援員 次郎</option>
                                </select>
                            </div>
                             <div class="form-group">
                                <label for="filter-incident-status" class="form-label">状況</label>
                                <select id="filter-incident-status" class="form-control">
                                    <option value="">すべて</option>
                                    <option value="確認済">確認済</option>
                                    <option value="対応完了">対応完了</option>
                                    <option value="未確認">未確認</option>
                                </select>
                            </div>
                            <button type="button" class="button button-secondary">クリア</button>
                        </form>

                        <div class="table-wrapper">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>発生日時</th>
                                        <th>種別</th>
                                        <th>報告者</th>
                                        <th>状況</th>
                                    </tr>
                                </thead>
                                <tbody id="incident-reports-tbody">
                                    <tr class="clickable-row"
                                        data-datetime="2025-10-14 11:00"
                                        data-type="ヒヤリハット"
                                        data-reporter="支援員 次郎"
                                        data-status="確認済">
                                        <td>2025/10/14 11:00</td>
                                        <td>ヒヤリハット</td>
                                        <td>支援員 次郎</td>
                                        <td>確認済</td>
                                    </tr>
                                    <tr class="clickable-row"
                                        data-datetime="2025-09-20 15:30"
                                        data-type="事故報告"
                                        data-reporter="管理者 太郎"
                                        data-status="対応完了">
                                        <td>2025/09/20 15:30</td>
                                        <td>事故報告</td>
                                        <td>管理者 太郎</td>
                                        <td>対応完了</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        </div>
                </div>

            </div>
        </main>
    </div>

    <div id="edit-daily-notes-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">特記事項 編集</h2>
                <span class="modal-close" onclick="closeModal('edit-daily-notes-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="daily-notes-textarea">内容</label>
                    <textarea id="daily-notes-textarea" class="form-control" rows="8"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="button button-secondary" onclick="closeModal('edit-daily-notes-modal')">キャンセル</button>
                <button type="button" class="button button-primary" id="save-daily-notes-button">保存</button>
            </div>
        </div>
    </div>

    <div id="service-record-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">利用記録 編集 (<span id="modal-record-date"></span> <span id="modal-record-member-name"></span>)</h2>
                <span class="modal-close" onclick="closeModal('service-record-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal-record-row-index">
                <div class="form-group">
                    <label for="modal-record-status">利用実績</label>
                    <select id="modal-record-status" class="form-control">
                        <option value="利用">利用</option>
                        <option value="欠席">欠席</option>
                        <option value="お休み">お休み</option>
                    </select>
                </div>

                <div id="modal-record-status-details">
                    <div class="form-group" id="modal-record-attendance-type-group" style="display: none;">
                        <label for="modal-record-attendance-type">利用種別</label>
                        <select id="modal-record-attendance-type" class="form-control">
                            <option value="通所">通所</option>
                            <option value="在宅">在宅</option>
                        </select>
                    </div>
                    <div class="form-group" id="modal-record-absence-reason-group" style="display: none;">
                        <label for="modal-record-absence-reason">欠席時対応欄</label>
                        <textarea id="modal-record-absence-reason" class="form-control" rows="2"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label>利用時間</label>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="time" id="modal-record-start-time" class="form-control">
                        <span>〜</span>
                        <input type="time" id="modal-record-end-time" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>控除項目</label>
                    <div style="display: flex; gap: 1rem;">
                         <label style="font-weight: normal;"><input type="checkbox" id="modal-record-lunch"> 昼食</label>
                         <label style="font-weight: normal;"><input type="checkbox" id="modal-record-pickup"> 送迎</label>
                    </div>
                </div>
                 <div class="form-group">
                    <label>加算項目</label>
                    <div style="display: flex; gap: 1rem;">
                         <label style="font-weight: normal;"><input type="checkbox" id="modal-record-greeting"> 挨拶</label>
                         <label style="font-weight: normal;"><input type="checkbox" id="modal-record-cleaning"> 掃除</label>
                    </div>
                </div>
                <div class="form-group">
                    <label for="modal-record-work-memo">作業内容メモ</label>
                    <textarea id="modal-record-work-memo" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="modal-record-support-memo">支援員メモ (内部用)</label>
                    <textarea id="modal-record-support-memo" class="form-control" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="button button-secondary" onclick="closeModal('service-record-modal')">キャンセル</button>
                <button type="button" class="button button-primary" id="save-service-record-button">保存</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>

    <script>
        function filterDailyRecords() {
            const nameInput = document.getElementById('search-log-member-name');
            const statusSelect = document.getElementById('filter-log-status');
            const tableBody = document.getElementById('daily-records-tbody');
            if (!nameInput || !statusSelect || !tableBody) return;
            const nameFilter = nameInput.value.toLowerCase();
            const statusFilter = statusSelect.value;
            const rows = tableBody.getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                const memberNameData = row.dataset.memberName?.toLowerCase() || '';
                const statusData = row.dataset.status || '';
                const nameMatch = memberNameData.includes(nameFilter);
                const statusMatch = statusFilter === "" || statusData === statusFilter;
                row.style.display = (nameMatch && statusMatch) ? '' : 'none';
            });
        }
        const dailyNotesDisplay = document.getElementById('daily-notes-display');
        const dailyNotesTextarea = document.getElementById('daily-notes-textarea');
        const saveDailyNotesButton = document.getElementById('save-daily-notes-button');
        const editNotesButton = document.querySelector('#tab-daily-logs .section-header .button-primary[onclick*="edit-daily-notes-modal"]');
        if (editNotesButton) {
             editNotesButton.onclick = () => {
                 if(dailyNotesDisplay && dailyNotesTextarea){
                     dailyNotesTextarea.value = dailyNotesDisplay.innerHTML.replace(/<br\s*[\/]?>/gi, '\n');
                 }
                 openModal('edit-daily-notes-modal');
             }
        }
        if (saveDailyNotesButton && dailyNotesDisplay && dailyNotesTextarea) {
            saveDailyNotesButton.addEventListener('click', () => {
                dailyNotesDisplay.innerHTML = dailyNotesTextarea.value.replace(/\n/g, '<br>');
                closeModal('edit-daily-notes-modal');
            });
        }

        function filterIncidents() {
             const dateStartInput = document.getElementById('search-incident-date-start');
            const dateEndInput = document.getElementById('search-incident-date-end');
            const typeSelect = document.getElementById('filter-incident-type');
            const reporterSelect = document.getElementById('filter-incident-reporter');
            const statusSelect = document.getElementById('filter-incident-status');
            const tableBody = document.getElementById('incident-reports-tbody');
            if (!dateStartInput || !dateEndInput || !typeSelect || !reporterSelect || !statusSelect || !tableBody) return;
            const dateStartFilter = dateStartInput.value;
            const dateEndFilter = dateEndInput.value;
            const typeFilter = typeSelect.value;
            const reporterFilter = reporterSelect.value;
            const statusFilter = statusSelect.value;
            const rows = tableBody.getElementsByTagName('tr');
            Array.from(rows).forEach(row => {
                const datetimeData = row.dataset.datetime || '';
                const dateData = datetimeData.split(' ')[0];
                const typeData = row.dataset.type || '';
                const reporterData = row.dataset.reporter || '';
                const statusData = row.dataset.status || '';
                const dateMatch = (!dateStartFilter || dateData >= dateStartFilter) && (!dateEndFilter || dateData <= dateEndFilter);
                const typeMatch = typeFilter === "" || typeData === typeFilter;
                const reporterMatch = reporterFilter === "" || reporterData === reporterFilter;
                const statusMatch = statusFilter === "" || statusData === statusFilter;
                row.style.display = (dateMatch && typeMatch && reporterMatch && statusMatch) ? '' : 'none';
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const subNavContainer = document.getElementById('records-subnav');
            const tabContents = document.querySelectorAll('.tab-content-wrapper .tab-content');
            const newReportButton = document.getElementById('new-incident-report-button');

            function toggleNewReportButtonVisibility(targetTabId) {
                if (newReportButton) {
                    newReportButton.style.display = (targetTabId === 'tab-incident-reports') ? 'inline-flex' : 'none';
                }
            }

            if (subNavContainer && tabContents.length > 0) {
                 subNavContainer.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.sub-nav-item');
                    if (!navItem || navItem.classList.contains('active')) { return; }
                    e.preventDefault();
                    const targetTabId = navItem.dataset.tab;
                    subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => { item.classList.remove('active'); });
                    navItem.classList.add('active');
                    tabContents.forEach(content => {
                        const isActive = content.id === targetTabId;
                        content.classList.toggle('active', isActive);
                        content.style.display = isActive ? 'block' : 'none';
                    });
                    toggleNewReportButtonVisibility(targetTabId);
                });

                 let initialTabId = window.location.hash ? window.location.hash.substring(1) : 'tab-daily-logs';
                 const initialNavItem = subNavContainer.querySelector(`.sub-nav-item[data-tab="${initialTabId}"]`);
                 const initialTabContent = document.getElementById(initialTabId);

                 if (!initialNavItem || !initialTabContent) {
                     initialTabId = 'tab-daily-logs';
                     const defaultNavItem = subNavContainer.querySelector('.sub-nav-item[data-tab="tab-daily-logs"]');
                     const defaultTabContent = document.getElementById('tab-daily-logs');
                     if (defaultNavItem && defaultTabContent) {
                         subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => { item.classList.remove('active'); });
                         tabContents.forEach(content => { content.classList.remove('active'); content.style.display = 'none'; });
                         defaultNavItem.classList.add('active');
                         defaultTabContent.classList.add('active');
                         defaultTabContent.style.display = 'block';
                     }
                 } else {
                     subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => { item.classList.remove('active'); });
                     tabContents.forEach(content => { content.classList.remove('active'); content.style.display = 'none'; });
                     initialNavItem.classList.add('active');
                     initialTabContent.classList.add('active');
                     initialTabContent.style.display = 'block';
                 }

                 toggleNewReportButtonVisibility(initialTabId);
            }

            if (typeof window.filterDailyRecords === 'function') {
                const nameInputListener = document.getElementById('search-log-member-name');
                const statusSelectListener = document.getElementById('filter-log-status');
                const clearButton = document.querySelector('#tab-daily-logs .filter-form-inline .button-secondary');
                if(nameInputListener) nameInputListener.addEventListener('input', filterDailyRecords);
                if(statusSelectListener) statusSelectListener.addEventListener('change', filterDailyRecords);
                if(clearButton) {
                    clearButton.addEventListener('click', () => {
                         const form = clearButton.closest('.filter-form-inline');
                         if (form) {
                             form.reset();
                             filterDailyRecords();
                         }
                    });
                }
                filterDailyRecords();
            }

            const dailyRecordsTbody = document.getElementById('daily-records-tbody');
            if (dailyRecordsTbody) {
                dailyRecordsTbody.addEventListener('click', (e) => {
                     const clickedRow = e.target.closest('tr.clickable-row');
                     if (clickedRow) {
                         const rowIndex = Array.from(dailyRecordsTbody.children).indexOf(clickedRow);
                         const memberName = clickedRow.dataset.memberName;
                         const logDate = document.getElementById('daily-log-date-selector')?.value || '';
                         document.getElementById('modal-record-date').textContent = logDate;
                         document.getElementById('modal-record-member-name').textContent = memberName || '';
                         document.getElementById('modal-record-status').value = clickedRow.dataset.status || '利用';
                         document.getElementById('modal-record-attendance-type').value = clickedRow.dataset.statusDetail || '通所';
                         document.getElementById('modal-record-absence-reason').value = clickedRow.dataset.absenceReason || '';
                         document.getElementById('modal-record-start-time').value = clickedRow.dataset.startTime || '';
                         document.getElementById('modal-record-end-time').value = clickedRow.dataset.endTime || '';
                         document.getElementById('modal-record-lunch').checked = clickedRow.dataset.lunch === 'yes';
                         document.getElementById('modal-record-pickup').checked = clickedRow.dataset.pickup === 'roundtrip'; // Simplified: assumes roundtrip means checked
                         document.getElementById('modal-record-greeting').checked = clickedRow.dataset.greeting === 'yes';
                         document.getElementById('modal-record-cleaning').checked = clickedRow.dataset.cleaning === 'yes';
                         document.getElementById('modal-record-work-memo').value = clickedRow.dataset.workMemo || '';
                         document.getElementById('modal-record-support-memo').value = clickedRow.dataset.supportMemo || '';
                         document.getElementById('modal-record-row-index').value = rowIndex;

                         handleStatusChange(); // Update visibility based on loaded data
                         openModal('service-record-modal');
                     }
                });
            }

             const statusSelectModal = document.getElementById('modal-record-status');
             const attendanceTypeGroup = document.getElementById('modal-record-attendance-type-group');
             const absenceReasonGroup = document.getElementById('modal-record-absence-reason-group');
             const startTimeInput = document.getElementById('modal-record-start-time');
             const endTimeInput = document.getElementById('modal-record-end-time');

             function handleStatusChange() {
                 const selectedStatus = statusSelectModal.value;
                 attendanceTypeGroup.style.display = selectedStatus === '利用' ? 'block' : 'none';
                 absenceReasonGroup.style.display = selectedStatus === '欠席' ? 'block' : 'none';

                 const timeInputsDisabled = selectedStatus !== '利用';
                 startTimeInput.disabled = timeInputsDisabled;
                 endTimeInput.disabled = timeInputsDisabled;
                 if (timeInputsDisabled) {
                     startTimeInput.value = '';
                     endTimeInput.value = '';
                 }
             }

             if(statusSelectModal) {
                 statusSelectModal.addEventListener('change', handleStatusChange);
             }


            const saveServiceRecordButton = document.getElementById('save-service-record-button');
            if(saveServiceRecordButton){
                 saveServiceRecordButton.addEventListener('click', () => {
                     const rowIndex = parseInt(document.getElementById('modal-record-row-index')?.value, 10);
                     const tableBody = document.getElementById('daily-records-tbody');
                     if(tableBody && !isNaN(rowIndex) && rowIndex >= 0 && rowIndex < tableBody.rows.length){
                         const targetRow = tableBody.rows[rowIndex];
                         const status = document.getElementById('modal-record-status')?.value || '';
                         const statusDetail = status === '利用' ? document.getElementById('modal-record-attendance-type')?.value : '';
                         const absenceReason = status === '欠席' ? document.getElementById('modal-record-absence-reason')?.value : '';
                         const startTime = status === '利用' ? document.getElementById('modal-record-start-time')?.value : '';
                         const endTime = status === '利用' ? document.getElementById('modal-record-end-time')?.value : '';
                         const lunch = document.getElementById('modal-record-lunch')?.checked ? 'yes' : 'no';
                         const pickupChecked = document.getElementById('modal-record-pickup')?.checked;
                         const pickup = pickupChecked ? 'roundtrip' : 'none'; // Simplified logic
                         const greeting = document.getElementById('modal-record-greeting')?.checked ? 'yes' : 'no';
                         const cleaning = document.getElementById('modal-record-cleaning')?.checked ? 'yes' : 'no';
                         const workMemo = document.getElementById('modal-record-work-memo')?.value || '';
                         const supportMemo = document.getElementById('modal-record-support-memo')?.value || '';

                         targetRow.dataset.status = status;
                         targetRow.dataset.statusDetail = statusDetail;
                         targetRow.dataset.absenceReason = absenceReason;
                         targetRow.dataset.startTime = startTime;
                         targetRow.dataset.endTime = endTime;
                         targetRow.dataset.lunch = lunch;
                         targetRow.dataset.pickup = pickup;
                         targetRow.dataset.greeting = greeting;
                         targetRow.dataset.cleaning = cleaning;
                         targetRow.dataset.workMemo = workMemo;
                         targetRow.dataset.supportMemo = supportMemo;

                         let statusDisplay = status;
                         if (status === '利用' && statusDetail) {
                             statusDisplay += ` (${statusDetail})`;
                         }
                         targetRow.cells[1].textContent = statusDisplay;
                         targetRow.cells[2].textContent = (startTime && endTime) ? `${startTime}-${endTime}` : '-';
                         targetRow.cells[3].textContent = (lunch === 'yes') ? '要' : '不要';
                         targetRow.cells[4].textContent = (pickup === 'roundtrip') ? '往復' : '無'; // Simplified

                         const workMemoCell = targetRow.cells[5];
                         workMemoCell.textContent = workMemo;
                         workMemoCell.title = workMemo;
                         if(workMemo.length > 20) workMemoCell.textContent = workMemo.substring(0, 18) + '...'; else workMemoCell.textContent = workMemo;

                         const supportMemoCell = targetRow.cells[6];
                         supportMemoCell.textContent = supportMemo;
                         supportMemoCell.title = supportMemo;
                         if(supportMemo.length > 20) supportMemoCell.textContent = supportMemo.substring(0, 18) + '...'; else supportMemoCell.textContent = supportMemo;

                         closeModal('service-record-modal');
                     } else {
                         console.error("Failed to find row to update or invalid row index.");
                     }
                 });
            }

            if (typeof window.filterIncidents === 'function') {
                const dateStartListener = document.getElementById('search-incident-date-start');
                const dateEndListener = document.getElementById('search-incident-date-end');
                const typeSelectListener = document.getElementById('filter-incident-type');
                const reporterSelectListener = document.getElementById('filter-incident-reporter');
                const statusSelectListener = document.getElementById('filter-incident-status');
                const clearButton = document.querySelector('#tab-incident-reports .filter-form-inline .button-secondary');
                if(dateStartListener) dateStartListener.addEventListener('change', filterIncidents);
                if(dateEndListener) dateEndListener.addEventListener('change', filterIncidents);
                if(typeSelectListener) typeSelectListener.addEventListener('change', filterIncidents);
                if(reporterSelectListener) reporterSelectListener.addEventListener('change', filterIncidents);
                if(statusSelectListener) statusSelectListener.addEventListener('change', filterIncidents);
                if(clearButton) {
                    clearButton.addEventListener('click', () => {
                         const form = document.querySelector('#tab-incident-reports .filter-form-inline');
                         if (form) form.reset();
                         filterIncidents();
                    });
                }
                filterIncidents();
            }

            const incidentTableBody = document.getElementById('incident-reports-tbody');
            if (incidentTableBody) {
                 incidentTableBody.addEventListener('click', (e) => {
                     const clickedRow = e.target.closest('tr.clickable-row');
                     if (clickedRow) {
                         const dateTime = clickedRow.dataset.datetime;
                         const type = clickedRow.dataset.type;
                         alert(`「${dateTime} ${type}」の詳細を表示します。（実装は別途）`);
                     }
                 });
            }
        });
    </script>
</body>
</html>