<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>工賃管理 (利用者別) - p2508d</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="mockup-container">
        <header class="header">
            <div><h1 class="header-logo"><a href="dashboard.html">p2508d</a></h1></div>
            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="dashboard.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="daily_records.html" class="nav-link">日々の記録</a></li>
                    <li><a href="members_menu.html" class="nav-link active">利用者支援</a></li> <li><a href="staff.html" class="nav-link">職員管理</a></li>
                    <li><a href="work_activities_menu.html" class="nav-link">生産活動</a></li>
                    <li><a href="accounting_menu.html" class="nav-link">会計管理</a></li>
                    <li><a href="claims.html" class="nav-link">国保連請求</a></li>
                    <li><a href="analytics.html" class="nav-link">データ分析</a></li>
                    <li><a href="settings.html" class="nav-link">設定</a></li>
                </ul>
                <div class="nav-logout-section"><a href="index.html" class="nav-link">ログアウト</a></div>
            </nav>
        </header>

        <main class="mockup-main">
            <div id="member-wages-list" class="mockup-page active">
                <div class="list-page-header">
                    <h1 class="page-title">工賃管理 (利用者別)</h1>
                     <div>
                        <a href="members_menu.html" class="button button-secondary" style="margin-right: 0.5rem;">利用者支援メニューへ</a>
                        <button class="button button-primary">工賃一括計算</button> </div>
                </div>

                 <div class="sub-nav">
                     <ul id="wage-member-subnav">
                         <li><a href="#" class="sub-nav-item active" data-tab="tab-wage-levels">工賃レベル設定</a></li>
                         </ul>
                 </div>
                 <div class="tab-content-wrapper">
                    <div id="tab-wage-levels" class="tab-content active">

                        <div class="section">
                            <div class="section-header">
                                <h2 class="section-title-in-header">検索条件</h2>
                                <button type="button" class="button button-secondary">クリア</button>
                            </div>
                            <form class="section-content filter-form">
                                <div class="form-group">
                                    <label for="search-wage-member-name" class="form-label">利用者名</label>
                                    <input type="text" id="search-wage-member-name" class="form-control" placeholder="氏名で検索...">
                                </div>
                                <div class="form-group">
                                    <label for="filter-wage-rank" class="form-label">工賃等級</label>
                                    <select id="filter-wage-rank" class="form-control">
                                        <option value="">すべて</option>
                                        <option value="rank-a">A等級 (時給 350円)</option>
                                        <option value="rank-b">B等級 (時給 300円)</option>
                                        <option value="rank-c">C等級 (時給 250円)</option>
                                        <option value="unset">未設定</option>
                                    </select>
                                </div>
                                </form>
                        </div>
                        <div class="table-wrapper" style="margin-top: 1.5rem;">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>利用者名</th>
                                        <th>適用工賃レベル</th>
                                        <th>評価メモ</th>
                                        <th>最終更新日</th>
                                        </tr>
                                </thead>
                                <tbody id="member-wage-list-tbody"> <tr class="clickable-row"
                                        data-member-name="青木 誠"
                                        data-wage-level="rank-a"
                                        data-memo="PCスキルが高く、特にデータ入力作業において正確かつ迅速なため、A等級を適用。"
                                        data-date="2025-10-15">
                                        <td>青木 誠</td>
                                        <td>A等級 (時給 350円)</td>
                                        <td style="text-align: left; max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">PCスキルが高く、特にデータ入力作業において正確かつ迅速なため...</td>
                                        <td>2025/10/15</td>
                                    </tr>
                                    <tr class="clickable-row"
                                        data-member-name="五十嵐 直人"
                                        data-wage-level="rank-b"
                                        data-memo="軽作業の習熟度が安定しているため。"
                                        data-date="2025-10-01">
                                        <td>五十嵐 直人</td>
                                        <td>B等級 (時給 300円)</td>
                                        <td style="text-align: left;">軽作業の習熟度が安定しているため。</td>
                                        <td>2025/10/01</td>
                                    </tr>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                 </div>
                 </div>
        </main>
    </div>

    <div id="edit-member-wage-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">工賃レベル設定</h2>
                <span class="modal-close" onclick="closeModal('edit-member-wage-modal')">&times;</span>
            </div>
             <div class="modal-body">
                 <p><strong>利用者:</strong> <span id="modal-edit-wage-member-name"></span></p> <div class="form-group">
                    <label for="modal-edit-member-wage-level" class="form-label">適用工賃レベル</label> <select id="modal-edit-member-wage-level" class="form-control"> <option value="unset">未設定</option> <option value="rank-a">A等級 (時給 350円)</option>
                        <option value="rank-b">B等級 (時給 300円)</option>
                        <option value="rank-c">C等級 (時給 250円)</option>
                    </select>
                </div>
                <div class="form-group">
                     <label for="modal-edit-wage-level-memo" class="form-label">評価メモ・適用理由</label> <textarea id="modal-edit-wage-level-memo" class="form-control" rows="4"></textarea> </div>
                 <div class="form-group">
                     <label class="form-label">最終更新日</label>
                     <input type="date" id="modal-view-wage-update-date" class="form-control" readonly style="background-color: var(--color-hover-bg);">
                 </div>
                 </div>
            <div class="modal-footer">
                 <button class="button button-secondary" onclick="closeModal('edit-member-wage-modal')">キャンセル</button>
                 <button class="button button-primary">保存</button>
            </div>
        </div>
    </div>
    <script src="script.js"></script>

    <script>
        // 工賃一覧の簡易フィルタリング関数
        function filterWages() {
            const nameInput = document.getElementById('search-wage-member-name');
            const rankSelect = document.getElementById('filter-wage-rank');
            const tableBody = document.getElementById('member-wage-list-tbody');

            if (!nameInput || !rankSelect || !tableBody) {
                // console.warn("Filter elements or table body for wages not found.");
                return;
            }

            const nameFilter = nameInput.value.toLowerCase();
            const rankFilter = rankSelect.value; // "rank-a", "rank-b", "unset" など
            const rows = tableBody.getElementsByTagName('tr');

            Array.from(rows).forEach(row => {
                const memberName = row.cells[0]?.textContent.toLowerCase() || '';
                // data属性から工賃レベルを取得して比較
                const wageLevelData = row.dataset.wageLevel || 'unset'; // データなければ"unset"扱い

                const nameMatch = memberName.includes(nameFilter);
                // rankFilterが空か、data属性と一致するか
                const rankMatch = rankFilter === "" || wageLevelData === rankFilter;

                if (nameMatch && rankMatch) {
                    row.style.display = ''; // 表示
                } else {
                    row.style.display = 'none'; // 非表示
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- サブナビゲーション（タブ）切り替え ---
            const subNavContainer = document.getElementById('wage-member-subnav');
            const tabContents = document.querySelectorAll('#member-wages-list .tab-content-wrapper .tab-content');

            if (subNavContainer && tabContents.length > 0) {
                subNavContainer.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.sub-nav-item');
                    if (!navItem || navItem.classList.contains('active')) { return; }
                    e.preventDefault();
                    const targetTabId = navItem.dataset.tab;
                    subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => { item.classList.remove('active'); });
                    navItem.classList.add('active');
                    tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === targetTabId);
                    });
                });
            }


            // --- 工賃一覧: フィルタリングのイベントリスナー設定 ---
            if (typeof window.filterWages === 'function') {
                const nameInputListener = document.getElementById('search-wage-member-name');
                const rankSelectListener = document.getElementById('filter-wage-rank');
                const clearButton = document.querySelector('#member-wages-list .section-header .button-secondary');

                if(nameInputListener) nameInputListener.addEventListener('input', filterWages);
                if(rankSelectListener) rankSelectListener.addEventListener('change', filterWages);

                if(clearButton) {
                    clearButton.addEventListener('click', () => {
                         const form = document.querySelector('#member-wages-list .filter-form');
                         if (form) form.reset();
                         filterWages();
                    });
                }
                filterWages(); // 初期表示
            }

            // --- 行クリックでモーダル表示 ---
            const tableBody = document.getElementById('member-wage-list-tbody');
            if (tableBody && typeof window.openModal === 'function') {
                tableBody.addEventListener('click', (e) => {
                    const clickedRow = e.target.closest('tr.clickable-row');
                    if (clickedRow) {
                        // モーダル内の要素を取得
                        const modalMemberName = document.getElementById('modal-edit-wage-member-name');
                        const modalLevelSelect = document.getElementById('modal-edit-member-wage-level');
                        const modalMemoTextarea = document.getElementById('modal-edit-wage-level-memo');
                        const modalDateInput = document.getElementById('modal-view-wage-update-date'); // Readonly date input

                        // data属性から値を取得
                        const memberName = clickedRow.dataset.memberName;
                        const level = clickedRow.dataset.wageLevel; // "rank-a", "rank-b"など
                        const memo = clickedRow.dataset.memo;
                        const date = clickedRow.dataset.date; // "YYYY-MM-DD"形式

                        // モーダルに値を設定
                        if (modalMemberName) modalMemberName.textContent = memberName || '';
                        if (modalLevelSelect) modalLevelSelect.value = level || 'unset'; // data属性の値をセット、なければ'unset'
                        if (modalMemoTextarea) modalMemoTextarea.value = memo || '';
                        if (modalDateInput) modalDateInput.value = date || ''; // 日付を設定

                        // モーダルを開く
                        window.openModal('edit-member-wage-modal');
                    }
                });
            }
        });
    </script>
    </body>
</html>