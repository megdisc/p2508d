<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>p2508d - 工賃体系設定</title>

    <link rel="stylesheet" href="../style.css">

    <style>
        /* --- Form Grid (style.cssにないため) --- */
        .detail-form { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.25rem; }
        .form-label { font-size: var(--font-size-sm); font-weight: 500; }
        .form-control { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid var(--color-border); border-radius: var(--border-radius); font-size: var(--font-size-sm); }
        .form-actions { display: flex; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--color-border); }

        /* --- テーブル内のフォーム要素 (案件管理画面のスタイルに合わせる) --- */
        .table .form-control {
            width: 100%;
            padding: 0.375rem 0.5rem; /* テーブル内は少し小さく */
            font-size: var(--font-size-sm);
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div class="mockup-container">
        <header class="header">
            <div>
                <h1 class="header-logo"><a href="../dashboard/index.html">p2508d</a></h1>
            </div>
            
            <nav class="nav" id="side-nav">
                <ul class="nav-list">
                    <li><a href="../dashboard/index.html" class="nav-link">ダッシュボード</a></li>
                    <li><a href="../records/index.html" class="nav-link">日々の記録</a></li>
                    <li><a href="../members/index.html" class="nav-link">利用者支援</a></li>
                    <li><a href="../staff/index.html" class="nav-link">職員管理</a></li>
                    <li><a href="../production/index.html" class="nav-link">生産活動</a></li>
                    <li><a href="../accounting/index.html" class="nav-link">会計管理</a></li>
                    <li><a href="../billing/index.html" class="nav-link">国保連請求</a></li>
                    <li><a href="../analytics/index.html" class="nav-link">データ分析</a></li>
                    <li><a href="../settings/index.html" class="nav-link active">設定</a></li>
                </ul>
                <div class="nav-logout-section">
                    <a href="../index.html" class="nav-link">ログアウト</a>
                </div>
            </nav>
            
        </header>

        <main class="mockup-main">
            
            <div id="wage-system-detail" class="mockup-page active"> 
                
                <div class="list-page-header">
                     <h1 class="page-title">工賃体系設定</h1>
                     <div>
                        <a href="../settings/index.html" class="button button-secondary">設定TOPへ戻る</a>
                     </div>
                </div>

                <form class="detail-form">

                    <div class="sub-nav">
                        <ul id="wage-system-subnav">
                            <li><a href="#" class="sub-nav-item active" data-tab="tab-wage-basic">基本工賃</a></li>
                            <li><a href="#" class="sub-nav-item" data-tab="tab-wage-attendance">精勤・皆勤手当</a></li>
                            <li><a href="#" class="sub-nav-item" data-tab="tab-wage-other-allowance">その他加算手当</a></li>
                            <li><a href="#" class="sub-nav-item" data-tab="tab-wage-deduction">控除</a></li>
                        </ul>
                    </div>
                    <div class="tab-content-wrapper">
                        
                        <div id="tab-wage-basic" class="tab-content active">
                            <div class="section">
                                <h2 class="section-title">基本設定</h2>
                                <div class="section-content form-grid" style="grid-template-columns: repeat(3, 1fr);">
                                    <div class="form-group">
                                        <label for="wage-base-type" class="form-label">基本工賃体系</label>
                                        <select id="wage-base-type" class="form-control">
                                            <option value="hourly" selected>時給制</option>
                                            <option value="daily">日給制</option>
                                            </select>
                                    </div>
                                    
                                    <div class="form-group" id="hourly-calc-unit-group">
                                        <label for="hourly-calc-unit" class="form-label">計算単位時間 (分)</label>
                                        <input type="number" id="hourly-calc-unit" class="form-control" value="60">
                                    </div>
                                    <div class="form-group" id="hourly-rounding-group">
                                        <label for="hourly-rounding" class="form-label">端数処理</label>
                                        <select id="hourly-rounding" class="form-control">
                                            <option value="round_down">1円未満切り捨て</option>
                                            <option value="round_up">1円未満繰り上げ</option>
                                            <option value="round_off">四捨五入</option>
                                        </select>
                                    </div>
                                    </div>
                            </div>
        
                            <div class="section">
                                <div class="list-page-header" style="margin-bottom: 1rem;">
                                    <h2 class="section-title" style="margin: 0; border: none;">等級別設定</h2>
                                    <button type="button" class="button button-primary" id="add-rank-row">＋ 等級を追加</button>
                                </div>
                                <div class="table-wrapper">
                                    <table class="table" id="rank-table">
                                        <thead>
                                            <tr>
                                                <th>等級名</th>
                                                <th style="width: 150px;" id="rank-amount-header">時給(円)</th> 
                                                <th class="col-actions">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="rank-table-body">
                                            <tr>
                                                <td><input type="text" class="form-control" value="A等級"></td>
                                                <td><input type="number" class="form-control" value="350"></td>
                                                <td class="col-actions">
                                                    <div class="table-button-group">
                                                        <button type="button" class="button button-danger">削除</button>
                                                    </div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td><input type="text" class="form-control" value="B等級"></td>
                                                <td><input type="number" class="form-control" value="300"></td>
                                                <td class="col-actions">
                                                    <div class="table-button-group">
                                                        <button type="button" class="button button-danger">削除</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div id="tab-wage-attendance" class="tab-content">
                            <div class="section">
                                <h2 class="section-title">精勤手当</h2>
                                <div class="section-content form-grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
                                    <div class="form-group">
                                        <label for="seikin-criteria" class="form-label">算出基準</label>
                                        <select id="seikin-criteria" class="form-control">
                                            <option value="none">設定しない</option>
                                            <option value="days_worked" selected>利用日数</option>
                                            <option value="days_absent">欠席日数</option>
                                            <option value="attendance_rate">利用率</option>
                                            <option value="absence_rate">欠席率</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="seikin-threshold" class="form-label">閾値（基準値）</label>
                                        <input type="number" id="seikin-threshold" class="form-control" value="20">
                                    </div>
                                    <div class="form-group">
                                        <label for="seikin-unit" class="form-label">単位</label>
                                        <select id="seikin-unit" class="form-control"></select>
                                    </div>
                                    <div class="form-group">
                                        <label for="seikin-amount" class="form-label">支給額（円）</label>
                                        <input type="number" id="seikin-amount" class="form-control" value="3000">
                                    </div>
                                </div>
                            </div>
                            <div class="section">
                                <h2 class="section-title">皆勤手当</h2>
                                <div class="section-content form-grid" style="grid-template-columns: 1fr 1fr;">
                                    <div class="form-group">
                                        <label for="kaikin-criteria" class="form-label">算出基準</label>
                                        <select id="kaikin-criteria" class="form-control">
                                            <option value="none">設定しない</option>
                                            <option value="days_absent_zero" selected>欠席日数ゼロ</option>
                                            <option value="attendance_rate_100">利用率100%</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="kaikin-amount" class="form-label">支給額（円）</label>
                                        <input type="number" id="kaikin-amount" class="form-control" value="5000">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tab-wage-other-allowance" class="tab-content">
                             <div class="section">
                                <div class="list-page-header" style="margin-bottom: 1rem;">
                                    <h2 class="section-title" style="margin: 0; border: none;">その他加算手当</h2>
                                    <button type="button" class="button button-primary" id="add-allowance-row">＋ 項目を追加</button>
                                </div>
            
                                <div class="table-wrapper">
                                    <table class="table" id="allowance-table">
                                        <thead>
                                            <tr>
                                                <th>項目名</th>
                                                <th style="width: 150px;">種別</th>
                                                <th style="width: 150px;">金額(円)</th>
                                                <th class="col-actions">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="allowance-table-body">
                                            <tr>
                                                <td><input type="text" class="form-control" value="送迎手当"></td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="monthly" selected>月割</option>
                                                        <option value="daily">日割</option>
                                                    </select>
                                                </td>
                                                <td><input type="number" class="form-control" value="3000"></td>
                                                <td class="col-actions">
                                                    <div class="table-button-group">
                                                        <button type="button" class="button button-danger">削除</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                             </div>


                        <div id="tab-wage-deduction" class="tab-content">
                            <div class="section">
                                <div class="list-page-header" style="margin-bottom: 1rem;">
                                    <h2 class="section-title" style="margin: 0; border: none;">控除項目</h2>
                                    <button type="button" class="button button-primary" id="add-deduction-row">＋ 項目を追加</button>
                                </div>
            
                                <div class="table-wrapper">
                                    <table class="table" id="deduction-table">
                                        <thead>
                                            <tr>
                                                <th>項目名</th>
                                                <th style="width: 150px;">種別</th>
                                                <th style="width: 150px;">金額(円)</th>
                                                <th class="col-actions">操作</th>
                                            </tr>
                                        </thead>
                                        <tbody id="deduction-table-body">
                                            <tr>
                                                <td><input type="text" class="form-control" value="昼食費"></td>
                                                <td>
                                                    <select class="form-control">
                                                        <option value="monthly" selected>月割</option>
                                                        <option value="daily">日割</option>
                                                    </select>
                                                </td>
                                                <td><input type="number" class="form-control" value="6000"></td>
                                                <td class="col-actions">
                                                    <div class="table-button-group">
                                                        <button type="button" class="button button-danger">削除</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                             </div>

                    </div>

                    <div class="form-actions">
                        <button type="submit" class="button button-primary">工賃体系を更新する</button>
                    </div>
                </form>

            </div>

        </main>
    </div>

    <template id="rank-row-template">
        <tr>
            <td><input type="text" class="form-control" placeholder="例: C等級"></td>
            <td><input type="number" class="form-control" placeholder="0"></td>
            <td class="col-actions">
                <div class="table-button-group">
                    <button type="button" class="button button-danger">削除</button>
                </div>
            </td>
        </tr>
    </template>
    <template id="allowance-row-template">
        <tr>
            <td><input type="text" class="form-control" placeholder="例: 資格手当"></td>
            <td>
                <select class="form-control">
                    <option value="monthly" selected>月割</option>
                    <option value="daily">日割</option>
                </select>
            </td>
            <td><input type="number" class="form-control" placeholder="0"></td>
            <td class="col-actions">
                <div class="table-button-group">
                    <button type="button" class="button button-danger">削除</button>
                </div>
            </td>
        </tr>
    </template>

    <template id="deduction-row-template">
        <tr>
            <td><input type="text" class="form-control" placeholder="例: 行事費"></td>
            <td>
                <select class="form-control">
                    <option value="monthly" selected>月割</option>
                    <option value="daily">日割</option>
                </select>
            </td>
            <td><input type="number" class="form-control" placeholder="0"></td>
            <td class="col-actions">
                <div class="table-button-group">
                    <button type="button" class="button button-danger">削除</button>
                </div>
            </td>
        </tr>
    </template>
    <script src="../script.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

             // --- サブナビゲーション（タブ）切り替え ---
            const subNavContainer = document.getElementById('wage-system-subnav');
            const tabContents = document.querySelectorAll('#wage-system-detail .tab-content-wrapper .tab-content'); 
            
            if (subNavContainer && tabContents.length > 0) {
                subNavContainer.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.sub-nav-item');
                    if (!navItem || navItem.classList.contains('active')) { return; }
                    e.preventDefault();
                    
                    const targetTabId = navItem.dataset.tab;
                    
                    subNavContainer.querySelectorAll('.sub-nav-item').forEach(item => { item.classList.remove('active'); });
                    navItem.classList.add('active');
                    
                    tabContents.forEach(content => {
                        content.classList.toggle('active', content.id === targetTabId);
                    });
                });
            }

            
            // --- 1. 精勤手当の「単位」プルダウン ---
            const seikinCriteria = document.getElementById('seikin-criteria');
            const seikinUnit = document.getElementById('seikin-unit');
            
            const unitOptions = {
                days: [
                    { value: 'gte', text: '日以上' },
                    { value: 'gt', text: '日を超える' },
                    { value: 'lte', text: '日以下' },
                    { value: 'lt', text: '日未満' }
                ],
                rate: [
                    { value: 'gte', text: '％以上' },
                    { value: 'gt', text: '％を超える' },
                    { value: 'lte', text: '％以下' },
                    { value: 'lt', text: '％未満' }
                ]
            };

            function updateSeikinUnitOptions() {
                // 要素が存在しない場合 return
                if (!seikinCriteria || !seikinUnit) return; 

                const selectedBasis = seikinCriteria.value;
                let optionsToUse = [];

                if (selectedBasis === 'days_worked' || selectedBasis === 'days_absent') {
                    optionsToUse = unitOptions.days;
                } else if (selectedBasis === 'attendance_rate' || selectedBasis === 'absence_rate') {
                    optionsToUse = unitOptions.rate;
                }

                seikinUnit.innerHTML = '';

                if (optionsToUse.length === 0) {
                    seikinUnit.disabled = true;
                    const defaultOption = document.createElement('option');
                    defaultOption.text = '---';
                    seikinUnit.add(defaultOption);
                } else {
                    seikinUnit.disabled = false;
                    optionsToUse.forEach(opt => {
                        const optionEl = document.createElement('option');
                        optionEl.value = opt.value;
                        optionEl.text = opt.text;
                        seikinUnit.add(optionEl);
                    });
                }
            }
            updateSeikinUnitOptions(); // 初期実行
            if(seikinCriteria) seikinCriteria.addEventListener('change', updateSeikinUnitOptions); // イベントリスナー設定


            // --- 2. テーブル行追加・削除の汎用ロジック ---
            function setupTableRowAdder(tbodyId, addButtonId, templateId) {
                const tbody = document.getElementById(tbodyId);
                const addButton = document.getElementById(addButtonId);
                const template = document.getElementById(templateId);

                if (!tbody || !addButton || !template) {
                    console.warn('Table adder elements not found for', tbodyId);
                    return;
                }

                // 行追加
                addButton.addEventListener('click', () => {
                    const clone = template.content.cloneNode(true);
                    tbody.appendChild(clone);
                });

                // 行削除 (イベント委任)
                tbody.addEventListener('click', (e) => {
                    const deleteButton = e.target.closest('td.col-actions .button-danger'); // セレクタをより具体的に
                    if (deleteButton && tbody.contains(deleteButton)) { // tbody内にあることを確認
                        deleteButton.closest('tr').remove();
                    }
                });
            }

            // その他加算手当の初期化
            setupTableRowAdder('allowance-table-body', 'add-allowance-row', 'allowance-row-template');
            
            // 控除の初期化
            setupTableRowAdder('deduction-table-body', 'add-deduction-row', 'deduction-row-template');

            // --- 3. 基本工賃タブの動的表示切り替え ---
            const wageBaseType = document.getElementById('wage-base-type');
            const hourlyCalcUnitGroup = document.getElementById('hourly-calc-unit-group');
            const hourlyRoundingGroup = document.getElementById('hourly-rounding-group');
            const rankAmountHeader = document.getElementById('rank-amount-header');

            function updateWageBaseView() {
                // 要素が存在しない場合 return
                if (!wageBaseType || !hourlyCalcUnitGroup || !hourlyRoundingGroup || !rankAmountHeader) return;

                const selectedType = wageBaseType.value;
                
                if (selectedType === 'hourly') {
                    hourlyCalcUnitGroup.style.display = 'flex'; // block -> flex (form-groupに合わせて)
                    hourlyRoundingGroup.style.display = 'flex'; // block -> flex
                    rankAmountHeader.textContent = '時給(円)';
                } else if (selectedType === 'daily') {
                    hourlyCalcUnitGroup.style.display = 'none';
                    hourlyRoundingGroup.style.display = 'none';
                    rankAmountHeader.textContent = '日給(円)';
                }
            }

            updateWageBaseView(); // 初期表示
            if(wageBaseType) wageBaseType.addEventListener('change', updateWageBaseView); // イベントリスナー設定

            // --- 4. 等級テーブルの行追加・削除 ---
            setupTableRowAdder('rank-table-body', 'add-rank-row', 'rank-row-template');
        });
    </script>
    </body>
</html>